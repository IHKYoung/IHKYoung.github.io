<!DOCTYPE html>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\[','\]']],
      }
    });
</script>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ä½¿ç”¨TensorRTå®ç°æ¨¡å‹åŠ é€Ÿ | AhaKnow</title>
<meta name="keywords" content="ç¼–ç¨‹æ—¥å¸¸">
<meta name="description" content="ç¬¬ä¸€æ­¥ï¼šå…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦ ä½¿ç”¨ONNXæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡† ç›®æ ‡ï¼š ä½¿ç”¨ONNX Runtimeæ¥æµ‹è¯•æœºå™¨å­¦ä¹ æ¨¡å‹çš„æ¨ç†æ—¶é—´åŸºå‡†ã€‚ æ­¥éª¤ï¼š å®‰è£…ON">
<meta name="author" content="CKYoung">
<link rel="canonical" href="http://ahaknow.com/posts/know/%E4%BD%BF%E7%94%A8tensorrt%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%9E%8B%E5%8A%A0%E9%80%9F/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://ahaknow.com/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://ahaknow.com/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://ahaknow.com/Q.gif">
<link rel="apple-touch-icon" href="http://ahaknow.com/Q.gif">
<link rel="mask-icon" href="http://ahaknow.com/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="ä½¿ç”¨TensorRTå®ç°æ¨¡å‹åŠ é€Ÿ" />
<meta property="og:description" content="ç¬¬ä¸€æ­¥ï¼šå…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦ ä½¿ç”¨ONNXæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡† ç›®æ ‡ï¼š ä½¿ç”¨ONNX Runtimeæ¥æµ‹è¯•æœºå™¨å­¦ä¹ æ¨¡å‹çš„æ¨ç†æ—¶é—´åŸºå‡†ã€‚ æ­¥éª¤ï¼š å®‰è£…ON" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ahaknow.com/posts/know/%E4%BD%BF%E7%94%A8tensorrt%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%9E%8B%E5%8A%A0%E9%80%9F/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-05T19:06:48+08:00" />
<meta property="article:modified_time" content="2023-09-05T19:06:48+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ä½¿ç”¨TensorRTå®ç°æ¨¡å‹åŠ é€Ÿ"/>
<meta name="twitter:description" content="ç¬¬ä¸€æ­¥ï¼šå…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦ ä½¿ç”¨ONNXæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡† ç›®æ ‡ï¼š ä½¿ç”¨ONNX Runtimeæ¥æµ‹è¯•æœºå™¨å­¦ä¹ æ¨¡å‹çš„æ¨ç†æ—¶é—´åŸºå‡†ã€‚ æ­¥éª¤ï¼š å®‰è£…ON"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šä¸“æ ",
      "item": "http://ahaknow.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸŒŸçŸ¥è¯†",
      "item": "http://ahaknow.com/posts/know/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "ä½¿ç”¨TensorRTå®ç°æ¨¡å‹åŠ é€Ÿ",
      "item": "http://ahaknow.com/posts/know/%E4%BD%BF%E7%94%A8tensorrt%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%9E%8B%E5%8A%A0%E9%80%9F/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ä½¿ç”¨TensorRTå®ç°æ¨¡å‹åŠ é€Ÿ",
  "name": "ä½¿ç”¨TensorRTå®ç°æ¨¡å‹åŠ é€Ÿ",
  "description": "ç¬¬ä¸€æ­¥ï¼šå…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦ ä½¿ç”¨ONNXæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡† ç›®æ ‡ï¼š ä½¿ç”¨ONNX Runtimeæ¥æµ‹è¯•æœºå™¨å­¦ä¹ æ¨¡å‹çš„æ¨ç†æ—¶é—´åŸºå‡†ã€‚ æ­¥éª¤ï¼š å®‰è£…ON",
  "keywords": [
    "ç¼–ç¨‹æ—¥å¸¸"
  ],
  "articleBody": "ç¬¬ä¸€æ­¥ï¼šå…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦ ä½¿ç”¨ONNXæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡† ç›®æ ‡ï¼š ä½¿ç”¨ONNX Runtimeæ¥æµ‹è¯•æœºå™¨å­¦ä¹ æ¨¡å‹çš„æ¨ç†æ—¶é—´åŸºå‡†ã€‚\næ­¥éª¤ï¼š\nå®‰è£…ONNXå’ŒONNX Runtimeï¼š è¿™ä¸¤ä¸ªPythonåº“æ˜¯æµ‹è¯•åŸºå‡†çš„å…³é”®å·¥å…·ã€‚ONNXæ˜¯ä¸€ä¸ªå¼€æ”¾çš„æ¨¡å‹è¡¨ç¤ºæ ‡å‡†ï¼Œå®ƒå…è®¸åœ¨ä¸åŒçš„æœºå™¨å­¦ä¹ æ¡†æ¶ä¹‹é—´ç§»åŠ¨æ¨¡å‹ã€‚ONNX Runtimeåˆ™æ˜¯ä¸€ä¸ªç”¨äºè¿è¡ŒONNXæ¨¡å‹çš„é«˜æ€§èƒ½æ¨ç†å¼•æ“ã€‚å¯ä»¥é€šè¿‡pipè¿›è¡Œå®‰è£…ï¼Œå‘½ä»¤ä¸ºpip install onnx onnxruntime-gpuã€‚è¿™é‡Œçš„onnxruntime-gpuç‰ˆæœ¬æ˜¯æ”¯æŒGPUçš„ONNX Runtimeã€‚\nåŠ è½½æ¨¡å‹ï¼š ä½¿ç”¨ONNX RuntimeåŠ è½½æ¨¡å‹ï¼Œå…·ä½“åšæ³•æ˜¯åˆ›å»ºä¸€ä¸ªonnxruntime.InferenceSessionçš„å®ä¾‹ï¼Œå¹¶æŒ‡å®šæ¨¡å‹çš„æ–‡ä»¶è·¯å¾„å’Œæ¨ç†å¼•æ“æä¾›å•†ï¼ˆè¿™é‡Œé€‰æ‹©çš„æ˜¯'CUDAExecutionProvider'ï¼Œå³ä½¿ç”¨CUDAæ¥åˆ©ç”¨GPUåŠ é€Ÿï¼‰ã€‚\nè·å–è¾“å…¥ä¿¡æ¯å¹¶åˆ›å»ºè¾“å…¥æ•°æ®ï¼š éœ€è¦çŸ¥é“æ¨¡å‹çš„è¾“å…¥èŠ‚ç‚¹çš„åç§°å’Œå½¢çŠ¶ï¼Œè¿™å¯ä»¥é€šè¿‡session.get_inputs()æ¥è·å–ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯åï¼Œå°±å¯ä»¥åˆ›å»ºä¸ä¹‹åŒ¹é…çš„éšæœºè¾“å…¥æ•°æ®ã€‚\næ¨ç†å¹¶è®¡æ—¶ï¼š è¿›è¡Œ100æ¬¡æ¨¡å‹æ¨ç†ï¼Œå¹¶ä½¿ç”¨time.time()æ¥è®¡æ—¶ã€‚æ³¨æ„ï¼Œè¿™é‡Œå¿½ç•¥äº†ç¬¬ä¸€æ¬¡æ¨ç†çš„æ—¶é—´ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æ¨ç†å¯èƒ½ä¼šåŒ…å«ä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¯¼è‡´è€—æ—¶åå¤§ã€‚\nè®¡ç®—å¹³å‡æ¨ç†æ—¶é—´ï¼š é€šè¿‡å°†æ‰€æœ‰æ¨ç†çš„æ—¶é—´åŠ èµ·æ¥ï¼Œç„¶åé™¤ä»¥æ¨ç†æ¬¡æ•°ï¼Œå°±å¾—åˆ°äº†å¹³å‡æ¨ç†æ—¶é—´ã€‚\né—®é¢˜å’Œè§£å†³ï¼š\nå¦‚ä½•åˆ›å»ºåŒ¹é…æ¨¡å‹è¾“å…¥çš„æ•°æ®ï¼š æ¨¡å‹çš„è¾“å…¥å¯èƒ½æœ‰å¤šä¸ªï¼Œä¹Ÿå¯èƒ½æœ‰å„ç§å„æ ·çš„å½¢çŠ¶å’Œç±»å‹ã€‚éœ€è¦é€šè¿‡session.get_inputs()è·å–è¿™äº›ä¿¡æ¯ï¼Œç„¶åæ ¹æ®è¿™äº›ä¿¡æ¯åˆ›å»ºç›¸åº”çš„è¾“å…¥æ•°æ®ã€‚\nå¦‚ä½•ç¡®ä¿ä½¿ç”¨äº†GPUï¼š éœ€è¦åœ¨åˆ›å»ºonnxruntime.InferenceSessionæ—¶æ˜ç¡®æŒ‡å®šä½¿ç”¨'CUDAExecutionProvider'ã€‚å¦‚æœæ²¡æœ‰æ­£ç¡®åœ°ä½¿ç”¨GPUï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¨ç†é€Ÿåº¦å¤§å¹…åº¦é™ä½ã€‚\nå¦‚ä½•å‡†ç¡®è®¡æ—¶ï¼š é€‰æ‹©å¿½ç•¥äº†ç¬¬ä¸€æ¬¡æ¨ç†çš„æ—¶é—´ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æ¨ç†å¯èƒ½ä¼šåŒ…å«ä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¯¼è‡´è€—æ—¶åå¤§ã€‚\nPythonè„šæœ¬ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 import numpy as np import onnxruntime import time # åŠ è½½æ¨¡å‹ model_path = \"/home/metoak/Projects/ros_project/src/metoak_camera_driver/models/model_640_384_6125.onnx\" # session = onnxruntime.InferenceSession(model_path) session = onnxruntime.InferenceSession(model_path, providers=['CUDAExecutionProvider']) # è·å–è¾“å…¥åç§°å’Œå½¢çŠ¶ input_names = [inp.name for inp in session.get_inputs()] input_shapes = [inp.shape for inp in session.get_inputs()] print(\"Input names:\", input_names) print(\"Input shapes:\", input_shapes) # åˆ›å»ºä¸¤ä¸ªéšæœºè¾“å…¥ input1 = np.random.randint(0, 256, size=input_shapes[0]).astype(np.uint8) input2 = np.random.randint(0, 256, size=input_shapes[1]).astype(np.uint8) # å‡†å¤‡è¾“å…¥æ•°æ® inputs = {input_names[0]: input1, input_names[1]: input2} # æ¨ç†æ¬¡æ•° num_inferences = 100 times = [] # æ‰§è¡Œæ¨æ–­å¹¶è®¡æ—¶ for i in range(num_inferences): start = time.time() output = session.run(None, inputs) end = time.time() inference_time = end - start if i == 0: continue times.append(inference_time) print(f\"Inference {i+1}, Time: {inference_time * 1000} ms\") # è®¡ç®—å¹³å‡æ¨æ–­æ—¶é—´ avg_time = sum(times) / (num_inferences - 1) # æ‰“å°å¹³å‡æ¨æ–­æ—¶é—´ print(f\"Average inference time: {avg_time * 1000} ms\") æ¨¡å‹é€Ÿåº¦åŸºå‡† 1 2 3 4 5 6 7 8 9 10 Model name: model_640_384_6125.onnx Input names: ['onnx::Cast_0', 'onnx::Cast_1'] Input shapes: [[1, 3, 384, 640], [1, 3, 384, 640]] Inference 2, Time: 299.41678047180176 ms Inference 3, Time: 306.2708377838135 ms ... Inference 98, Time: 332.33070373535156 ms Inference 99, Time: 317.1732425689697 ms Inference 100, Time: 333.3919048309326 ms Average inference time: 322.4095816564078 ms ç¬¬äºŒæ­¥ï¼šä½¿ç”¨TensorRTå®ç°åŠ é€Ÿ å¦‚æœä½¿ç”¨çš„3080Tiæ˜¾å¡\næµ®ç‚¹è®¡ç®—èƒ½åŠ›ï¼š\nSingle Precision Perf.: ==34.1 TFLOPS==\nTensor Perf. (FP16): ==136 TFLOPS==\nTensor Perf. (FP16-Sparse): ==273 TFLOPS==\nå¦‚æœä½¿ç”¨Tensoræ¥å¤„ç†å…¨éƒ¨ç²¾åº¦ä¸º16ä½æµ®ç‚¹æ•°çš„ç®—æ³•ï¼Œé‚£ä¹ˆç†è®ºçš„è¿ç®—é€Ÿç‡å¯ä»¥è¾¾åˆ°è‡³å°‘æ˜¯å•ç²¾åº¦æµ®ç‚¹è¿ç®—çš„ 136 / 34.1 = 3.99ï¼Œä¹Ÿå°±æ˜¯4å€é€Ÿåº¦çš„æå‡ï¼Œè€Œå¦‚æœæ¨¡å‹æœ¬èº«å°±æ˜¯æ··åˆè¿›åº¦è¿›è¡Œè¿ç®—çš„ï¼Œé‚£ä¹ˆæå‡çš„æ•ˆæœä¼šæ›´å¤§ï¼ï¼ˆå¦‚æœå†è€ƒè™‘ä¸Šç¨€ç–ä¼˜åŒ–ï¼Œé‚£ä¹ˆTensoråŠ é€Ÿçš„å€æ•°ä¼šæ›´é«˜ï¼Œè¾¾åˆ° 273 / 34.1 = 8å€çš„æå‡ï¼‰\nğŸŒŸTensorRTç¯å¢ƒéƒ¨ç½² å®‰è£…æ–¹æ³•å¯¹äº†ï¼Œå®‰è£…å…¶å®å¾ˆç®€å•ï¼Œä¸€å¥è¯è¯´æ˜å°±æ˜¯ï¼š\n==cudaã€tensorrtéƒ½ä½¿ç”¨depåŒ…ï¼Œç„¶åä½¿ç”¨aptå®‰è£…==\nä½†æ˜¯ç»†èŠ‚å¾ˆå…³é”®ï¼ä¸‹é¢çš„è¿‡ç¨‹æ¶‰åŠå®‰è£…CUDAã€cuDNNã€TensorRT\nå®˜æ–¹æ–‡æ¡£\n1. å®‰è£…CUDA CUDAå’ŒNvida Driverè¿™ä¿©ä¸ªæ˜¯ç‹¬ç«‹ä¸å½±å“çš„ï¼Œæ‰€ä»¥å•ç‹¬å®‰è£…CUDAç‰ˆæœ¬å³å¯ï¼Œä¸Nvida Driverç‰ˆæœ¬æ— å…³ï¼Œæ¯”å¦‚å®‰è£…==cuda 11.8==\nUbuntu20.04:\n1 2 3 4 5 6 7 wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600 wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda-repo-ubuntu2004-11-8-local_11.8.0-520.61.05-1_amd64.deb sudo dpkg -i cuda-repo-ubuntu2004-11-8-local_11.8.0-520.61.05-1_amd64.deb sudo cp /var/cuda-repo-ubuntu2004-11-8-local/cuda-*-keyring.gpg /usr/share/keyrings/ sudo apt-get update sudo apt-get -y install cuda å¦‚æœä½¿ç”¨äº†runfileçš„æ–¹å¼å®‰è£…è¿‡cudaäº†ï¼Œé‚£ä¹ˆæœ€åä¸€æ­¥åªéœ€è¦ï¼š\n1 sudo apt install cuda-libraries-11-8 2. å®‰è£…cuDNN éœ€è¦æ³¨å†ŒNvidiaå¼€å‘è€…è´¦å·ï¼Œä¸‹è½½å¯¹åº”çš„CUDAç‰ˆæœ¬çš„å³å¯ï¼Œä½¿ç”¨å¦‚ä¸‹æ–¹å¼å®‰è£…ï¼š\nå®˜ç½‘\nä¸‹è½½debç‰ˆæœ¬å³å¯\n1 2 3 4 sudo dpkg -i cudnn-local-repo-ubuntu2004-8.9.2.26_1.0-1_amd64.deb sudo cp /var/cudnn-local-repo-ubuntu2004-8.9.2.26/cudnn-local-6D0A7AE1-keyring.gpg /usr/share/keyrings/ sudo apt update sudo apt-get install libcudnn8 3. å®‰è£…TensorRT å®˜ç½‘\nä¸‹è½½æœ€æ–°ç‰ˆæœ¬TensorRT 8ï¼ŒåŒæ ·éœ€è¦å¼€å‘è€…è´¦å·ï¼›\nä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å¯¹åº”CUDAçš„æœ€æ–°ç‰ˆå³å¯\n1 2 3 4 sudo dpkg -i nv-tensorrt-local-repo-ubuntu2004-8.6.1-cuda-11.8_1.0-1_amd64.deb sudo cp /var/nv-tensorrt-local-repo-ubuntu2004-8.6.1-cuda-11.8_1.0-1/*-keyring.gpg /usr/share/keyrings/ wozate sudo apt install tensorrt ä½¿ç”¨trtexecå·¥å…·å®ç°æ¨¡å‹è½¬æ¢ 1 2 # ä½¿ç”¨ä¾‹å­ trtexec --onnx=/home/metoak/Projects/ros_project/src/metoak_camera_driver/models/model_sim_1280_704.onnx --saveEngine=model_1280_704_fp16.engine --fp16 --avgRuns=100 å¯ä»¥ä½¿ç”¨trtexecè¿™ä¸ªå·¥å…·æ¥ç›´æ¥è½¬æ¢onnxæ¨¡å‹ï¼Œä½†å®é™…å¯èƒ½ä¸ç†æƒ³æˆ–è€…é‡åˆ°ä¸€äº›é—®é¢˜ï¼š\nonnx2trt_utils.cpp:374: Your ONNX model has been generated with INT64 weights, while TensorRT does not natively support INT64. Attempting to cast down to INT32. [07/25/2023-10:29:30] [W] [TRT] onnx2trt_utils.cpp:400: One or more weights outside the range of INT32 was clamped [07/25/2023-10:29:30] [I] Finished parsing network model. Parse time: 1.3651 [07/25/2023-10:29:30] [I] [TRT] Graph optimization time: 0.282094 seconds. [07/25/2023-10:29:30] [I] [TRT] [MemUsageChange] Init cuBLAS/cuBLASLt: CPU +0, GPU +10, now: CPU 2630, GPU 3661 (MiB) [07/25/2023-10:29:30] [I] [TRT] [MemUsageChange] Init cuDNN: CPU +0, GPU +10, now: CPU 2630, GPU 3671 (MiB) [07/25/2023-10:29:30] [I] [TRT] Local timing cache in use. Profiling results in this builder pass will not be stored.\nYour ONNX model has been generated with INT64 weights, while TensorRT does not natively support INT64. Attempting to cast down to INT32.: è¿™ä¸ªè­¦å‘Šè¡¨æ˜ä½ çš„ONNXæ¨¡å‹ä¸­åŒ…å«äº†INT64ç±»å‹çš„æƒé‡ï¼Œè€ŒTensorRTåŸç”Ÿä¸æ”¯æŒINT64ç±»å‹ã€‚TensorRTæ­£åœ¨å°è¯•å°†è¿™äº›æƒé‡è½¬æ¢ï¼ˆcastï¼‰ä¸ºINT32ç±»å‹ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ç²¾åº¦æŸå¤±ï¼Œå› ä¸ºINT32çš„èŒƒå›´å°äºINT64ã€‚\nOne or more weights outside the range of INT32 was clamped: è¿™ä¸ªè­¦å‘Šè¡¨æ˜åœ¨è½¬æ¢æƒé‡ç±»å‹çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæƒé‡çš„å€¼è¶…å‡ºäº†INT32ç±»å‹çš„èŒƒå›´ï¼Œå¹¶è¢«å‹ç¼©ï¼ˆclampï¼‰åˆ°äº†INT32çš„èŒƒå›´å†…ã€‚è¿™ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ç²¾åº¦æŸå¤±ã€‚\nFinished parsing network model. Parse time: 1.3651: è¿™è¡¨ç¤ºTensorRTå·²ç»å®Œæˆäº†å¯¹ONNXæ¨¡å‹çš„è§£æï¼Œæ•´ä¸ªè§£æè¿‡ç¨‹èŠ±è´¹äº†1.3651ç§’ã€‚\nGraph optimization time: 0.282094 seconds: è¿™è¡¨ç¤ºTensorRTå¯¹æ¨¡å‹è¿›è¡Œä¼˜åŒ–çš„æ—¶é—´æ˜¯0.282094ç§’ã€‚\nInit cuBLAS/cuBLASLt: CPU +0, GPU +10, now: CPU 2630, GPU 3661 (MiB) å’Œ Init cuDNN: CPU +0, GPU +10, now: CPU 2630, GPU 3671 (MiB): è¿™äº›è¡Œæ˜¯å…³äºTensorRTåˆå§‹åŒ–cuBLASå’ŒcuDNNåº“ï¼ˆè¿™äº›åº“ç”¨äºGPUåŠ é€Ÿçš„çº¿æ€§ä»£æ•°è¿ç®—å’Œæ·±åº¦ç¥ç»ç½‘ç»œè®¡ç®—ï¼‰æ‰€éœ€å†…å­˜çš„ä¿¡æ¯ã€‚è¿™äº›è¡Œæ˜¾ç¤ºäº†åœ¨åˆå§‹åŒ–è¿™äº›åº“åï¼ŒCPUå’ŒGPUå†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚\nLocal timing cache in use. Profiling results in this builder pass will not be stored.: è¿™è¡¨ç¤ºTensorRTæ­£åœ¨ä½¿ç”¨æœ¬åœ°çš„è®¡æ—¶ç¼“å­˜è¿›è¡Œæ“ä½œï¼Œè€Œè¿™æ¬¡çš„åˆ†æç»“æœä¸ä¼šè¢«å­˜å‚¨ã€‚\nä½¿ç”¨trtexecæ¥è½¬æ¢æ¨¡å‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¾—åˆ°ä¸‹é¢çš„è¾“å‡ºæ—¶ï¼Œä¼šæˆåŠŸï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å¾—åˆ°æ¨¡å‹æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 [07/25/2023-14:44:13] [I] Starting inference [07/25/2023-14:44:16] [I] Warmup completed 12 queries over 200 ms [07/25/2023-14:44:16] [I] Timing trace has 180 queries over 3.05014 s [07/25/2023-14:44:16] [I] [07/25/2023-14:44:16] [I] === Trace details === [07/25/2023-14:44:16] [I] Trace averages of 100 runs: [07/25/2023-14:44:16] [I] Average on 100 runs - GPU latency: 16.9045 ms - Host latency: 17.8527 ms (enqueue 11.5822 ms) [07/25/2023-14:44:16] [I] [07/25/2023-14:44:16] [I] === Performance summary === [07/25/2023-14:44:16] [I] Throughput: 59.0137 qps [07/25/2023-14:44:16] [I] Latency: min = 14.8851 ms, max = 27.6843 ms, mean = 17.7984 ms, median = 16.9878 ms, percentile(90%) = 21.1488 ms, percentile(95%) = 23.4043 ms, percentile(99%) = 27.5272 ms [07/25/2023-14:44:16] [I] Enqueue Time: min = 3.59753 ms, max = 22.9529 ms, mean = 11.5029 ms, median = 10.7087 ms, percentile(90%) = 13.9353 ms, percentile(95%) = 16.418 ms, percentile(99%) = 20.6213 ms [07/25/2023-14:44:16] [I] H2D Latency: min = 0.0994873 ms, max = 0.790527 ms, mean = 0.303106 ms, median = 0.268311 ms, percentile(90%) = 0.458588 ms, percentile(95%) = 0.503906 ms, percentile(99%) = 0.564697 ms [07/25/2023-14:44:16] [I] GPU Compute Time: min = 14.0032 ms, max = 26.499 ms, mean = 16.8485 ms, median = 16.0006 ms, percentile(90%) = 19.6926 ms, percentile(95%) = 22.436 ms, percentile(99%) = 26.4436 ms [07/25/2023-14:44:16] [I] D2H Latency: min = 0.319824 ms, max = 1.09839 ms, mean = 0.646768 ms, median = 0.621216 ms, percentile(90%) = 0.887512 ms, percentile(95%) = 0.963013 ms, percentile(99%) = 1.05774 ms [07/25/2023-14:44:16] [I] Total Host Walltime: 3.05014 s [07/25/2023-14:44:16] [I] Total GPU Compute Time: 3.03273 s [07/25/2023-14:44:16] [W] * GPU compute time is unstable, with coefficient of variance = 15.1765%. [07/25/2023-14:44:16] [W] If not already in use, locking GPU clock frequency or adding --useSpinWait may improve the stability. [07/25/2023-14:44:16] [I] Explanations of the performance metrics are printed in the verbose logs. [07/25/2023-14:44:16] [I] \u0026\u0026\u0026\u0026 PASSED TensorRT.trtexec [TensorRT v8601] # /usr/src/tensorrt/bin/trtexec --onnx=/home/metoak/Projects/ros_project/src/metoak_camera_driver/models/model_640_384_6125.onnx --saveEngine=model_640_384.engine --fp16 --avgRuns=100 è¿™æ˜¯é€šè¿‡ä½¿ç”¨TensorRTå·¥å…·trtexecçš„ä¸€æ®µæµ‹è¯•è¾“å‡ºï¼Œä¸‹é¢æ˜¯æ¯ä¸ªé‡è¦éƒ¨åˆ†çš„è§£é‡Šï¼š\n[I] Warmup completed 12 queries over 200 msï¼šåœ¨å¼€å§‹æ­£å¼è®¡æ—¶ä¹‹å‰ï¼Œtrtexecé¦–å…ˆæ‰§è¡Œäº†12ä¸ªé¢„çƒ­æŸ¥è¯¢ï¼Œæ€»è€—æ—¶200æ¯«ç§’ã€‚\n[I] Timing trace has 180 queries over 3.05014 sï¼šè¿™è¡¨ç¤ºè¿è¡Œäº†180æ¬¡æ¨æ–­ï¼Œæ€»è€—æ—¶çº¦ä¸º3.05ç§’ã€‚\n[I] Average on 100 runs - GPU latency: 16.9045 ms - Host latency: 17.8527 msï¼šè¿™è¡¨ç¤ºåœ¨100æ¬¡è¿è¡Œä¸­ï¼Œå¹³å‡æ¯æ¬¡æ¨æ–­åœ¨GPUä¸Šçš„å»¶è¿Ÿæ˜¯16.9045æ¯«ç§’ï¼Œåœ¨ä¸»æœºä¸Šçš„å»¶è¿Ÿæ˜¯17.8527æ¯«ç§’ã€‚\n[I] Throughput: 59.0137 qpsï¼šè¿™è¡¨ç¤ºæ¨¡å‹çš„ååé‡ä¸º59.0137æŸ¥è¯¢æ¯ç§’ï¼ˆqpsï¼‰ã€‚\n[I] Latency: min = 14.8851 ms, max = 27.6843 ms, mean = 17.7984 ms, median = 16.9878 msï¼šè¿™æ˜¯å¯¹å»¶è¿Ÿçš„ä¸€äº›ç»Ÿè®¡æè¿°ï¼ŒåŒ…æ‹¬æœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼å’Œä¸­ä½æ•°ã€‚\n[W] * GPU compute time is unstable, with coefficient of variance = 15.1765%.ï¼šè¿™æ˜¯ä¸€ä¸ªè­¦å‘Šï¼Œè¡¨ç¤ºGPUè®¡ç®—æ—¶é—´çš„å˜åŒ–æ˜¯ä¸ç¨³å®šçš„ï¼Œæ–¹å·®ç³»æ•°ä¸º15.1765%ï¼Œå¯èƒ½éœ€è¦é€šè¿‡é”å®šGPUæ—¶é’Ÿé¢‘ç‡æˆ–ä½¿ç”¨--useSpinWaité€‰é¡¹æ¥æ”¹å–„è¿™ç§æƒ…å†µã€‚\n\u0026\u0026\u0026\u0026 PASSED TensorRT.trtexec [TensorRT v8601] # /usr/src/tensorrt/bin/trtexec --onnx=/home/metoak/Projects/ros_project/src/metoak_camera_driver/models/model_640_384_6125.onnx --saveEngine=model_640_384.engine --fp16 --avgRuns=100ï¼šè¿™è¡¨ç¤ºtrtexecæµ‹è¯•é€šè¿‡äº†ï¼Œå¹¶ä¸”æ˜¾ç¤ºäº†ä½ ç”¨æ¥è¿è¡Œtrtexecçš„å‘½ä»¤è¡Œå‚æ•°ã€‚\néªŒè¯engineæ¨¡å‹æ˜¯å¦å¯ç”¨ï¼Ÿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import tensorrt as trt TRT_LOGGER = trt.Logger(trt.Logger.WARNING) trt_runtime = trt.Runtime(TRT_LOGGER) engine_path = \"/home/metoak/Projects/models/model_resnet101.engine\" with open(engine_path, \"rb\") as f: engine_data = f.read() engine = trt_runtime.deserialize_cuda_engine(engine_data) print(\"Number of bindings: \", engine.num_bindings) for i in range(engine.num_bindings): binding_name = engine.get_tensor_name(i) print(\"Binding \", i, \":\", \"Binding name: \", binding_name, \"Binding shape: \", engine.get_tensor_shape(binding_name), \"Binding data type: \", engine.get_tensor_dtype(binding_name), \"Is binding an input? \", engine.get_tensor_mode(binding_name) == trt.TensorIOMode.INPUT) print(\"Number of layers: \", engine.num_layers) å¦‚æœæ‰€æœ‰çš„æ‰“å°è¾“å‡ºéƒ½æ­£å¸¸ï¼Œé‚£ä¹ˆè¯´æ˜è½¬æ¢çš„æ¨¡å‹å¯ä»¥ï¼Œ==å¹¶ä¸”ä»¥æ­£å¸¸æ–¹æ³•è¿›è¡Œæ¨ç†ä¹Ÿæ˜¯å¯è¡Œçš„==\nä¹‹åå°±æ˜¯å°†æ¨¡å‹æ¨ç†éƒ¨åˆ†æ•´åˆè¿›å…¥é¡¹ç›®ä»£ç å³å¯ã€‚\nç¬¬ä¸‰æ­¥ï¼šä¸€èˆ¬çš„æ–¹æ³•ä¸è¡Œæ€ä¹ˆåŠï¼Ÿï¼ˆâ€¼ï¸éå¸¸å…³é”®ï¼‰ ä½¿ç”¨trtexecæä¾›çš„è½¬æ¢æ¨¡å‹æ–¹æ³•ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨\nåŸå› åˆ†æï¼šæ¨¡å‹æ¯”è¾ƒå¤æ‚ï¼ŒTensorRTæ— æ³•æ”¯æŒ â€”â€” è¿™ä¸ªé—®é¢˜åœ¨å®‰è£…TensorRTæœ€æ–°ç‰ˆä¹‹åè§£å†³ï¼Œä½†TensorRTå¢åŠ äº†æ–°ç‰¹å¾ï¼ˆä½¿ç”¨ç¬¬ä¸‰æ–¹æ’ä»¶ï¼‰ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨trtexecè½¬æ¢åçš„æ¨¡å‹ï¼š\nIn TensorRT 8.6 there are two implementations of InstanceNormalization that may perform differently depending on various parameters. By default the parser will insert an InstanceNormalization plugin layer as it performs best for general use cases. Users that want to benchmark using the native TensorRT implementation of InstanceNorm can set the parser flag kNATIVE_INSTANCENORM prior to parsing the model. For building version compatible or hardware compatible engines, this flag must be set.\nä½¿ç”¨pythonè„šæœ¬æ¥å¤„ç†ï¼ŒdebugåŠŸèƒ½è¾ƒå¼±ï¼Œå°è¯•ä½¿ç”¨C++çš„ä»£ç æ¥é‡å†™æ•´ä¸ªå·¥å…·é“¾\nä½¿ç”¨æ–°ç‰ˆæœ¬ç‰¹æ€§æ¥è½¬æ¢Onnx ç›´æ¥ä¸Šä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 // Usage: ./onnx_to_tensorrt onnx_path #include #include #include #include // ç»§æ‰¿è‡ª nvinfer1::ILogger ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æ—¥å¿—å¤„ç†æ–¹å¼ class Logger : public nvinfer1::ILogger { public: void log(Severity severity, const char *msg) noexcept override { // è°ƒè¯•å®Œæ•´ä¿¡æ¯ if (severity != Severity::kINFO) std::cout \u003c\u003c msg \u003c\u003c std::endl; } } gLogger; #include int main(int argc, char *argv[]) { if (argc \u003c 2) { std::cerr \u003c\u003c \"Please specify path to the ONNX model.\\n\"; return 1; } auto builder = nvinfer1::createInferBuilder(gLogger); const auto explicitBatch = 1U \u003c\u003c static_cast\u003cuint32_t\u003e(nvinfer1::NetworkDefinitionCreationFlag::kEXPLICIT_BATCH); auto network = builder-\u003ecreateNetworkV2(explicitBatch); auto config = builder-\u003ecreateBuilderConfig(); auto parser = nvonnxparser::createParser(*network, gLogger); // æ³¨æ„è¿™é‡Œï¼šä½¿ç”¨TensorRTè‡ªå¸¦çš„InstanceNormalizationå®ç° auto flag = 1U \u003c\u003c static_cast\u003cuint32_t\u003e(nvonnxparser::OnnxParserFlag::kNATIVE_INSTANCENORM); parser-\u003esetFlags(flag); std::string model_path = argv[1]; if (!parser-\u003eparseFromFile(model_path.c_str(), 1)) { std::cerr \u003c\u003c \"Failed to parse the ONNX model.\\n\"; return 1; } auto engine = builder-\u003ebuildEngineWithConfig(*network, *config); if (!engine) { std::cerr \u003c\u003c \"Failed to create the TensorRT engine.\\n\"; return 1; } std::string engine_path = model_path.substr(0, model_path.find_last_of('.')) + \".trt\"; std::cout \u003c\u003c \"Serializing the TensorRT engine to \" \u003c\u003c engine_path \u003c\u003c \"...\\n\"; nvinfer1::IHostMemory *serializedModel = engine-\u003eserialize(); std::ofstream engineFile(engine_path, std::ios::binary); engineFile.write(reinterpret_cast\u003cconst char *\u003e(serializedModel-\u003edata()), serializedModel-\u003esize()); engineFile.close(); serializedModel-\u003edestroy(); parser-\u003edestroy(); engine-\u003edestroy(); config-\u003edestroy(); network-\u003edestroy(); builder-\u003edestroy(); return 0; } ç›´æ¥ä½¿ç”¨æ­¤ä»£ç è¿›è¡Œæ¨¡å‹è½¬æ¢;\néªŒè¯æ¨¡å‹å¯è¡Œæ€§ \u0026\u0026 æ¨¡å‹æ¨ç†è¿‡ç¨‹ è¿™é‡Œç›´æ¥å†™ä¸€ä¸ªdemoï¼Œæ¥å®ç°æ¨¡å‹çš„æ¨ç†è¿‡ç¨‹ï¼Œä»è€ŒéªŒè¯æ¨¡å‹çš„å¯è¡Œæ€§ï¼Œè¿™éƒ¨åˆ†ç›´æ¥ä¸Šä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 // tensorrt_image.cpp #include #include #include #include #include #define TEST_TIME 0 // ç»§æ‰¿è‡ª nvinfer1::ILogger ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æ—¥å¿—å¤„ç†æ–¹å¼ class Logger : public nvinfer1::ILogger { public: void log(Severity severity, const char *msg) noexcept override { // Severity::kVERBOSE æˆ– kINFO // åªæ‰“å°é”™è¯¯ä¿¡æ¯ if (severity == Severity::kERROR \u0026\u0026 severity == Severity::kINTERNAL_ERROR) { std::cout \u003c\u003c msg \u003c\u003c std::endl; } } } gLogger; int main(int argc, char *argv[]) { if (argc \u003c 2) { std::cerr \u003c\u003c \"Please specify path to the engine file.\\n\"; return 1; } // æ‰“å¼€å¹¶ååºåˆ—åŒ– TensorRT engine std::ifstream engineFile(argv[1], std::ios::binary); if (!engineFile) { std::cerr \u003c\u003c \"Error opening engine file\\n\"; return -1; } engineFile.seekg(0, engineFile.end); long int fsize = engineFile.tellg(); engineFile.seekg(0, engineFile.beg); std::vector\u003cchar\u003e engineData(fsize); engineFile.read(engineData.data(), fsize); if (!engineFile) { std::cerr \u003c\u003c \"Error reading engine file\\n\"; return -1; } nvinfer1::IRuntime *runtime = nvinfer1::createInferRuntime(gLogger); nvinfer1::ICudaEngine *engine = runtime-\u003edeserializeCudaEngine(engineData.data(), fsize, nullptr); // åˆ›å»ºæ¨ç†ä¸Šä¸‹æ–‡ nvinfer1::IExecutionContext *context = engine-\u003ecreateExecutionContext(); // è¯»å–å¹¶é¢„å¤„ç†å›¾åƒ cv::Mat img1 = cv::imread(\"/home/metoak/Projects/dependency/InferenceDemo/images/left.png\", cv::IMREAD_COLOR); cv::Mat img2 = cv::imread(\"/home/metoak/Projects/dependency/InferenceDemo/images/right.png\", cv::IMREAD_COLOR); cv::resize(img1, img1, cv::Size(640, 384)); cv::resize(img2, img2, cv::Size(640, 384)); img1.convertTo(img1, CV_32FC3, 1 / 255.0); img2.convertTo(img2, CV_32FC3, 1 / 255.0); // åˆ›å»ºè¾“å…¥æ•°æ® int num_elements_input = 1 * 3 * 384 * 640; // æ ¹æ®ä½ çš„æ¨¡å‹çš„å®é™…éœ€æ±‚è¿›è¡Œè°ƒæ•´ // åˆ†å‰²é€šé“ std::vector\u003ccv::Mat\u003e channels1(3); std::vector\u003ccv::Mat\u003e channels2(3); cv::split(img1, channels1); cv::split(img2, channels2); std::vector\u003cfloat\u003e data1; std::vector\u003cfloat\u003e data2; // å°†æ¯ä¸ªé€šé“çš„æ•°æ®æ·»åŠ åˆ°ç›¸åº”çš„å‘é‡ for (auto \u0026channel : channels1) { std::vector\u003cfloat\u003e channelData(channel.begin\u003cfloat\u003e(), channel.end\u003cfloat\u003e()); data1.insert(data1.end(), channelData.begin(), channelData.end()); } for (auto \u0026channel : channels2) { std::vector\u003cfloat\u003e channelData(channel.begin\u003cfloat\u003e(), channel.end\u003cfloat\u003e()); data2.insert(data2.end(), channelData.begin(), channelData.end()); } #if TEST_TIME == 1 // æ‰“å°å›¾åƒçš„å‰10ä¸ªåƒç´ å€¼ std::cout \u003c\u003c \"First 10 pixels of the input image:\\n\"; for (int i = 0; i \u003c 10; ++i) { std::cout \u003c\u003c data1[i] \u003c\u003c \" \"; } #endif // è½¬æ¢å›å›¾åƒ std::vector\u003ccv::Mat\u003e channels(3); for (int c = 0; c \u003c 3; ++c) { channels[c] = cv::Mat(384, 640, CV_32F, data1.data() + c * 384 * 640); } cv::Mat imgData1; cv::merge(channels, imgData1); // å½’ä¸€åŒ–å¹¶å°†æ•°æ®ç±»å‹è½¬æ¢å› CV_8UC3 ä»¥ä¾¿æ˜¾ç¤º imgData1 = imgData1 * 255.0; imgData1.convertTo(imgData1, CV_8UC3); cv::imwrite(\"/home/metoak/Projects/input.png\", imgData1); // åˆ†é… GPU å†…å­˜ç”¨äºè¾“å…¥ void *gpuData1; void *gpuData2; cudaMalloc(\u0026gpuData1, num_elements_input * sizeof(float)); cudaMalloc(\u0026gpuData2, num_elements_input * sizeof(float)); // å¤åˆ¶è¾“å…¥æ•°æ®åˆ° GPU cudaMemcpy(gpuData1, data1.data(), num_elements_input * sizeof(float), cudaMemcpyHostToDevice); cudaMemcpy(gpuData2, data2.data(), num_elements_input * sizeof(float), cudaMemcpyHostToDevice); // æ ¹æ®ä½ çš„æ¨¡å‹çš„è¾“å‡ºå¤§å°æ¥åˆ›å»ºè¾“å‡ºæ•°æ® int num_elements_output = 1 * 3 * 384 * 640; // ä½ éœ€è¦æ ¹æ®ä½ çš„æ¨¡å‹çš„å®é™…è¾“å‡ºå¤§å°è¿›è¡Œè°ƒæ•´ // åˆ†é… GPU å†…å­˜ç”¨äºè¾“å‡º void *gpuOutput[7]; for (int i = 0; i \u003c 7; ++i) { cudaMalloc(\u0026gpuOutput[i], num_elements_output * sizeof(float)); } // åˆ›å»ºè¾“å…¥è¾“å‡ºçš„æŒ‡é’ˆæ•°ç»„ void *bindings[9] = {gpuData1, gpuData2, gpuOutput[0], gpuOutput[1], gpuOutput[2], gpuOutput[3], gpuOutput[4], gpuOutput[5], gpuOutput[6]}; // åˆ›å»º CUDA stream cudaStream_t stream; cudaStreamCreate(\u0026stream); #if TEST_TIME == 1 // 100æ¬¡æ¨ç† cudaEvent_t start, stop; cudaEventCreate(\u0026start); cudaEventCreate(\u0026stop); float totalTime = 0; int iteration = 100; // æ¨ç†æ¬¡æ•° for (int i = 0; i \u003c iteration; i++) { cudaEventRecord(start, stream); // æ‰§è¡Œæ¨ç† context-\u003eenqueue(1, bindings, stream, nullptr); std::cout \u003c\u003c \"Inference iteration: \" \u003c\u003c i \u003c\u003c std::endl; cudaEventRecord(stop, stream); cudaEventSynchronize(stop); float milliseconds = 0; cudaEventElapsedTime(\u0026milliseconds, start, stop); totalTime += milliseconds; } float avgTime = totalTime / iteration; std::cout \u003c\u003c \"Average inference time per image: \" \u003c\u003c avgTime \u003c\u003c \" ms.\" \u003c\u003c std::endl; cudaEventDestroy(start); cudaEventDestroy(stop); #else // æ‰§è¡Œæ¨ç† context-\u003eenqueue(1, bindings, stream, nullptr); #endif // å°†éœ€è¦çš„è¾“å‡ºæ•°æ®ä» GPU å†…å­˜å¤åˆ¶å› CPU å†…å­˜ std::vector\u003cfloat\u003e outputData(num_elements_output); cudaMemcpy(outputData.data(), gpuOutput[6], num_elements_output * sizeof(float), cudaMemcpyDeviceToHost); #if TEST_TIME == 1 // æ‰“å°å›¾åƒçš„å‰10ä¸ªåƒç´ å€¼ std::cout \u003c\u003c \"First 10 pixels of the output image:\\n\"; for (int i = 0; i \u003c 10; ++i) { std::cout \u003c\u003c outputData[i] \u003c\u003c \" \"; } #endif // å°†ä¸€ç»´å‘é‡è½¬æ¢ä¸º3é€šé“å›¾åƒ cv::Mat img_out(384, 640, CV_32F, outputData.data()); cv::Mat img_out_normalized; cv::normalize(img_out, img_out_normalized, 0, 255, cv::NORM_MINMAX, CV_8U); cv::Mat img_color_mapped; cv::applyColorMap(img_out_normalized, img_color_mapped, cv::COLORMAP_JET); // cv::resize(img_out, img_out, cv::Size(1920, 1080)); // ä¿å­˜å›¾åƒ cv::imwrite(\"/home/metoak/Projects/output.png\", img_color_mapped); std::cout \u003c\u003c \"Output image size: \" \u003c\u003c img_out_normalized.size() \u003c\u003c \"\\n\"; // æ¸…ç† cudaFree(gpuData1); cudaFree(gpuData2); for (int i = 0; i \u003c 7; ++i) { cudaFree(gpuOutput[i]); } context-\u003edestroy(); engine-\u003edestroy(); runtime-\u003edestroy(); // é”€æ¯ CUDA stream cudaStreamDestroy(stream); return 0; } è¿™é‡Œæœ‰å‡ ç‚¹æ³¨æ„ï¼š\næ•°æ®çš„å‰å¤„ç†éœ€è¦æ ¹æ®çš„æ¨¡å‹çš„ç»“æ„æ¥è°ƒæ•´ï¼Œè¿™é‡Œæ˜¯è¾“å…¥ä¸¤ç»„å›¾åƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // åˆ†é… GPU å†…å­˜ç”¨äºè¾“å…¥ void *gpuData1; void *gpuData2; cudaMalloc(\u0026gpuData1, num_elements_input * sizeof(float)); cudaMalloc(\u0026gpuData2, num_elements_input * sizeof(float)); // å¤åˆ¶è¾“å…¥æ•°æ®åˆ° GPU cudaMemcpy(gpuData1, data1.data(), num_elements_input * sizeof(float), cudaMemcpyHostToDevice); cudaMemcpy(gpuData2, data2.data(), num_elements_input * sizeof(float), cudaMemcpyHostToDevice); // æ ¹æ®ä½ çš„æ¨¡å‹çš„è¾“å‡ºå¤§å°æ¥åˆ›å»ºè¾“å‡ºæ•°æ® int num_elements_output = 1 * 3 * 384 * 640; // ä½ éœ€è¦æ ¹æ®ä½ çš„æ¨¡å‹çš„å®é™…è¾“å‡ºå¤§å°è¿›è¡Œè°ƒæ•´ // åˆ†é… GPU å†…å­˜ç”¨äºè¾“å‡º void *gpuOutput[7]; for (int i = 0; i \u003c 7; ++i) { cudaMalloc(\u0026gpuOutput[i], num_elements_output * sizeof(float)); } è¿™ä¸€å—å°±æ˜¯æ ¹æ®æ¨¡å‹çš„ç»“æ„æ¥è°ƒæ•´è¾“å…¥å’Œè¾“å‡ºçš„\nè¿™é‡ŒåŠ å…¥äº†å¾ˆå¤šæ‰‹å·¥è°ƒè¯•çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä¿å­˜æ¨¡å‹è¾“å…¥å‰åçš„å›¾åƒæ¥éªŒè¯\nè¿™æ˜¯ä¸€æ®µå®Œæ•´çš„æ¨ç†ä»£ç ï¼Œå¦‚æœè¿™ä¸€æ®µä»£ç èƒ½å¤ŸæˆåŠŸè¿è¡Œï¼Œé‚£ä¹ˆå°†è¿™æ®µä»£ç æ•´åˆåˆ°å®é™…çš„åŠŸèƒ½ä¸­ï¼Œå®šä¹‰å¥½è¾“å…¥è¾“å‡ºçš„æ¥å£ï¼Œæ¨¡å‹ä¹Ÿä¸€æ ·å¯ä»¥æ­£å¸¸ä½¿ç”¨\nè¿™é‡Œå¾ˆå¤šåœ°æ–¹æ˜¯æ‰‹åŠ¨ç”³è¯·å†…å­˜ç©ºé—´çš„ï¼Œæ‰€ä»¥ä¸€å®šæ³¨æ„ä½¿ç”¨åçš„é”€æ¯ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»æ¥å®ç°ææ„è¿™ç§æ–¹æ³•ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 // æ¸…ç† cudaFree(gpuData1); cudaFree(gpuData2); for (int i = 0; i \u003c 7; ++i) { cudaFree(gpuOutput[i]); } context-\u003edestroy(); engine-\u003edestroy(); runtime-\u003edestroy(); // é”€æ¯ CUDA stream cudaStreamDestroy(stream); æ³¨æ„ç†è§£è¿™ä¸€éƒ¨åˆ†çš„åŠŸèƒ½å’Œå¿…è¦æ€§\næœ‰äº†è¿™ä¸¤éƒ¨åˆ†åï¼Œæ¨¡å‹ä»ONNXåˆ°TensorRTï¼Œå†åˆ°TensorRTçš„æ¨ç†å°±æ‰“é€šäº†ï¼\nå¯¹äºä¸Šé¢çš„ä»£ç ç¼–è¯‘ï¼Œç›´æ¥ä½¿ç”¨cmakeçš„æ–¹æ³•ï¼ŒCMakeLists.txtä¾‹å­å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 cmake_minimum_required(VERSION 3.10) project(OnnxInferenceDemo) # è°ƒè¯•æ¨¡å¼ set(CMAKE_BUILD_TYPE Debug) set(CMAKE_CXX_STANDARD 14) # è®¾ç½®METOAKçš„é©±åŠ¨è·¯å¾„ set(MO_SDK_DIR /opt/moak) find_package(OpenCV REQUIRED) find_package(PCL REQUIRED) find_package(CUDA REQUIRED) find_path(TENSORRT_INCLUDE_DIR NvInfer.h HINTS ${TENSORRT_ROOT_DIR} PATH_SUFFIXES include/) find_library(TENSORRT_LIBRARY nvinfer HINTS ${TENSORRT_ROOT_DIR} PATH_SUFFIXES lib lib64 lib/x64) find_library(TENSORRT_ONNX_LIBRARY nvonnxparser HINTS ${TENSORRT_ROOT_DIR} PATH_SUFFIXES lib lib64 lib/x64) set(TENSORRT_INCLUDE_DIRS ${TENSORRT_INCLUDE_DIR}) set(TENSORRT_LIBRARIES ${TENSORRT_LIBRARY} ${TENSORRT_ONNX_LIBRARY}) include_directories(${TENSORRT_INCLUDE_DIRS}) include_directories(${CUDA_INCLUDE_DIRS}) include_directories( include ${OpenCV_INCLUDE_DIRS} ${MO_SDK_DIR}/3rdparty/ONNX/x86_64/GPU/include ) link_directories(${MO_SDK_DIR}/3rdparty/ONNX/x86_64/GPU/lib) link_directories(lib) add_executable(onnx_to_tensorrt src/onnx_to_tensorrt.cpp) target_link_libraries(onnx_to_tensorrt ${TENSORRT_LIBRARIES} ${CUDA_LIBRARIES}) add_executable(tensorrt_image src/tensorrt_image.cpp) target_link_libraries(tensorrt_image ${OpenCV_LIBS} ${TENSORRT_LIBRARIES} ${CUDA_LIBRARIES}) æ€»ç»“ ä½¿ç”¨TensorRTæ¥è¿›è¡Œæ¨¡å‹åŠ é€Ÿï¼Œå¦‚æœå¾ˆå‡‘å·§ï¼Œå½“å‰ç‰ˆæœ¬æ— æ³•æ”¯æŒOnnxçš„æ¨¡å‹è½¬æ¢ï¼Œé‚£å¯èƒ½æ­£å¸¸æ–¹æ³•å°±æ— æ³•ä½¿ç”¨ï¼Œå°±æ¯”å¦‚è¿™é‡Œçš„æ¨¡å‹ï¼Œåœ¨TensorRT 8.6ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œéƒ½æ— æ³•å®Œæˆæ­£å¸¸çš„è½¬æ¢ï¼Œå¹¶ä¸”æŠ¥å‡ºæ®µé”™è¯¯å¼‚å¸¸ï¼Œè¿™ç§æƒ…å†µï¼Œå¯èƒ½å°±æ˜¯æ— æ³•æ”¯æŒï¼›\nè€Œä½¿ç”¨äº†æœ€æ–°ç‰ˆæœ¬å‘ç°ï¼Œæ¨¡å‹å¯ä»¥è½¬æ¢ï¼Œç›´æ¥æ— æ³•ç›´æ¥è¿›è¡Œæ¨¡å‹çš„æ¨ç†ï¼Œé‚£ä¹ˆå°±è¦æ’æŸ¥ä¸€ä¸‹æ˜¯å“ªé‡Œçš„é—®é¢˜äº†ï¼Œæ¯”å¦‚è¿™é‡Œçš„æ¨¡å‹ï¼Œåœ¨TensorRT 8.6.1ä¸Šå¯ä»¥å®Œæ•´è½¬æ¢ï¼Œä½†æ˜¯éœ€è¦æ‰‹åŠ¨æŒ‡å®šä½¿ç”¨çš„æ’ä»¶ï¼Œå†…å»ºçš„è¿˜æ˜¯å…¶ä»–çš„ï¼Œè¿™å°±ä¼šå½±å“æ¨¡å‹å¯¹åº”çš„æ¨ç†ç¨‹åºçš„ä¹¦å†™ã€‚\nå¦å¤–ä¸€ç‚¹ï¼š\nTensorRTçš„å®‰è£…å’Œç¯å¢ƒéƒ¨ç½²å…¶å®å¾ˆç®€å•ï¼Œä½†æ˜¯å› ä¸ºç½‘ç»œä¸Šçš„æœç´¢å‡ºæ¥çš„æ•™ç¨‹æ‚ä¸ƒæ‚å…«ï¼Œå¯¼è‡´æ²¡æœ‰æŒ‰ç…§ç»Ÿä¸€çš„æ–¹å¼æ¥å®‰è£…CUDAã€cuDNNã€TensorRTï¼Œå¯¼è‡´aptå®‰è£…æ—¶å‡ºç°ä¾èµ–å¼‚å¸¸ï¼Œå…¶å®åªè¦å…¨éƒ¨é‡‡ç”¨depåŒ…ç®¡ç†çš„æ–¹å¼æ¥å®‰è£…å°±ä¸ä¼šæœ‰é—®é¢˜ã€‚\n",
  "wordCount" : "6046",
  "inLanguage": "zh",
  "datePublished": "2023-09-05T19:06:48+08:00",
  "dateModified": "2023-09-05T19:06:48+08:00",
  "author":[{
    "@type": "Person",
    "name": "CKYoung"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://ahaknow.com/posts/know/%E4%BD%BF%E7%94%A8tensorrt%E5%AE%9E%E7%8E%B0%E6%A8%A1%E5%9E%8B%E5%8A%A0%E9%80%9F/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "AhaKnow",
    "logo": {
      "@type": "ImageObject",
      "url": "http://ahaknow.com/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://ahaknow.com" accesskey="h" title="AhaKnow (Alt + H)">
                <img src="http://ahaknow.com/Q.gif" alt="" aria-label="logo"
                    height="35">AhaKnow</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://ahaknow.com/" title="ğŸ¡ä¸»é¡µ">
                    <span>ğŸ¡ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="http://ahaknow.com/posts" title="ğŸ“šä¸“æ ">
                    <span>ğŸ“šä¸“æ </span>
                </a>
            </li>
            <li>
                <a href="http://ahaknow.com/archives" title="â±ï¸æ—¶é—´çº¿">
                    <span>â±ï¸æ—¶é—´çº¿</span>
                </a>
            </li>
            <li>
                <a href="http://ahaknow.com/tags" title="ğŸ·ï¸æ ‡ç­¾">
                    <span>ğŸ·ï¸æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="http://ahaknow.com/categories" title="ğŸ–‡ï¸å½’æ¡£">
                    <span>ğŸ–‡ï¸å½’æ¡£</span>
                </a>
            </li>
            <li>
                <a href="http://ahaknow.com/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://ahaknow.com">ğŸ¡ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="http://ahaknow.com/posts/">ğŸ“šä¸“æ </a>&nbsp;Â»&nbsp;<a href="http://ahaknow.com/posts/know/">ğŸŒŸçŸ¥è¯†</a></div>
    <h1 class="post-title">
      ä½¿ç”¨TensorRTå®ç°æ¨¡å‹åŠ é€Ÿ
    </h1>
    <div class="post-meta"><span title='2023-09-05 19:06:48 +0800 CST'>2023-09-05</span>&nbsp;Â·&nbsp;13 åˆ†é’Ÿ&nbsp;Â·&nbsp;CKYoung

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%80%e6%ad%a5%e5%85%88%e6%b5%8b%e8%af%95%e6%a8%a1%e5%9e%8b%e7%9a%84%e5%9f%ba%e5%87%86%e9%80%9f%e5%ba%a6" aria-label="ç¬¬ä¸€æ­¥ï¼šå…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦">ç¬¬ä¸€æ­¥ï¼šå…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8onnx%e6%b5%8b%e8%af%95%e6%a8%a1%e5%9e%8b%e8%bf%90%e8%a1%8c%e9%80%9f%e5%ba%a6%e5%9f%ba%e5%87%86" aria-label="ä½¿ç”¨ONNXæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡†">ä½¿ç”¨ONNXæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡†</a></li>
                <li>
                    <a href="#python%e8%84%9a%e6%9c%ac%e4%bb%a3%e7%a0%81" aria-label="Pythonè„šæœ¬ä»£ç ">Pythonè„šæœ¬ä»£ç </a></li>
                <li>
                    <a href="#%e6%a8%a1%e5%9e%8b%e9%80%9f%e5%ba%a6%e5%9f%ba%e5%87%86" aria-label="æ¨¡å‹é€Ÿåº¦åŸºå‡†">æ¨¡å‹é€Ÿåº¦åŸºå‡†</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac%e4%ba%8c%e6%ad%a5%e4%bd%bf%e7%94%a8tensorrt%e5%ae%9e%e7%8e%b0%e5%8a%a0%e9%80%9f" aria-label="ç¬¬äºŒæ­¥ï¼šä½¿ç”¨TensorRTå®ç°åŠ é€Ÿ">ç¬¬äºŒæ­¥ï¼šä½¿ç”¨TensorRTå®ç°åŠ é€Ÿ</a><ul>
                        
                <li>
                    <a href="#tensorrt%e7%8e%af%e5%a2%83%e9%83%a8%e7%bd%b2" aria-label="ğŸŒŸTensorRTç¯å¢ƒéƒ¨ç½²">ğŸŒŸTensorRTç¯å¢ƒéƒ¨ç½²</a><ul>
                        
                <li>
                    <a href="#1-%e5%ae%89%e8%a3%85cuda" aria-label="1. å®‰è£…CUDA">1. å®‰è£…CUDA</a></li>
                <li>
                    <a href="#2-%e5%ae%89%e8%a3%85cudnn" aria-label="2. å®‰è£…cuDNN">2. å®‰è£…cuDNN</a></li>
                <li>
                    <a href="#3-%e5%ae%89%e8%a3%85tensorrt" aria-label="3. å®‰è£…TensorRT">3. å®‰è£…TensorRT</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8trtexec%e5%b7%a5%e5%85%b7%e5%ae%9e%e7%8e%b0%e6%a8%a1%e5%9e%8b%e8%bd%ac%e6%8d%a2" aria-label="ä½¿ç”¨trtexecå·¥å…·å®ç°æ¨¡å‹è½¬æ¢">ä½¿ç”¨trtexecå·¥å…·å®ç°æ¨¡å‹è½¬æ¢</a></li>
                <li>
                    <a href="#%e9%aa%8c%e8%af%81engine%e6%a8%a1%e5%9e%8b%e6%98%af%e5%90%a6%e5%8f%af%e7%94%a8" aria-label="éªŒè¯engineæ¨¡å‹æ˜¯å¦å¯ç”¨ï¼Ÿ">éªŒè¯engineæ¨¡å‹æ˜¯å¦å¯ç”¨ï¼Ÿ</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac%e4%b8%89%e6%ad%a5%e4%b8%80%e8%88%ac%e7%9a%84%e6%96%b9%e6%b3%95%e4%b8%8d%e8%a1%8c%e6%80%8e%e4%b9%88%e5%8a%9e%e9%9d%9e%e5%b8%b8%e5%85%b3%e9%94%ae" aria-label="ç¬¬ä¸‰æ­¥ï¼šä¸€èˆ¬çš„æ–¹æ³•ä¸è¡Œæ€ä¹ˆåŠï¼Ÿï¼ˆâ€¼ï¸éå¸¸å…³é”®ï¼‰">ç¬¬ä¸‰æ­¥ï¼šä¸€èˆ¬çš„æ–¹æ³•ä¸è¡Œæ€ä¹ˆåŠï¼Ÿï¼ˆâ€¼ï¸éå¸¸å…³é”®ï¼‰</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8%e6%96%b0%e7%89%88%e6%9c%ac%e7%89%b9%e6%80%a7%e6%9d%a5%e8%bd%ac%e6%8d%a2onnx" aria-label="ä½¿ç”¨æ–°ç‰ˆæœ¬ç‰¹æ€§æ¥è½¬æ¢Onnx">ä½¿ç”¨æ–°ç‰ˆæœ¬ç‰¹æ€§æ¥è½¬æ¢Onnx</a></li>
                <li>
                    <a href="#%e9%aa%8c%e8%af%81%e6%a8%a1%e5%9e%8b%e5%8f%af%e8%a1%8c%e6%80%a7--%e6%a8%a1%e5%9e%8b%e6%8e%a8%e7%90%86%e8%bf%87%e7%a8%8b" aria-label="éªŒè¯æ¨¡å‹å¯è¡Œæ€§ &amp;amp;&amp;amp; æ¨¡å‹æ¨ç†è¿‡ç¨‹">éªŒè¯æ¨¡å‹å¯è¡Œæ€§ &amp;&amp; æ¨¡å‹æ¨ç†è¿‡ç¨‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>

  <div class="post-content"><h2 id="ç¬¬ä¸€æ­¥å…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦">ç¬¬ä¸€æ­¥ï¼šå…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦<a hidden class="anchor" aria-hidden="true" href="#ç¬¬ä¸€æ­¥å…ˆæµ‹è¯•æ¨¡å‹çš„åŸºå‡†é€Ÿåº¦">#</a></h2>
<h3 id="ä½¿ç”¨onnxæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡†">ä½¿ç”¨ONNXæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡†<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨onnxæµ‹è¯•æ¨¡å‹è¿è¡Œé€Ÿåº¦åŸºå‡†">#</a></h3>
<p><strong>ç›®æ ‡ï¼š</strong>
ä½¿ç”¨ONNX Runtimeæ¥æµ‹è¯•æœºå™¨å­¦ä¹ æ¨¡å‹çš„æ¨ç†æ—¶é—´åŸºå‡†ã€‚</p>
<p><strong>æ­¥éª¤ï¼š</strong></p>
<ol>
<li>
<p><strong>å®‰è£…ONNXå’ŒONNX Runtimeï¼š</strong> è¿™ä¸¤ä¸ªPythonåº“æ˜¯æµ‹è¯•åŸºå‡†çš„å…³é”®å·¥å…·ã€‚ONNXæ˜¯ä¸€ä¸ªå¼€æ”¾çš„æ¨¡å‹è¡¨ç¤ºæ ‡å‡†ï¼Œå®ƒå…è®¸åœ¨ä¸åŒçš„æœºå™¨å­¦ä¹ æ¡†æ¶ä¹‹é—´ç§»åŠ¨æ¨¡å‹ã€‚ONNX Runtimeåˆ™æ˜¯ä¸€ä¸ªç”¨äºè¿è¡ŒONNXæ¨¡å‹çš„é«˜æ€§èƒ½æ¨ç†å¼•æ“ã€‚å¯ä»¥é€šè¿‡pipè¿›è¡Œå®‰è£…ï¼Œå‘½ä»¤ä¸º<code>pip install onnx onnxruntime-gpu</code>ã€‚è¿™é‡Œçš„<code>onnxruntime-gpu</code>ç‰ˆæœ¬æ˜¯æ”¯æŒGPUçš„ONNX Runtimeã€‚</p>
</li>
<li>
<p><strong>åŠ è½½æ¨¡å‹ï¼š</strong> ä½¿ç”¨ONNX RuntimeåŠ è½½æ¨¡å‹ï¼Œå…·ä½“åšæ³•æ˜¯åˆ›å»ºä¸€ä¸ª<code>onnxruntime.InferenceSession</code>çš„å®ä¾‹ï¼Œå¹¶æŒ‡å®šæ¨¡å‹çš„æ–‡ä»¶è·¯å¾„å’Œæ¨ç†å¼•æ“æä¾›å•†ï¼ˆè¿™é‡Œé€‰æ‹©çš„æ˜¯<code>'CUDAExecutionProvider'</code>ï¼Œå³ä½¿ç”¨CUDAæ¥åˆ©ç”¨GPUåŠ é€Ÿï¼‰ã€‚</p>
</li>
<li>
<p><strong>è·å–è¾“å…¥ä¿¡æ¯å¹¶åˆ›å»ºè¾“å…¥æ•°æ®ï¼š</strong> éœ€è¦çŸ¥é“æ¨¡å‹çš„è¾“å…¥èŠ‚ç‚¹çš„åç§°å’Œå½¢çŠ¶ï¼Œè¿™å¯ä»¥é€šè¿‡<code>session.get_inputs()</code>æ¥è·å–ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯åï¼Œå°±å¯ä»¥åˆ›å»ºä¸ä¹‹åŒ¹é…çš„éšæœºè¾“å…¥æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>æ¨ç†å¹¶è®¡æ—¶ï¼š</strong> è¿›è¡Œ100æ¬¡æ¨¡å‹æ¨ç†ï¼Œå¹¶ä½¿ç”¨<code>time.time()</code>æ¥è®¡æ—¶ã€‚æ³¨æ„ï¼Œè¿™é‡Œå¿½ç•¥äº†ç¬¬ä¸€æ¬¡æ¨ç†çš„æ—¶é—´ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æ¨ç†å¯èƒ½ä¼šåŒ…å«ä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¯¼è‡´è€—æ—¶åå¤§ã€‚</p>
</li>
<li>
<p><strong>è®¡ç®—å¹³å‡æ¨ç†æ—¶é—´ï¼š</strong> é€šè¿‡å°†æ‰€æœ‰æ¨ç†çš„æ—¶é—´åŠ èµ·æ¥ï¼Œç„¶åé™¤ä»¥æ¨ç†æ¬¡æ•°ï¼Œå°±å¾—åˆ°äº†å¹³å‡æ¨ç†æ—¶é—´ã€‚</p>
</li>
</ol>
<p><strong>é—®é¢˜å’Œè§£å†³ï¼š</strong></p>
<ol>
<li>
<p><strong>å¦‚ä½•åˆ›å»ºåŒ¹é…æ¨¡å‹è¾“å…¥çš„æ•°æ®ï¼š</strong> æ¨¡å‹çš„è¾“å…¥å¯èƒ½æœ‰å¤šä¸ªï¼Œä¹Ÿå¯èƒ½æœ‰å„ç§å„æ ·çš„å½¢çŠ¶å’Œç±»å‹ã€‚éœ€è¦é€šè¿‡<code>session.get_inputs()</code>è·å–è¿™äº›ä¿¡æ¯ï¼Œç„¶åæ ¹æ®è¿™äº›ä¿¡æ¯åˆ›å»ºç›¸åº”çš„è¾“å…¥æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>å¦‚ä½•ç¡®ä¿ä½¿ç”¨äº†GPUï¼š</strong> éœ€è¦åœ¨åˆ›å»º<code>onnxruntime.InferenceSession</code>æ—¶æ˜ç¡®æŒ‡å®šä½¿ç”¨<code>'CUDAExecutionProvider'</code>ã€‚å¦‚æœæ²¡æœ‰æ­£ç¡®åœ°ä½¿ç”¨GPUï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¨ç†é€Ÿåº¦å¤§å¹…åº¦é™ä½ã€‚</p>
</li>
<li>
<p><strong>å¦‚ä½•å‡†ç¡®è®¡æ—¶ï¼š</strong> é€‰æ‹©å¿½ç•¥äº†ç¬¬ä¸€æ¬¡æ¨ç†çš„æ—¶é—´ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡æ¨ç†å¯èƒ½ä¼šåŒ…å«ä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¯¼è‡´è€—æ—¶åå¤§ã€‚</p>
</li>
</ol>
<h3 id="pythonè„šæœ¬ä»£ç ">Pythonè„šæœ¬ä»£ç <a hidden class="anchor" aria-hidden="true" href="#pythonè„šæœ¬ä»£ç ">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">onnxruntime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åŠ è½½æ¨¡å‹</span>
</span></span><span class="line"><span class="cl"><span class="n">model_path</span> <span class="o">=</span> <span class="s2">&#34;/home/metoak/Projects/ros_project/src/metoak_camera_driver/models/model_640_384_6125.onnx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># session = onnxruntime.InferenceSession(model_path)</span>
</span></span><span class="line"><span class="cl"><span class="n">session</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">providers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CUDAExecutionProvider&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è·å–è¾“å…¥åç§°å’Œå½¢çŠ¶</span>
</span></span><span class="line"><span class="cl"><span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl"><span class="n">input_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Input names:&#34;</span><span class="p">,</span> <span class="n">input_names</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Input shapes:&#34;</span><span class="p">,</span> <span class="n">input_shapes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># åˆ›å»ºä¸¤ä¸ªéšæœºè¾“å…¥</span>
</span></span><span class="line"><span class="cl"><span class="n">input1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">input_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">input2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">input_shapes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å‡†å¤‡è¾“å…¥æ•°æ®</span>
</span></span><span class="line"><span class="cl"><span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">input1</span><span class="p">,</span> <span class="n">input_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">input2</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ¨ç†æ¬¡æ•°</span>
</span></span><span class="line"><span class="cl"><span class="n">num_inferences</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ‰§è¡Œæ¨æ–­å¹¶è®¡æ—¶</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_inferences</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">inference_time</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inference_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Inference </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, Time: </span><span class="si">{</span><span class="n">inference_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="si">}</span><span class="s2"> ms&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># è®¡ç®—å¹³å‡æ¨æ–­æ—¶é—´</span>
</span></span><span class="line"><span class="cl"><span class="n">avg_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_inferences</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># æ‰“å°å¹³å‡æ¨æ–­æ—¶é—´</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Average inference time: </span><span class="si">{</span><span class="n">avg_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="si">}</span><span class="s2"> ms&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ¨¡å‹é€Ÿåº¦åŸºå‡†">æ¨¡å‹é€Ÿåº¦åŸºå‡†<a hidden class="anchor" aria-hidden="true" href="#æ¨¡å‹é€Ÿåº¦åŸºå‡†">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Model name: model_640_384_6125.onnx
</span></span><span class="line"><span class="cl">Input names: <span class="o">[</span><span class="s1">&#39;onnx::Cast_0&#39;</span>, <span class="s1">&#39;onnx::Cast_1&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">Input shapes: <span class="o">[[</span>1, 3, 384, 640<span class="o">]</span>, <span class="o">[</span>1, 3, 384, 640<span class="o">]]</span>
</span></span><span class="line"><span class="cl">Inference 2, Time: 299.41678047180176 ms
</span></span><span class="line"><span class="cl">Inference 3, Time: 306.2708377838135 ms
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Inference 98, Time: 332.33070373535156 ms
</span></span><span class="line"><span class="cl">Inference 99, Time: 317.1732425689697 ms
</span></span><span class="line"><span class="cl">Inference 100, Time: 333.3919048309326 ms
</span></span><span class="line"><span class="cl">Average inference time: 322.4095816564078 ms
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ç¬¬äºŒæ­¥ä½¿ç”¨tensorrtå®ç°åŠ é€Ÿ">ç¬¬äºŒæ­¥ï¼šä½¿ç”¨TensorRTå®ç°åŠ é€Ÿ<a hidden class="anchor" aria-hidden="true" href="#ç¬¬äºŒæ­¥ä½¿ç”¨tensorrtå®ç°åŠ é€Ÿ">#</a></h2>
<blockquote>
<p>å¦‚æœä½¿ç”¨çš„3080Tiæ˜¾å¡</p>
<p>æµ®ç‚¹è®¡ç®—èƒ½åŠ›ï¼š</p>
<p><strong>Single Precision Perf.</strong>: ==34.1 TFLOPS==</p>
<p><strong>Tensor Perf. (FP16)</strong>: ==136 TFLOPS==</p>
<p><strong>Tensor Perf. (FP16-Sparse)</strong>: ==273 TFLOPS==</p>
<p><strong>å¦‚æœä½¿ç”¨Tensoræ¥å¤„ç†å…¨éƒ¨ç²¾åº¦ä¸º16ä½æµ®ç‚¹æ•°çš„ç®—æ³•ï¼Œé‚£ä¹ˆç†è®ºçš„è¿ç®—é€Ÿç‡å¯ä»¥è¾¾åˆ°è‡³å°‘æ˜¯å•ç²¾åº¦æµ®ç‚¹è¿ç®—çš„ 136 / 34.1 = 3.99ï¼Œä¹Ÿå°±æ˜¯4å€é€Ÿåº¦çš„æå‡ï¼Œè€Œå¦‚æœæ¨¡å‹æœ¬èº«å°±æ˜¯æ··åˆè¿›åº¦è¿›è¡Œè¿ç®—çš„ï¼Œé‚£ä¹ˆæå‡çš„æ•ˆæœä¼šæ›´å¤§ï¼ï¼ˆå¦‚æœå†è€ƒè™‘ä¸Šç¨€ç–ä¼˜åŒ–ï¼Œé‚£ä¹ˆTensoråŠ é€Ÿçš„å€æ•°ä¼šæ›´é«˜ï¼Œè¾¾åˆ° 273 / 34.1 = 8å€çš„æå‡ï¼‰</strong></p>
</blockquote>
<h3 id="tensorrtç¯å¢ƒéƒ¨ç½²">ğŸŒŸTensorRTç¯å¢ƒéƒ¨ç½²<a hidden class="anchor" aria-hidden="true" href="#tensorrtç¯å¢ƒéƒ¨ç½²">#</a></h3>
<blockquote>
<p>å®‰è£…æ–¹æ³•å¯¹äº†ï¼Œå®‰è£…å…¶å®å¾ˆç®€å•ï¼Œä¸€å¥è¯è¯´æ˜å°±æ˜¯ï¼š</p>
<p>==cudaã€tensorrtéƒ½ä½¿ç”¨depåŒ…ï¼Œç„¶åä½¿ç”¨aptå®‰è£…==</p>
<p>ä½†æ˜¯ç»†èŠ‚å¾ˆå…³é”®ï¼ä¸‹é¢çš„è¿‡ç¨‹æ¶‰åŠå®‰è£…CUDAã€cuDNNã€TensorRT</p>
</blockquote>
<p><a href="https://docs.nvidia.com/deeplearning/tensorrt/install-guide/index.html">å®˜æ–¹æ–‡æ¡£</a></p>
<h4 id="1-å®‰è£…cuda">1. å®‰è£…CUDA<a hidden class="anchor" aria-hidden="true" href="#1-å®‰è£…cuda">#</a></h4>
<p>CUDAå’ŒNvida Driverè¿™ä¿©ä¸ªæ˜¯ç‹¬ç«‹ä¸å½±å“çš„ï¼Œæ‰€ä»¥å•ç‹¬å®‰è£…CUDAç‰ˆæœ¬å³å¯ï¼Œä¸Nvida Driverç‰ˆæœ¬æ— å…³ï¼Œæ¯”å¦‚å®‰è£…==cuda 11.8==</p>
<p>Ubuntu20.04:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin
</span></span><span class="line"><span class="cl">sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600
</span></span><span class="line"><span class="cl">wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda-repo-ubuntu2004-11-8-local_11.8.0-520.61.05-1_amd64.deb
</span></span><span class="line"><span class="cl">sudo dpkg -i cuda-repo-ubuntu2004-11-8-local_11.8.0-520.61.05-1_amd64.deb
</span></span><span class="line"><span class="cl">sudo cp /var/cuda-repo-ubuntu2004-11-8-local/cuda-*-keyring.gpg /usr/share/keyrings/
</span></span><span class="line"><span class="cl">sudo apt-get update
</span></span><span class="line"><span class="cl">sudo apt-get -y install cuda
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä½¿ç”¨äº†runfileçš„æ–¹å¼å®‰è£…è¿‡cudaäº†ï¼Œé‚£ä¹ˆæœ€åä¸€æ­¥åªéœ€è¦ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install cuda-libraries-11-8  
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-å®‰è£…cudnn">2. å®‰è£…cuDNN<a hidden class="anchor" aria-hidden="true" href="#2-å®‰è£…cudnn">#</a></h4>
<p>éœ€è¦æ³¨å†ŒNvidiaå¼€å‘è€…è´¦å·ï¼Œä¸‹è½½å¯¹åº”çš„CUDAç‰ˆæœ¬çš„å³å¯ï¼Œä½¿ç”¨å¦‚ä¸‹æ–¹å¼å®‰è£…ï¼š</p>
<p><a href="https://developer.nvidia.com/rdp/cudnn-download">å®˜ç½‘</a></p>
<p>ä¸‹è½½debç‰ˆæœ¬å³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> sudo dpkg -i cudnn-local-repo-ubuntu2004-8.9.2.26_1.0-1_amd64.deb  
</span></span><span class="line"><span class="cl"> sudo cp /var/cudnn-local-repo-ubuntu2004-8.9.2.26/cudnn-local-6D0A7AE1-keyring.gpg /usr/share/keyrings/ 
</span></span><span class="line"><span class="cl"> sudo apt update
</span></span><span class="line"><span class="cl"> sudo apt-get install libcudnn8
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-å®‰è£…tensorrt">3. å®‰è£…TensorRT<a hidden class="anchor" aria-hidden="true" href="#3-å®‰è£…tensorrt">#</a></h4>
<p><a href="https://developer.nvidia.com/nvidia-tensorrt-download">å®˜ç½‘</a></p>
<p>ä¸‹è½½æœ€æ–°ç‰ˆæœ¬TensorRT 8ï¼ŒåŒæ ·éœ€è¦å¼€å‘è€…è´¦å·ï¼›</p>
<p>ä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å¯¹åº”CUDAçš„æœ€æ–°ç‰ˆå³å¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo dpkg -i nv-tensorrt-local-repo-ubuntu2004-8.6.1-cuda-11.8_1.0-1_amd64.deb
</span></span><span class="line"><span class="cl">sudo cp /var/nv-tensorrt-local-repo-ubuntu2004-8.6.1-cuda-11.8_1.0-1/*-keyring.gpg /usr/share/keyrings/
</span></span><span class="line"><span class="cl">wozate
</span></span><span class="line"><span class="cl">sudo apt install tensorrt
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä½¿ç”¨trtexecå·¥å…·å®ç°æ¨¡å‹è½¬æ¢">ä½¿ç”¨trtexecå·¥å…·å®ç°æ¨¡å‹è½¬æ¢<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨trtexecå·¥å…·å®ç°æ¨¡å‹è½¬æ¢">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ä½¿ç”¨ä¾‹å­</span>
</span></span><span class="line"><span class="cl">trtexec --onnx<span class="o">=</span>/home/metoak/Projects/ros_project/src/metoak_camera_driver/models/model_sim_1280_704.onnx --saveEngine<span class="o">=</span>model_1280_704_fp16.engine --fp16 --avgRuns<span class="o">=</span><span class="m">100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥ä½¿ç”¨trtexecè¿™ä¸ªå·¥å…·æ¥ç›´æ¥è½¬æ¢onnxæ¨¡å‹ï¼Œä½†å®é™…å¯èƒ½ä¸ç†æƒ³æˆ–è€…é‡åˆ°ä¸€äº›é—®é¢˜ï¼š</p>
<blockquote>
<p>onnx2trt_utils.cpp:374: Your ONNX model has been generated with INT64 weights, while TensorRT does not natively support INT64. Attempting to cast down to INT32.
[07/25/2023-10:29:30] [W] [TRT] onnx2trt_utils.cpp:400: One or more weights outside the range of INT32 was clamped
[07/25/2023-10:29:30] [I] Finished parsing network model. Parse time: 1.3651
[07/25/2023-10:29:30] [I] [TRT] Graph optimization time: 0.282094 seconds.
[07/25/2023-10:29:30] [I] [TRT] [MemUsageChange] Init cuBLAS/cuBLASLt: CPU +0, GPU +10, now: CPU 2630, GPU 3661 (MiB)
[07/25/2023-10:29:30] [I] [TRT] [MemUsageChange] Init cuDNN: CPU +0, GPU +10, now: CPU 2630, GPU 3671 (MiB)
[07/25/2023-10:29:30] [I] [TRT] Local timing cache in use. Profiling results in this builder pass will not be stored.</p>
</blockquote>
<ol>
<li>
<p><code>Your ONNX model has been generated with INT64 weights, while TensorRT does not natively support INT64. Attempting to cast down to INT32.</code>: è¿™ä¸ªè­¦å‘Šè¡¨æ˜ä½ çš„ONNXæ¨¡å‹ä¸­åŒ…å«äº†INT64ç±»å‹çš„æƒé‡ï¼Œè€ŒTensorRTåŸç”Ÿä¸æ”¯æŒINT64ç±»å‹ã€‚TensorRTæ­£åœ¨å°è¯•å°†è¿™äº›æƒé‡è½¬æ¢ï¼ˆcastï¼‰ä¸ºINT32ç±»å‹ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ç²¾åº¦æŸå¤±ï¼Œå› ä¸ºINT32çš„èŒƒå›´å°äºINT64ã€‚</p>
</li>
<li>
<p><code>One or more weights outside the range of INT32 was clamped</code>: è¿™ä¸ªè­¦å‘Šè¡¨æ˜åœ¨è½¬æ¢æƒé‡ç±»å‹çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæƒé‡çš„å€¼è¶…å‡ºäº†INT32ç±»å‹çš„èŒƒå›´ï¼Œå¹¶è¢«å‹ç¼©ï¼ˆclampï¼‰åˆ°äº†INT32çš„èŒƒå›´å†…ã€‚è¿™ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ç²¾åº¦æŸå¤±ã€‚</p>
</li>
<li>
<p><code>Finished parsing network model. Parse time: 1.3651</code>: è¿™è¡¨ç¤ºTensorRTå·²ç»å®Œæˆäº†å¯¹ONNXæ¨¡å‹çš„è§£æï¼Œæ•´ä¸ªè§£æè¿‡ç¨‹èŠ±è´¹äº†1.3651ç§’ã€‚</p>
</li>
<li>
<p><code>Graph optimization time: 0.282094 seconds</code>: è¿™è¡¨ç¤ºTensorRTå¯¹æ¨¡å‹è¿›è¡Œä¼˜åŒ–çš„æ—¶é—´æ˜¯0.282094ç§’ã€‚</p>
</li>
<li>
<p><code>Init cuBLAS/cuBLASLt: CPU +0, GPU +10, now: CPU 2630, GPU 3661 (MiB)</code> å’Œ <code>Init cuDNN: CPU +0, GPU +10, now: CPU 2630, GPU 3671 (MiB)</code>: è¿™äº›è¡Œæ˜¯å…³äºTensorRTåˆå§‹åŒ–cuBLASå’ŒcuDNNåº“ï¼ˆè¿™äº›åº“ç”¨äºGPUåŠ é€Ÿçš„çº¿æ€§ä»£æ•°è¿ç®—å’Œæ·±åº¦ç¥ç»ç½‘ç»œè®¡ç®—ï¼‰æ‰€éœ€å†…å­˜çš„ä¿¡æ¯ã€‚è¿™äº›è¡Œæ˜¾ç¤ºäº†åœ¨åˆå§‹åŒ–è¿™äº›åº“åï¼ŒCPUå’ŒGPUå†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚</p>
</li>
<li>
<p><code>Local timing cache in use. Profiling results in this builder pass will not be stored.</code>: è¿™è¡¨ç¤ºTensorRTæ­£åœ¨ä½¿ç”¨æœ¬åœ°çš„è®¡æ—¶ç¼“å­˜è¿›è¡Œæ“ä½œï¼Œè€Œè¿™æ¬¡çš„åˆ†æç»“æœä¸ä¼šè¢«å­˜å‚¨ã€‚</p>
</li>
</ol>
<p>ä½¿ç”¨trtexecæ¥è½¬æ¢æ¨¡å‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¾—åˆ°ä¸‹é¢çš„è¾“å‡ºæ—¶ï¼Œä¼šæˆåŠŸï¼Œä½†ä¹Ÿæœ‰å¯èƒ½å¾—åˆ°æ¨¡å‹æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:13<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Starting inference
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Warmup completed <span class="m">12</span> queries over <span class="m">200</span> ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Timing trace has <span class="m">180</span> queries over 3.05014 s
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> <span class="o">===</span> Trace <span class="nv">details</span> <span class="o">===</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Trace averages of <span class="m">100</span> runs:
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Average on <span class="m">100</span> runs - GPU latency: 16.9045 ms - Host latency: 17.8527 ms <span class="o">(</span>enqueue 11.5822 ms<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> 
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> <span class="o">===</span> Performance <span class="nv">summary</span> <span class="o">===</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Throughput: 59.0137 qps
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Latency: <span class="nv">min</span> <span class="o">=</span> 14.8851 ms, <span class="nv">max</span> <span class="o">=</span> 27.6843 ms, <span class="nv">mean</span> <span class="o">=</span> 17.7984 ms, <span class="nv">median</span> <span class="o">=</span> 16.9878 ms, percentile<span class="o">(</span>90%<span class="o">)</span> <span class="o">=</span> 21.1488 ms, percentile<span class="o">(</span>95%<span class="o">)</span> <span class="o">=</span> 23.4043 ms, percentile<span class="o">(</span>99%<span class="o">)</span> <span class="o">=</span> 27.5272 ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Enqueue Time: <span class="nv">min</span> <span class="o">=</span> 3.59753 ms, <span class="nv">max</span> <span class="o">=</span> 22.9529 ms, <span class="nv">mean</span> <span class="o">=</span> 11.5029 ms, <span class="nv">median</span> <span class="o">=</span> 10.7087 ms, percentile<span class="o">(</span>90%<span class="o">)</span> <span class="o">=</span> 13.9353 ms, percentile<span class="o">(</span>95%<span class="o">)</span> <span class="o">=</span> 16.418 ms, percentile<span class="o">(</span>99%<span class="o">)</span> <span class="o">=</span> 20.6213 ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> H2D Latency: <span class="nv">min</span> <span class="o">=</span> 0.0994873 ms, <span class="nv">max</span> <span class="o">=</span> 0.790527 ms, <span class="nv">mean</span> <span class="o">=</span> 0.303106 ms, <span class="nv">median</span> <span class="o">=</span> 0.268311 ms, percentile<span class="o">(</span>90%<span class="o">)</span> <span class="o">=</span> 0.458588 ms, percentile<span class="o">(</span>95%<span class="o">)</span> <span class="o">=</span> 0.503906 ms, percentile<span class="o">(</span>99%<span class="o">)</span> <span class="o">=</span> 0.564697 ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> GPU Compute Time: <span class="nv">min</span> <span class="o">=</span> 14.0032 ms, <span class="nv">max</span> <span class="o">=</span> 26.499 ms, <span class="nv">mean</span> <span class="o">=</span> 16.8485 ms, <span class="nv">median</span> <span class="o">=</span> 16.0006 ms, percentile<span class="o">(</span>90%<span class="o">)</span> <span class="o">=</span> 19.6926 ms, percentile<span class="o">(</span>95%<span class="o">)</span> <span class="o">=</span> 22.436 ms, percentile<span class="o">(</span>99%<span class="o">)</span> <span class="o">=</span> 26.4436 ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> D2H Latency: <span class="nv">min</span> <span class="o">=</span> 0.319824 ms, <span class="nv">max</span> <span class="o">=</span> 1.09839 ms, <span class="nv">mean</span> <span class="o">=</span> 0.646768 ms, <span class="nv">median</span> <span class="o">=</span> 0.621216 ms, percentile<span class="o">(</span>90%<span class="o">)</span> <span class="o">=</span> 0.887512 ms, percentile<span class="o">(</span>95%<span class="o">)</span> <span class="o">=</span> 0.963013 ms, percentile<span class="o">(</span>99%<span class="o">)</span> <span class="o">=</span> 1.05774 ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Total Host Walltime: 3.05014 s
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Total GPU Compute Time: 3.03273 s
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>W<span class="o">]</span> * GPU compute <span class="nb">time</span> is unstable, with coefficient of <span class="nv">variance</span> <span class="o">=</span> 15.1765%.
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>W<span class="o">]</span>   If not already in use, locking GPU clock frequency or adding --useSpinWait may improve the stability.
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> Explanations of the performance metrics are printed in the verbose logs.
</span></span><span class="line"><span class="cl"><span class="o">[</span>07/25/2023-14:44:16<span class="o">]</span> <span class="o">[</span>I<span class="o">]</span> 
</span></span><span class="line"><span class="cl"><span class="o">&amp;&amp;&amp;&amp;</span> PASSED TensorRT.trtexec <span class="o">[</span>TensorRT v8601<span class="o">]</span> <span class="c1"># /usr/src/tensorrt/bin/trtexec --onnx=/home/metoak/Projects/ros_project/src/metoak_camera_driver/models/model_640_384_6125.onnx --saveEngine=model_640_384.engine --fp16 --avgRuns=100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™æ˜¯é€šè¿‡ä½¿ç”¨TensorRTå·¥å…·trtexecçš„ä¸€æ®µæµ‹è¯•è¾“å‡ºï¼Œä¸‹é¢æ˜¯æ¯ä¸ªé‡è¦éƒ¨åˆ†çš„è§£é‡Šï¼š</p>
<ul>
<li>
<p><code>[I] Warmup completed 12 queries over 200 ms</code>ï¼šåœ¨å¼€å§‹æ­£å¼è®¡æ—¶ä¹‹å‰ï¼Œtrtexecé¦–å…ˆæ‰§è¡Œäº†12ä¸ªé¢„çƒ­æŸ¥è¯¢ï¼Œæ€»è€—æ—¶200æ¯«ç§’ã€‚</p>
</li>
<li>
<p><code>[I] Timing trace has 180 queries over 3.05014 s</code>ï¼šè¿™è¡¨ç¤ºè¿è¡Œäº†180æ¬¡æ¨æ–­ï¼Œæ€»è€—æ—¶çº¦ä¸º3.05ç§’ã€‚</p>
</li>
<li>
<p><code>[I] Average on 100 runs - GPU latency: 16.9045 ms - Host latency: 17.8527 ms</code>ï¼šè¿™è¡¨ç¤ºåœ¨100æ¬¡è¿è¡Œä¸­ï¼Œå¹³å‡æ¯æ¬¡æ¨æ–­åœ¨GPUä¸Šçš„å»¶è¿Ÿæ˜¯16.9045æ¯«ç§’ï¼Œåœ¨ä¸»æœºä¸Šçš„å»¶è¿Ÿæ˜¯17.8527æ¯«ç§’ã€‚</p>
</li>
<li>
<p><code>[I] Throughput: 59.0137 qps</code>ï¼šè¿™è¡¨ç¤ºæ¨¡å‹çš„ååé‡ä¸º59.0137æŸ¥è¯¢æ¯ç§’ï¼ˆqpsï¼‰ã€‚</p>
</li>
<li>
<p><code>[I] Latency: min = 14.8851 ms, max = 27.6843 ms, mean = 17.7984 ms, median = 16.9878 ms</code>ï¼šè¿™æ˜¯å¯¹å»¶è¿Ÿçš„ä¸€äº›ç»Ÿè®¡æè¿°ï¼ŒåŒ…æ‹¬æœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼å’Œä¸­ä½æ•°ã€‚</p>
</li>
<li>
<p><code>[W] * GPU compute time is unstable, with coefficient of variance = 15.1765%.</code>ï¼šè¿™æ˜¯ä¸€ä¸ªè­¦å‘Šï¼Œè¡¨ç¤ºGPUè®¡ç®—æ—¶é—´çš„å˜åŒ–æ˜¯ä¸ç¨³å®šçš„ï¼Œæ–¹å·®ç³»æ•°ä¸º15.1765%ï¼Œå¯èƒ½éœ€è¦é€šè¿‡é”å®šGPUæ—¶é’Ÿé¢‘ç‡æˆ–ä½¿ç”¨<code>--useSpinWait</code>é€‰é¡¹æ¥æ”¹å–„è¿™ç§æƒ…å†µã€‚</p>
</li>
<li>
<p><code>&amp;&amp;&amp;&amp; PASSED TensorRT.trtexec [TensorRT v8601] # /usr/src/tensorrt/bin/trtexec --onnx=/home/metoak/Projects/ros_project/src/metoak_camera_driver/models/model_640_384_6125.onnx --saveEngine=model_640_384.engine --fp16 --avgRuns=100</code>ï¼šè¿™è¡¨ç¤ºtrtexecæµ‹è¯•é€šè¿‡äº†ï¼Œå¹¶ä¸”æ˜¾ç¤ºäº†ä½ ç”¨æ¥è¿è¡Œtrtexecçš„å‘½ä»¤è¡Œå‚æ•°ã€‚</p>
</li>
</ul>
<h3 id="éªŒè¯engineæ¨¡å‹æ˜¯å¦å¯ç”¨">éªŒè¯engineæ¨¡å‹æ˜¯å¦å¯ç”¨ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#éªŒè¯engineæ¨¡å‹æ˜¯å¦å¯ç”¨">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tensorrt</span> <span class="k">as</span> <span class="nn">trt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TRT_LOGGER</span> <span class="o">=</span> <span class="n">trt</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">trt</span><span class="o">.</span><span class="n">Logger</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">trt_runtime</span> <span class="o">=</span> <span class="n">trt</span><span class="o">.</span><span class="n">Runtime</span><span class="p">(</span><span class="n">TRT_LOGGER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">engine_path</span> <span class="o">=</span> <span class="s2">&#34;/home/metoak/Projects/models/model_resnet101.engine&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">engine_path</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">engine_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">engine</span> <span class="o">=</span> <span class="n">trt_runtime</span><span class="o">.</span><span class="n">deserialize_cuda_engine</span><span class="p">(</span><span class="n">engine_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Number of bindings: &#34;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">num_bindings</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">num_bindings</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">binding_name</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_tensor_name</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Binding &#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&#34;:&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Binding name: &#34;</span><span class="p">,</span> <span class="n">binding_name</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Binding shape: &#34;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_tensor_shape</span><span class="p">(</span><span class="n">binding_name</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Binding data type: &#34;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_tensor_dtype</span><span class="p">(</span><span class="n">binding_name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Is binding an input? &#34;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_tensor_mode</span><span class="p">(</span><span class="n">binding_name</span><span class="p">)</span> <span class="o">==</span> <span class="n">trt</span><span class="o">.</span><span class="n">TensorIOMode</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Number of layers: &#34;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">num_layers</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæ‰€æœ‰çš„æ‰“å°è¾“å‡ºéƒ½æ­£å¸¸ï¼Œé‚£ä¹ˆè¯´æ˜è½¬æ¢çš„æ¨¡å‹å¯ä»¥ï¼Œ==å¹¶ä¸”ä»¥æ­£å¸¸æ–¹æ³•è¿›è¡Œæ¨ç†ä¹Ÿæ˜¯å¯è¡Œçš„==</p>
<p>ä¹‹åå°±æ˜¯å°†æ¨¡å‹æ¨ç†éƒ¨åˆ†æ•´åˆè¿›å…¥é¡¹ç›®ä»£ç å³å¯ã€‚</p>
<h2 id="ç¬¬ä¸‰æ­¥ä¸€èˆ¬çš„æ–¹æ³•ä¸è¡Œæ€ä¹ˆåŠéå¸¸å…³é”®">ç¬¬ä¸‰æ­¥ï¼šä¸€èˆ¬çš„æ–¹æ³•ä¸è¡Œæ€ä¹ˆåŠï¼Ÿï¼ˆâ€¼ï¸éå¸¸å…³é”®ï¼‰<a hidden class="anchor" aria-hidden="true" href="#ç¬¬ä¸‰æ­¥ä¸€èˆ¬çš„æ–¹æ³•ä¸è¡Œæ€ä¹ˆåŠéå¸¸å…³é”®">#</a></h2>
<ol>
<li>
<p>ä½¿ç”¨trtexecæä¾›çš„è½¬æ¢æ¨¡å‹æ–¹æ³•ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨</p>
<ul>
<li>
<p>åŸå› åˆ†æï¼šæ¨¡å‹æ¯”è¾ƒå¤æ‚ï¼ŒTensorRTæ— æ³•æ”¯æŒ â€”â€” è¿™ä¸ªé—®é¢˜åœ¨å®‰è£…TensorRTæœ€æ–°ç‰ˆä¹‹åè§£å†³ï¼Œä½†TensorRTå¢åŠ äº†æ–°ç‰¹å¾ï¼ˆä½¿ç”¨ç¬¬ä¸‰æ–¹æ’ä»¶ï¼‰ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨trtexecè½¬æ¢åçš„æ¨¡å‹ï¼š</p>
</li>
<li>
<blockquote>
<p>In TensorRT 8.6 there are two implementations of InstanceNormalization that may perform differently depending on various parameters. By default the parser will insert an InstanceNormalization plugin layer as it performs best for general use cases. Users that want to benchmark using the native TensorRT implementation of InstanceNorm can set the parser flag <code>kNATIVE_INSTANCENORM</code> prior to parsing the model. For building version compatible or hardware compatible engines, this flag must be set.</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>ä½¿ç”¨pythonè„šæœ¬æ¥å¤„ç†ï¼ŒdebugåŠŸèƒ½è¾ƒå¼±ï¼Œå°è¯•ä½¿ç”¨C++çš„ä»£ç æ¥é‡å†™æ•´ä¸ªå·¥å…·é“¾</p>
</li>
</ol>
<h3 id="ä½¿ç”¨æ–°ç‰ˆæœ¬ç‰¹æ€§æ¥è½¬æ¢onnx">ä½¿ç”¨æ–°ç‰ˆæœ¬ç‰¹æ€§æ¥è½¬æ¢Onnx<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨æ–°ç‰ˆæœ¬ç‰¹æ€§æ¥è½¬æ¢onnx">#</a></h3>
<p>ç›´æ¥ä¸Šä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Usage: ./onnx_to_tensorrt onnx_path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;NvInfer.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;NvOnnxParser.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ç»§æ‰¿è‡ª nvinfer1::ILogger ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æ—¥å¿—å¤„ç†æ–¹å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">Logger</span> <span class="o">:</span> <span class="k">public</span> <span class="n">nvinfer1</span><span class="o">::</span><span class="n">ILogger</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">log</span><span class="p">(</span><span class="n">Severity</span> <span class="n">severity</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="k">noexcept</span> <span class="k">override</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è°ƒè¯•å®Œæ•´ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">severity</span> <span class="o">!=</span> <span class="n">Severity</span><span class="o">::</span><span class="n">kINFO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">gLogger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Please specify path to the ONNX model.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">nvinfer1</span><span class="o">::</span><span class="n">createInferBuilder</span><span class="p">(</span><span class="n">gLogger</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="k">auto</span> <span class="n">explicitBatch</span> <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nvinfer1</span><span class="o">::</span><span class="n">NetworkDefinitionCreationFlag</span><span class="o">::</span><span class="n">kEXPLICIT_BATCH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">network</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">createNetworkV2</span><span class="p">(</span><span class="n">explicitBatch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">config</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">createBuilderConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">nvonnxparser</span><span class="o">::</span><span class="n">createParser</span><span class="p">(</span><span class="o">*</span><span class="n">network</span><span class="p">,</span> <span class="n">gLogger</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ³¨æ„è¿™é‡Œï¼šä½¿ç”¨TensorRTè‡ªå¸¦çš„InstanceNormalizationå®ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nvonnxparser</span><span class="o">::</span><span class="n">OnnxParserFlag</span><span class="o">::</span><span class="n">kNATIVE_INSTANCENORM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">-&gt;</span><span class="n">setFlags</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">model_path</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">parseFromFile</span><span class="p">(</span><span class="n">model_path</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to parse the ONNX model.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">buildEngineWithConfig</span><span class="p">(</span><span class="o">*</span><span class="n">network</span><span class="p">,</span> <span class="o">*</span><span class="n">config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">engine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to create the TensorRT engine.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">engine_path</span> <span class="o">=</span> <span class="n">model_path</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">model_path</span><span class="p">.</span><span class="n">find_last_of</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#34;.trt&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Serializing the TensorRT engine to &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">engine_path</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">nvinfer1</span><span class="o">::</span><span class="n">IHostMemory</span> <span class="o">*</span><span class="n">serializedModel</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">serialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">engineFile</span><span class="p">(</span><span class="n">engine_path</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">engineFile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">serializedModel</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">()),</span> <span class="n">serializedModel</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">engineFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">serializedModel</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">engine</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">network</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">builder</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç›´æ¥ä½¿ç”¨æ­¤ä»£ç è¿›è¡Œæ¨¡å‹è½¬æ¢;</p>
<h3 id="éªŒè¯æ¨¡å‹å¯è¡Œæ€§--æ¨¡å‹æ¨ç†è¿‡ç¨‹">éªŒè¯æ¨¡å‹å¯è¡Œæ€§ &amp;&amp; æ¨¡å‹æ¨ç†è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#éªŒè¯æ¨¡å‹å¯è¡Œæ€§--æ¨¡å‹æ¨ç†è¿‡ç¨‹">#</a></h3>
<p>è¿™é‡Œç›´æ¥å†™ä¸€ä¸ªdemoï¼Œæ¥å®ç°æ¨¡å‹çš„æ¨ç†è¿‡ç¨‹ï¼Œä»è€ŒéªŒè¯æ¨¡å‹çš„å¯è¡Œæ€§ï¼Œè¿™éƒ¨åˆ†ç›´æ¥ä¸Šä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// tensorrt_image.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;NvInfer.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;opencv2/opencv.hpp&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define TEST_TIME 0
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ç»§æ‰¿è‡ª nvinfer1::ILogger ä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä¿®æ”¹æ—¥å¿—å¤„ç†æ–¹å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">Logger</span> <span class="o">:</span> <span class="k">public</span> <span class="n">nvinfer1</span><span class="o">::</span><span class="n">ILogger</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">log</span><span class="p">(</span><span class="n">Severity</span> <span class="n">severity</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="k">noexcept</span> <span class="k">override</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Severity::kVERBOSE æˆ– kINFO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åªæ‰“å°é”™è¯¯ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">severity</span> <span class="o">==</span> <span class="n">Severity</span><span class="o">::</span><span class="n">kERROR</span> <span class="o">&amp;&amp;</span> <span class="n">severity</span> <span class="o">==</span> <span class="n">Severity</span><span class="o">::</span><span class="n">kINTERNAL_ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">msg</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">gLogger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Please specify path to the engine file.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰“å¼€å¹¶ååºåˆ—åŒ– TensorRT engine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">engineFile</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">binary</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">engineFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error opening engine file</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">engineFile</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">engineFile</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="kt">int</span> <span class="n">fsize</span> <span class="o">=</span> <span class="n">engineFile</span><span class="p">.</span><span class="n">tellg</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">engineFile</span><span class="p">.</span><span class="n">seekg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">engineFile</span><span class="p">.</span><span class="n">beg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">engineData</span><span class="p">(</span><span class="n">fsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">engineFile</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">engineData</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">fsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">engineFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error reading engine file</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">nvinfer1</span><span class="o">::</span><span class="n">IRuntime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">nvinfer1</span><span class="o">::</span><span class="n">createInferRuntime</span><span class="p">(</span><span class="n">gLogger</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">nvinfer1</span><span class="o">::</span><span class="n">ICudaEngine</span> <span class="o">*</span><span class="n">engine</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">deserializeCudaEngine</span><span class="p">(</span><span class="n">engineData</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">fsize</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºæ¨ç†ä¸Šä¸‹æ–‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">nvinfer1</span><span class="o">::</span><span class="n">IExecutionContext</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">createExecutionContext</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯»å–å¹¶é¢„å¤„ç†å›¾åƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">img1</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="s">&#34;/home/metoak/Projects/dependency/InferenceDemo/images/left.png&#34;</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">IMREAD_COLOR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">img2</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">imread</span><span class="p">(</span><span class="s">&#34;/home/metoak/Projects/dependency/InferenceDemo/images/right.png&#34;</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">IMREAD_COLOR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img1</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">384</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">resize</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">Size</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">384</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">img1</span><span class="p">.</span><span class="n">convertTo</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">CV_32FC3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">img2</span><span class="p">.</span><span class="n">convertTo</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">CV_32FC3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºè¾“å…¥æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">num_elements_input</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">384</span> <span class="o">*</span> <span class="mi">640</span><span class="p">;</span> <span class="c1">// æ ¹æ®ä½ çš„æ¨¡å‹çš„å®é™…éœ€æ±‚è¿›è¡Œè°ƒæ•´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†å‰²é€šé“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&gt;</span> <span class="n">channels1</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&gt;</span> <span class="n">channels2</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">split</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">channels1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">split</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">channels2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">data1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">data2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†æ¯ä¸ªé€šé“çš„æ•°æ®æ·»åŠ åˆ°ç›¸åº”çš„å‘é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">channel</span> <span class="p">:</span> <span class="n">channels1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">channelData</span><span class="p">(</span><span class="n">channel</span><span class="p">.</span><span class="n">begin</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">channel</span><span class="p">.</span><span class="n">end</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">data1</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data1</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">channelData</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">channelData</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">channel</span> <span class="p">:</span> <span class="n">channels2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">channelData</span><span class="p">(</span><span class="n">channel</span><span class="p">.</span><span class="n">begin</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">channel</span><span class="p">.</span><span class="n">end</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">data2</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data2</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">channelData</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">channelData</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if TEST_TIME == 1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// æ‰“å°å›¾åƒçš„å‰10ä¸ªåƒç´ å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;First 10 pixels of the input image:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è½¬æ¢å›å›¾åƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&gt;</span> <span class="n">channels</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">channels</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">(</span><span class="mi">384</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="n">CV_32F</span><span class="p">,</span> <span class="n">data1</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="mi">384</span> <span class="o">*</span> <span class="mi">640</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">imgData1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">merge</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">imgData1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½’ä¸€åŒ–å¹¶å°†æ•°æ®ç±»å‹è½¬æ¢å› CV_8UC3 ä»¥ä¾¿æ˜¾ç¤º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">imgData1</span> <span class="o">=</span> <span class="n">imgData1</span> <span class="o">*</span> <span class="mf">255.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">imgData1</span><span class="p">.</span><span class="n">convertTo</span><span class="p">(</span><span class="n">imgData1</span><span class="p">,</span> <span class="n">CV_8UC3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">imwrite</span><span class="p">(</span><span class="s">&#34;/home/metoak/Projects/input.png&#34;</span><span class="p">,</span> <span class="n">imgData1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†é… GPU å†…å­˜ç”¨äºè¾“å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">gpuData1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">gpuData2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpuData1</span><span class="p">,</span> <span class="n">num_elements_input</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpuData2</span><span class="p">,</span> <span class="n">num_elements_input</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤åˆ¶è¾“å…¥æ•°æ®åˆ° GPU
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">gpuData1</span><span class="p">,</span> <span class="n">data1</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">num_elements_input</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">gpuData2</span><span class="p">,</span> <span class="n">data2</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">num_elements_input</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ®ä½ çš„æ¨¡å‹çš„è¾“å‡ºå¤§å°æ¥åˆ›å»ºè¾“å‡ºæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">num_elements_output</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">384</span> <span class="o">*</span> <span class="mi">640</span><span class="p">;</span> <span class="c1">// ä½ éœ€è¦æ ¹æ®ä½ çš„æ¨¡å‹çš„å®é™…è¾“å‡ºå¤§å°è¿›è¡Œè°ƒæ•´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†é… GPU å†…å­˜ç”¨äºè¾“å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">gpuOutput</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpuOutput</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">num_elements_output</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºè¾“å…¥è¾“å‡ºçš„æŒ‡é’ˆæ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">bindings</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">gpuData1</span><span class="p">,</span> <span class="n">gpuData2</span><span class="p">,</span> <span class="n">gpuOutput</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gpuOutput</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gpuOutput</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">gpuOutput</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">gpuOutput</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">gpuOutput</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">gpuOutput</span><span class="p">[</span><span class="mi">6</span><span class="p">]};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»º CUDA stream
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cudaStream_t</span> <span class="n">stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if TEST_TIME == 1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// 100æ¬¡æ¨ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cudaEvent_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">totalTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">iteration</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">// æ¨ç†æ¬¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iteration</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ‰§è¡Œæ¨ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">context</span><span class="o">-&gt;</span><span class="n">enqueue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bindings</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Inference iteration: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">cudaEventRecord</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cudaEventSynchronize</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">milliseconds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cudaEventElapsedTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">milliseconds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalTime</span> <span class="o">+=</span> <span class="n">milliseconds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">avgTime</span> <span class="o">=</span> <span class="n">totalTime</span> <span class="o">/</span> <span class="n">iteration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Average inference time per image: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">avgTime</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; ms.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cudaEventDestroy</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaEventDestroy</span><span class="p">(</span><span class="n">stop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// æ‰§è¡Œæ¨ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">context</span><span class="o">-&gt;</span><span class="n">enqueue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bindings</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†éœ€è¦çš„è¾“å‡ºæ•°æ®ä» GPU å†…å­˜å¤åˆ¶å› CPU å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">outputData</span><span class="p">(</span><span class="n">num_elements_output</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">outputData</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">gpuOutput</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">num_elements_output</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span> <span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if TEST_TIME == 1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// æ‰“å°å›¾åƒçš„å‰10ä¸ªåƒç´ å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;First 10 pixels of the output image:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">outputData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// å°†ä¸€ç»´å‘é‡è½¬æ¢ä¸º3é€šé“å›¾åƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">img_out</span><span class="p">(</span><span class="mi">384</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="n">CV_32F</span><span class="p">,</span> <span class="n">outputData</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">img_out_normalized</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">img_out</span><span class="p">,</span> <span class="n">img_out_normalized</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">NORM_MINMAX</span><span class="p">,</span> <span class="n">CV_8U</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">img_color_mapped</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cv</span><span class="o">::</span><span class="n">applyColorMap</span><span class="p">(</span><span class="n">img_out_normalized</span><span class="p">,</span> <span class="n">img_color_mapped</span><span class="p">,</span> <span class="n">cv</span><span class="o">::</span><span class="n">COLORMAP_JET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// cv::resize(img_out, img_out, cv::Size(1920, 1080));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¿å­˜å›¾åƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cv</span><span class="o">::</span><span class="n">imwrite</span><span class="p">(</span><span class="s">&#34;/home/metoak/Projects/output.png&#34;</span><span class="p">,</span> <span class="n">img_color_mapped</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Output image size: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">img_out_normalized</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¸…ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cudaFree</span><span class="p">(</span><span class="n">gpuData1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaFree</span><span class="p">(</span><span class="n">gpuData2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cudaFree</span><span class="p">(</span><span class="n">gpuOutput</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">engine</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é”€æ¯ CUDA stream
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cudaStreamDestroy</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæœ‰å‡ ç‚¹æ³¨æ„ï¼š</p>
<ol>
<li>
<p>æ•°æ®çš„å‰å¤„ç†éœ€è¦æ ¹æ®çš„æ¨¡å‹çš„ç»“æ„æ¥è°ƒæ•´ï¼Œè¿™é‡Œæ˜¯è¾“å…¥ä¸¤ç»„å›¾åƒ</p>
<ul>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// åˆ†é… GPU å†…å­˜ç”¨äºè¾“å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">gpuData1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">gpuData2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpuData1</span><span class="p">,</span> <span class="n">num_elements_input</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpuData2</span><span class="p">,</span> <span class="n">num_elements_input</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤åˆ¶è¾“å…¥æ•°æ®åˆ° GPU
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">gpuData1</span><span class="p">,</span> <span class="n">data1</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">num_elements_input</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">gpuData2</span><span class="p">,</span> <span class="n">data2</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">num_elements_input</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ®ä½ çš„æ¨¡å‹çš„è¾“å‡ºå¤§å°æ¥åˆ›å»ºè¾“å‡ºæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">num_elements_output</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">384</span> <span class="o">*</span> <span class="mi">640</span><span class="p">;</span> <span class="c1">// ä½ éœ€è¦æ ¹æ®ä½ çš„æ¨¡å‹çš„å®é™…è¾“å‡ºå¤§å°è¿›è¡Œè°ƒæ•´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†é… GPU å†…å­˜ç”¨äºè¾“å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">gpuOutput</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpuOutput</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">num_elements_output</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>è¿™ä¸€å—å°±æ˜¯æ ¹æ®æ¨¡å‹çš„ç»“æ„æ¥è°ƒæ•´è¾“å…¥å’Œè¾“å‡ºçš„</p>
</li>
</ul>
</li>
<li>
<p>è¿™é‡ŒåŠ å…¥äº†å¾ˆå¤šæ‰‹å·¥è°ƒè¯•çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä¿å­˜æ¨¡å‹è¾“å…¥å‰åçš„å›¾åƒæ¥éªŒè¯</p>
</li>
<li>
<p>è¿™æ˜¯ä¸€æ®µå®Œæ•´çš„æ¨ç†ä»£ç ï¼Œå¦‚æœè¿™ä¸€æ®µä»£ç èƒ½å¤ŸæˆåŠŸè¿è¡Œï¼Œé‚£ä¹ˆå°†è¿™æ®µä»£ç æ•´åˆåˆ°å®é™…çš„åŠŸèƒ½ä¸­ï¼Œå®šä¹‰å¥½è¾“å…¥è¾“å‡ºçš„æ¥å£ï¼Œæ¨¡å‹ä¹Ÿä¸€æ ·å¯ä»¥æ­£å¸¸ä½¿ç”¨</p>
</li>
<li>
<p>è¿™é‡Œå¾ˆå¤šåœ°æ–¹æ˜¯æ‰‹åŠ¨ç”³è¯·å†…å­˜ç©ºé—´çš„ï¼Œæ‰€ä»¥ä¸€å®šæ³¨æ„ä½¿ç”¨åçš„é”€æ¯ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»æ¥å®ç°ææ„è¿™ç§æ–¹æ³•ï¼‰</p>
<ul>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">    <span class="c1">// æ¸…ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cudaFree</span><span class="p">(</span><span class="n">gpuData1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cudaFree</span><span class="p">(</span><span class="n">gpuData2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cudaFree</span><span class="p">(</span><span class="n">gpuOutput</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">context</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">engine</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é”€æ¯ CUDA stream
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cudaStreamDestroy</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>æ³¨æ„ç†è§£è¿™ä¸€éƒ¨åˆ†çš„åŠŸèƒ½å’Œå¿…è¦æ€§</p>
</li>
</ul>
</li>
</ol>
<p>æœ‰äº†è¿™ä¸¤éƒ¨åˆ†åï¼Œæ¨¡å‹ä»ONNXåˆ°TensorRTï¼Œå†åˆ°TensorRTçš„æ¨ç†å°±æ‰“é€šäº†ï¼</p>
<p>å¯¹äºä¸Šé¢çš„ä»£ç ç¼–è¯‘ï¼Œç›´æ¥ä½¿ç”¨cmakeçš„æ–¹æ³•ï¼ŒCMakeLists.txtä¾‹å­å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.10</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">OnnxInferenceDemo</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># è°ƒè¯•æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_BUILD_TYPE</span> <span class="s">Debug</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span> <span class="s">14</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># è®¾ç½®METOAKçš„é©±åŠ¨è·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">set</span><span class="p">(</span><span class="s">MO_SDK_DIR</span> <span class="s">/opt/moak</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">OpenCV</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">PCL</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">CUDA</span> <span class="s">REQUIRED</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_path</span><span class="p">(</span><span class="s">TENSORRT_INCLUDE_DIR</span> <span class="s">NvInfer.h</span>
</span></span><span class="line"><span class="cl">          <span class="s">HINTS</span> <span class="o">${</span><span class="nv">TENSORRT_ROOT_DIR</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">          <span class="s">PATH_SUFFIXES</span> <span class="s">include/</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_library</span><span class="p">(</span><span class="s">TENSORRT_LIBRARY</span> <span class="s">nvinfer</span>
</span></span><span class="line"><span class="cl">             <span class="s">HINTS</span> <span class="o">${</span><span class="nv">TENSORRT_ROOT_DIR</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="s">PATH_SUFFIXES</span> <span class="s">lib</span> <span class="s">lib64</span> <span class="s">lib/x64</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_library</span><span class="p">(</span><span class="s">TENSORRT_ONNX_LIBRARY</span> <span class="s">nvonnxparser</span>
</span></span><span class="line"><span class="cl">             <span class="s">HINTS</span> <span class="o">${</span><span class="nv">TENSORRT_ROOT_DIR</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">             <span class="s">PATH_SUFFIXES</span> <span class="s">lib</span> <span class="s">lib64</span> <span class="s">lib/x64</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">TENSORRT_INCLUDE_DIRS</span> <span class="o">${</span><span class="nv">TENSORRT_INCLUDE_DIR</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">TENSORRT_LIBRARIES</span> <span class="o">${</span><span class="nv">TENSORRT_LIBRARY</span><span class="o">}</span> <span class="o">${</span><span class="nv">TENSORRT_ONNX_LIBRARY</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">TENSORRT_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">CUDA_INCLUDE_DIRS</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">include_directories</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">include</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">OpenCV_INCLUDE_DIRS</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">${</span><span class="nv">MO_SDK_DIR</span><span class="o">}</span><span class="s">/3rdparty/ONNX/x86_64/GPU/include</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">link_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">MO_SDK_DIR</span><span class="o">}</span><span class="s">/3rdparty/ONNX/x86_64/GPU/lib</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">link_directories</span><span class="p">(</span><span class="s">lib</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="s">onnx_to_tensorrt</span> <span class="s">src/onnx_to_tensorrt.cpp</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">onnx_to_tensorrt</span> <span class="o">${</span><span class="nv">TENSORRT_LIBRARIES</span><span class="o">}</span> <span class="o">${</span><span class="nv">CUDA_LIBRARIES</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="s">tensorrt_image</span> <span class="s">src/tensorrt_image.cpp</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">tensorrt_image</span> <span class="o">${</span><span class="nv">OpenCV_LIBS</span><span class="o">}</span> <span class="o">${</span><span class="nv">TENSORRT_LIBRARIES</span><span class="o">}</span> <span class="o">${</span><span class="nv">CUDA_LIBRARIES</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h2>
<p>ä½¿ç”¨TensorRTæ¥è¿›è¡Œæ¨¡å‹åŠ é€Ÿï¼Œå¦‚æœå¾ˆå‡‘å·§ï¼Œå½“å‰ç‰ˆæœ¬æ— æ³•æ”¯æŒOnnxçš„æ¨¡å‹è½¬æ¢ï¼Œé‚£å¯èƒ½æ­£å¸¸æ–¹æ³•å°±æ— æ³•ä½¿ç”¨ï¼Œå°±æ¯”å¦‚è¿™é‡Œçš„æ¨¡å‹ï¼Œåœ¨TensorRT 8.6ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œéƒ½æ— æ³•å®Œæˆæ­£å¸¸çš„è½¬æ¢ï¼Œå¹¶ä¸”æŠ¥å‡ºæ®µé”™è¯¯å¼‚å¸¸ï¼Œè¿™ç§æƒ…å†µï¼Œå¯èƒ½å°±æ˜¯æ— æ³•æ”¯æŒï¼›</p>
<p><strong>è€Œä½¿ç”¨äº†æœ€æ–°ç‰ˆæœ¬å‘ç°ï¼Œæ¨¡å‹å¯ä»¥è½¬æ¢ï¼Œç›´æ¥æ— æ³•ç›´æ¥è¿›è¡Œæ¨¡å‹çš„æ¨ç†ï¼Œé‚£ä¹ˆå°±è¦æ’æŸ¥ä¸€ä¸‹æ˜¯å“ªé‡Œçš„é—®é¢˜äº†ï¼Œæ¯”å¦‚è¿™é‡Œçš„æ¨¡å‹ï¼Œåœ¨TensorRT 8.6.1ä¸Šå¯ä»¥å®Œæ•´è½¬æ¢ï¼Œä½†æ˜¯éœ€è¦æ‰‹åŠ¨æŒ‡å®šä½¿ç”¨çš„æ’ä»¶ï¼Œå†…å»ºçš„è¿˜æ˜¯å…¶ä»–çš„ï¼Œè¿™å°±ä¼šå½±å“æ¨¡å‹å¯¹åº”çš„æ¨ç†ç¨‹åºçš„ä¹¦å†™ã€‚</strong></p>
<p>å¦å¤–ä¸€ç‚¹ï¼š</p>
<p>TensorRTçš„å®‰è£…å’Œç¯å¢ƒéƒ¨ç½²å…¶å®å¾ˆç®€å•ï¼Œä½†æ˜¯å› ä¸ºç½‘ç»œä¸Šçš„æœç´¢å‡ºæ¥çš„æ•™ç¨‹æ‚ä¸ƒæ‚å…«ï¼Œå¯¼è‡´æ²¡æœ‰æŒ‰ç…§ç»Ÿä¸€çš„æ–¹å¼æ¥å®‰è£…CUDAã€cuDNNã€TensorRTï¼Œå¯¼è‡´aptå®‰è£…æ—¶å‡ºç°ä¾èµ–å¼‚å¸¸ï¼Œå…¶å®åªè¦å…¨éƒ¨é‡‡ç”¨depåŒ…ç®¡ç†çš„æ–¹å¼æ¥å®‰è£…å°±ä¸ä¼šæœ‰é—®é¢˜ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://ahaknow.com/tags/%E7%BC%96%E7%A8%8B%E6%97%A5%E5%B8%B8/">ç¼–ç¨‹æ—¥å¸¸</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://ahaknow.com/posts/diary/0906%E4%BB%8E%E6%80%A7%E5%AF%92%E6%83%B3%E8%B5%B7/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>0906 ä»â€œæ€§å¯’â€æƒ³èµ·â€¦â€¦</span>
  </a>
  <a class="next" href="http://ahaknow.com/posts/diary/0904%E4%B9%A0%E6%83%AF%E4%B8%8E%E6%89%93%E7%A0%B4%E4%B9%A0%E6%83%AF/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>0904 ä¹ æƒ¯ä¸æ‰“ç ´ä¹ æƒ¯</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://ahaknow.com">AhaKnow</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/IHKYoung/CKPaper.git/" rel="noopener" target="_blank">CKPaper</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'ğŸ–¨ï¸æ‹·è´';

        function copyingDone() {
            copybutton.innerHTML = 'ğŸ“‹å·²æ‹·è´';
            setTimeout(() => {
                copybutton.innerHTML = 'ğŸ–¨ï¸æ‹·è´';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
