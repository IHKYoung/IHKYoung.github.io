<!DOCTYPE html>














<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        }
    };

    window.addEventListener('load', (event) => {
        document.querySelectorAll("mjx-container").forEach(function (x) {
            x.parentElement.classList += 'has-jax'
        })
    });
</script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>



<html lang="zh" dir="zh-cn">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>全栈开发：从Python脚本到独立的App（初稿） | AhaKnow</title>
<meta name="keywords" content="">
<meta name="description" content="前言 怎么样从一个Python脚本一步一步变成一个可以在多平台上独立使用的App呢？ 在这一部分之前，是改进和优化Python的训练脚本，其中涉">
<meta name="author" content="CKYoung">
<link rel="canonical" href="https://ahaknow.com/posts/know/dev-python-to-app/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://ahaknow.com/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://ahaknow.com/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://ahaknow.com/Q.gif">
<link rel="apple-touch-icon" href="https://ahaknow.com/Q.gif">
<link rel="mask-icon" href="https://ahaknow.com/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://ahaknow.com/posts/know/dev-python-to-app/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="全栈开发：从Python脚本到独立的App（初稿）" />
<meta property="og:description" content="前言 怎么样从一个Python脚本一步一步变成一个可以在多平台上独立使用的App呢？ 在这一部分之前，是改进和优化Python的训练脚本，其中涉" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ahaknow.com/posts/know/dev-python-to-app/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-09-24T10:32:02+08:00" />
<meta property="article:modified_time" content="2024-09-29T18:14:02+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="全栈开发：从Python脚本到独立的App（初稿）"/>
<meta name="twitter:description" content="前言 怎么样从一个Python脚本一步一步变成一个可以在多平台上独立使用的App呢？ 在这一部分之前，是改进和优化Python的训练脚本，其中涉"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "🚀 天天向上",
      "item": "https://ahaknow.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "🌟知识",
      "item": "https://ahaknow.com/posts/know/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "全栈开发：从Python脚本到独立的App（初稿）",
      "item": "https://ahaknow.com/posts/know/dev-python-to-app/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "全栈开发：从Python脚本到独立的App（初稿）",
  "name": "全栈开发：从Python脚本到独立的App（初稿）",
  "description": "前言 怎么样从一个Python脚本一步一步变成一个可以在多平台上独立使用的App呢？ 在这一部分之前，是改进和优化Python的训练脚本，其中涉",
  "keywords": [
    
  ],
  "articleBody": "前言 怎么样从一个Python脚本一步一步变成一个可以在多平台上独立使用的App呢？\n在这一部分之前，是改进和优化Python的训练脚本，其中涉及到很多知识点，也有很多心得和体悟，这些需要之后总结补充。\n不记录，肯定是会忘记的，以前干了很多次这样的事，到最后就只剩下一个标题，内容啥的完全想不起来了，所以要实时记录，时常温习。\n教，也是一种学习；输出，温故而知新。\n整体感受 想要把一个Python的脚本转换成一个App，比如在Windows平台上双击即可使用的exe程序，怎么做呢？\n首先，应该是有成熟的工具可以直接使用的，所以先收集信息看看有哪些，做一个整体的了解； 然后，做成App后，需要有交互，并且是基于图形界面的交互（GUI），因此就不能再是简单粗暴的命令行传递参数了； 再者，在设计时，要考虑美观，也要考虑用户体验，因此有很多细节上的需要注意，同时很多功能逻辑上的严谨也需要顾及； 这么来看，在一开始想做的时候，心里大概是有一个数的，知道一步一步分解之后需要怎么做，也能够凭借已有的经验来预估哪些逻辑需要设计，从这一点呢，其实也能学到一个好用的技巧（虽然这个道理以前就已经知道了）：\n拿一张白纸或者一面白板，一步一步写列出思路和提纲，具体往后做的时候就不怕自己脑子里给忘掉了； 而且一旦有灵感之后，还能直接补充到这个白纸或者白板上，有时候就需要这种外置的记忆，想到了就记下来很重要； 不应该纠结于工具本身，而应该落实在具体的做上面； 一次性想明白所有当然是最好的，但更多的时候可能是，一边做，一边更新迭代。 那现在开始做吧！\n工具篇 Windows上的CMake编译 好像是晕到死（Windows）要配合Visual Studio开发打包，但我就是不信这个邪，因为在Linux平台上就是一行命令就能解决的事，凭啥到Windows上要搞一套臃肿的软件呢？！\n确实，想要在Windows上实现cmake+make，很难，但不是不可能！\n首先也是收集了一些信息：\n在Windows上使用 CMake 和 make 通常比在Linux上更复杂，这是由于两者的架构和工具链有根本性的差异。以下是Windows与Linux在构建系统方面的不同之处，以及为什么在Windows上不能像在Linux上直接运行 cmake 和 make。\n1. 工具链的差异 Linux：Linux系统有一个非常标准化的开发环境，几乎所有发行版都预装了GNU工具链，包括gcc编译器和make构建工具。因此，开发人员只需要安装一些基本的开发工具包（如build-essential）即可轻松编译C/C++程序。 CMake 作为跨平台的构建系统，能生成Makefile，然后通过 make 工具来进行编译、链接等任务。\nWindows：Windows系统没有预装类似于Linux的GNU工具链，而是主要依赖于Microsoft Visual Studio 和 MSVC 编译器（Microsoft Visual C++）。Windows的开发环境与Linux存在本质区别，没有默认的标准构建工具如 make。因此，要在Windows上使用CMake生成和构建项目，通常需要依赖Visual Studio或第三方工具。\n2. CMake 与 Make 的工作原理 CMake 是一个跨平台的构建系统生成工具，但它本身并不执行编译或构建工作。CMake 的任务是根据项目配置文件（CMakeLists.txt）生成相应平台的构建文件，例如： Linux：CMake 通常生成 Makefile，然后通过 make 进行构建。 Windows：CMake 通常生成 Visual Studio项目文件 或 NMake Makefiles。Visual Studio 是 Windows 上常用的编译器和构建环境，NMake 是Windows下的一种 make 工具，虽然和GNU make 不完全兼容，但功能类似。 因此，CMake 在Windows上默认生成Visual Studio解决方案文件 (.sln) 或者 NMake Makefiles，而不是传统的GNU Makefile。\n3. 编译器的差异 Linux：Linux系统广泛使用GNU编译器（gcc、g++）和 clang，并且这些工具能够直接与make等构建工具配合工作。编译器和构建工具可以通过统一的方式来调用，CMake也支持生成 Makefile 并与 gcc 配合使用。\nWindows：Windows的默认编译器是 MSVC，它的命令行工具（如 cl.exe、link.exe）与GNU工具链有较大区别。Windows上并没有内置的 gcc 或 clang，这意味着如果不使用Visual Studio，开发人员需要手动安装并配置编译器（如 MinGW-w64 或 Cygwin）和构建工具（如 MSYS2）来提供GNU工具链的支持。\n4. Make 与 NMake 的区别 GNU Make：这是Linux上的默认构建工具，结合Makefile进行依赖管理和构建过程。它与GNU工具链高度集成。 NMake：这是微软提供的 make 工具，专为Windows开发环境设计，通常与MSVC配合使用。虽然NMake的基本功能类似于GNU Make，但它的语法和行为与GNU Make有所不同，NMake不能直接使用GNU风格的Makefile。 5. 跨平台兼容工具 如果不想使用Visual Studio，可以在Windows上通过安装GNU工具链来实现类似Linux的构建体验：\nMinGW-w64：提供了Windows上的GNU编译工具链（gcc 和 g++），并且能够与 CMake 配合使用生成 GNU Makefile，然后可以使用 make 进行构建。MinGW-w64 使你可以在Windows上使用类似Linux的编译环境。 MSYS2：这是一个兼容性更强的环境，基于MinGW和Cygwin，允许在Windows上运行许多Linux工具，包括 bash、gcc、make 等。MSYS2提供了一个接近Linux的终端环境，可以通过CMake生成GNU Makefile，然后使用GNU make 来编译项目。 Cygwin：Cygwin 提供了类似于Linux的环境，支持使用 gcc 和 make 进行开发，但其模拟层较重，性能不如MinGW，并且有时会引入一些额外的兼容性问题。 6. Windows Subsystem for Linux (WSL) Windows Subsystem for Linux (WSL) 提供了一个原生的Linux子系统，允许在Windows上运行Linux二进制程序。你可以在WSL中直接使用 CMake 和 make，因为WSL是一个完整的Linux环境，使用Ubuntu等发行版，你可以完全按照Linux的开发流程进行操作，而无需安装Visual Studio或其他工具链。\n使用WSL的步骤：\n安装WSL和Linux发行版（如Ubuntu）。 在WSL中安装 build-essential 包，包含 gcc、make 等工具。 在WSL中运行 cmake 和 make 完成项目的构建。 7. 不用Visual Studio可以吗？ 答案是可以，但需要选择合适的工具链。你可以通过以下方式在Windows上避免使用Visual Studio： 使用MinGW-w64 或 MSYS2 来提供GNU工具链，配合CMake生成GNU Makefile，然后使用 make 进行编译。 使用WSL，直接在Windows中运行Linux的CMake和Make工具。 使用NMake，如果仍然想使用MSVC编译器，但不希望依赖Visual Studio IDE，CMake也可以生成适用于NMake的Makefile。 8. 总结 Windows和Linux在构建系统上的差异主要体现在工具链和编译器上。Linux拥有标准的GNU工具链和 make，而Windows默认使用Visual Studio和MSVC编译器，导致在Windows上开发时，通常需要依赖Visual Studio或其他第三方工具。 如果你不想使用Visual Studio，可以通过安装MinGW-w64、MSYS2、Cygwin或WSL来获得类似于Linux的开发体验，在Windows上直接使用 cmake 和 make。 实际尝试后发现：\nMSYS2是个好东西，通过设置Path可以在PowerShell中使用，但单独使用MSYS2自带的终端会更好用，因为完全是类Unix风格； MSYS2安装的时候应该是自带MinGW的； MinGW也能单独安装，但好像安装完不知道咋用才好。 用到最后发现核心是这两句：\ncmake -DCMAKE_PREFIX_PATH=\"C:/msys64/mingw64\" -G \"MinGW Makefiles\" .. -Wno-dev mingw32-make 以及对于各种依赖和安装包，可以通过pacman来安装，这个其实就是arch linux上面那套，虽然可能没有apt那么完全。\n然后，我发现今天新点亮了一颗技能点，就是在使用搜索时，可以同时回答中英文，甚至加上一些调皮的话，比如下面这样的：\nGot it! Let’s create a detailed guide on using MSYS2 and pacman, which will include the steps for setting up the environment and using pacman to install dependencies efficiently. I’ll provide the instructions in both English and Chinese for each step, as requested. 😊\nUsing MSYS2 and Pacman for Installing Dependencies 在 MSYS2 中使用 Pacman 安装依赖\n1. Introduction to MSYS2 and Pacman MSYS2 和 Pacman 介绍\nMSYS2 is a powerful platform that brings a Unix-like environment to Windows. It provides a complete package management system through pacman (the same package manager used in Arch Linux) to install and manage software and libraries easily.\nMSYS2 是一个强大的平台，它为 Windows 带来了类似 Unix 的环境。它通过 pacman 提供了一个完整的包管理系统（与 Arch Linux 相同的包管理工具），可以轻松安装和管理软件和库。\nPacman allows you to quickly install packages and manage dependencies. Instead of manually compiling software from source, you can use pacman to install pre-built binaries, making the setup process much smoother.\nPacman 允许你快速安装软件包并管理依赖项。与手动从源代码编译软件相比，你可以使用 pacman 安装预编译的二进制文件，这使得设置过程更加顺畅。\n2. Step-by-Step Installation and Setup 分步安装和设置\n2.1 Download and Install MSYS2 下载并安装 MSYS2\nGo to the official MSYS2 website and download the installer for Windows.\n访问 MSYS2 官网 并下载适用于 Windows 的安装程序。\nRun the installer and follow the default installation path (C:\\msys64 is recommended).\n运行安装程序，并选择默认的安装路径（推荐使用 C:\\msys64）。\n2.2 Update Pacman and System 更新 Pacman 和系统\nAfter installation, you need to update the package database and core packages to ensure you’re working with the latest versions.\n安装完成后，需要更新包数据库和核心包，以确保你使用的是最新版本。\nOpen MSYS2 (either from the Start menu or from the installation folder).\n打开 MSYS2（可以通过开始菜单或从安装文件夹打开）。\nRun the following command to update the package database and the core system:\n运行以下命令以更新包数据库和核心系统：\npacman -Syu You may need to close and reopen MSYS2 to continue the update.\n你可能需要关闭并重新打开 MSYS2 来继续更新。\nAfter reopening, run the update again to ensure everything is up to date:\n重新打开后，再次运行更新命令以确保所有内容都是最新的：\npacman -Su 2.3 Install Essential Development Tools 安装必要的开发工具\nYou can install key development tools like GCC, G++, make, and CMake using pacman.\n你可以通过 pacman 安装关键的开发工具，如 GCC、G++、make 和 CMake。\nTo install the 64-bit toolchain (for compiling 64-bit applications):\n安装 64 位工具链（用于编译 64 位应用程序）：\npacman -S mingw-w64-x86_64-toolchain To install CMake (a common build system generator):\n安装 CMake（一个常用的构建系统生成器）：\npacman -S mingw-w64-x86_64-cmake To install other useful tools (such as Git or Python):\n安装其他有用的工具（如 Git 或 Python）：\npacman -S git python 2.4 Using Pacman to Search and Install Packages 使用 Pacman 搜索并安装软件包\nTo search for a package:\n搜索软件包：\npacman -Ss Example:\n例如：\npacman -Ss cmake To install a package:\n安装软件包：\npacman -S Example:\n例如：\npacman -S mingw-w64-x86_64-cmake To remove a package:\n删除软件包：\npacman -R 2.5 Check Installed Packages 检查已安装的软件包\nTo list all installed packages, run:\n要列出所有已安装的软件包，运行：\npacman -Q 2.6 Compiling Code Using MinGW in MSYS2 在 MSYS2 中使用 MinGW 编译代码\nOnce you’ve installed the MinGW toolchain, you can compile C/C++ code using the standard tools like gcc and g++.\n一旦你安装了 MinGW 工具链，你就可以使用 gcc 和 g++ 等标准工具编译 C/C++ 代码。\nTo compile a C++ file:\n编译 C++ 文件：\ng++ -o output main.cpp To use CMake for a project:\n使用 CMake 进行项目构建：\nmkdir build cd build cmake -G \"MSYS Makefiles\" .. make 2.7 Using MSYS2 Shells 使用 MSYS2 Shell\nMSYS2 provides different shells for different purposes. The most common shells are:\nMSYS2 Shell: For using Unix-like tools but not for compiling Windows applications. MinGW 64-bit Shell: For compiling 64-bit Windows applications using MinGW-w64. MinGW 32-bit Shell: For compiling 32-bit Windows applications. MSYS2 提供了不同用途的 Shell。常见的 Shell 有：\nMSYS2 Shell：用于使用类 Unix 工具，但不适合编译 Windows 应用程序。 MinGW 64-bit Shell：用于使用 MinGW-w64 编译 64 位 Windows 应用程序。 MinGW 32-bit Shell：用于编译 32 位 Windows 应用程序。 Make sure you open the correct shell depending on what you’re building.\n确保你根据要构建的内容打开正确的 Shell。\n3. Conclusion 总结\nMSYS2 combined with pacman provides a powerful and convenient development environment on Windows, bringing the simplicity of package management and tool installation from Linux-like systems. By using pacman, you can quickly install dependencies and libraries without the need to manually compile them from source unless absolutely necessary.\nMSYS2 与 pacman 相结合，为 Windows 提供了一个强大且方便的开发环境，带来了类似 Linux 系统的包管理和工具安装的简便性。通过使用 pacman，你可以快速安装依赖和库，除非万不得已，否则不需要手动从源代码编译。\nWith this guide, you should now be able to install and configure MSYS2, use pacman to manage packages, and set up a working development environment.\n通过本指南，你现在应该能够安装和配置 MSYS2，使用 pacman 管理软件包，并设置一个可用的开发环境。\nThat’s it! 🎉 I hope the bilingual style helps you with both your development and language learning.\n总的来说结合使用MSYS2，MinGW，pacman这些，是可以不依赖Visual Studio来实现exe的编译。\n其实一开始也遇到很多小问题，比如没有PCL库，然后PCL又依赖各种库，一开始的想法就是各种尝试嘛，甚至想到了手动安装，然后手动编译安装也是一个巨大的坑啊，后来是配合pacman一起服用了，虽然不及apt那么强大，但至少常用的库都有的，然后再编译需要的库就会顺畅很多。\nPython打包exe 理论上讲，应该是有直接将Python打包成exe程序的工具的，所以我的第一想法是先收集一些信息，比如得到下面这些：\n将Python打包成exe可执行文件的常见需求是为了将Python项目分发给没有Python环境的用户。以下是几种常用的打包工具，并且每种工具都有其优势和适用场景。\n1. PyInstaller 优势：最广泛使用的Python打包工具之一，支持多平台（Windows、Linux、Mac），能够将整个Python项目及其依赖包打包为一个单独的可执行文件。 安装：pip install pyinstaller 使用： pyinstaller --onefile your_script.py --onefile 参数会将所有依赖打包到一个可执行文件中。生成的exe文件通常位于 dist/ 文件夹中。 优点： 支持多平台。 配置灵活，可以指定隐藏控制台窗口（通过 --noconsole），或者包含额外的资源文件。 缺点： 打包后文件较大，因为会打包所有依赖。 对于动态加载的模块或资源文件，需要额外配置。 2. cx_Freeze 优势：与PyInstaller类似，支持多平台打包，尤其适合需要将Python程序打包为Windows可执行文件的场景。它更注重跨平台的兼容性和可扩展性。 安装：pip install cx-Freeze 使用： 需要编写一个 setup.py 文件来定义打包配置： from cx_Freeze import setup, Executable setup( name=\"your_app_name\", version=\"1.0\", description=\"Description of your app\", executables=[Executable(\"your_script.py\")] ) 然后运行： python setup.py build 优点： 比PyInstaller更灵活，适合复杂项目。 支持不同的目标平台。 缺点： 配置复杂度较高。 需要手动设置依赖项。 3. Py2exe 优势：专为Windows平台开发的工具，可以将Python程序打包成Windows可执行文件。 安装：pip install py2exe 使用： 同样需要编写 setup.py： from distutils.core import setup import py2exe setup(console=['your_script.py']) 然后运行： python setup.py py2exe 优点： 针对Windows进行优化，适合Windows应用程序。 缺点： 仅支持Windows。 相对较旧，不如PyInstaller和cx_Freeze活跃。 4. Nuitka 优势：除了打包功能外，Nuitka还将Python代码编译为C代码，生成的可执行文件通常比PyInstaller和cx_Freeze生成的要小，并且在运行时性能更好。 安装：pip install nuitka 使用： nuitka --standalone --onefile your_script.py 优点： 生成的可执行文件运行效率更高。 文件大小较小。 缺点： 对于依赖复杂的项目，需要更多的配置。 打包速度较慢。 5. PyOxidizer 优势：较新的工具，强调快速的启动时间和轻量级的打包结果。可以将Python解释器和应用程序一起打包，并且支持创建独立的Rust二进制文件。 安装：可以通过Rust的包管理工具 cargo 安装： cargo install pyoxidizer 使用： 编写一个 pyoxidizer.bzl 配置文件，并运行 pyoxidizer 命令。 优点： 能够打包出更小、更快的可执行文件。 缺点： 需要学习Rust工具链的基础。 生态不如PyInstaller和cx_Freeze成熟。 6. Briefcase 优势：是BeeWare项目的一部分，支持跨平台打包，并且能够将Python应用打包为原生平台应用（例如：Windows的exe，macOS的.dmg，甚至是Android和iOS应用）。 安装：pip install briefcase 使用： briefcase create briefcase build briefcase run 优点： 支持多种平台打包。 非常适合开发桌面应用。 缺点： 主要用于GUI应用，命令行工具的打包支持较弱。 总结 PyInstaller 是目前最流行和最通用的选择，尤其适合跨平台和快速开发需求。 cx_Freeze 提供了更多的灵活性和跨平台兼容性，但需要更多的配置。 Nuitka 则更适合追求性能优化的场景，生成的文件更小。 Py2exe 是Windows专用的工具，适合Windows平台开发者。 PyOxidizer 和 Briefcase 则是一些新兴的工具，适合对性能和特定平台有特殊需求的场景。 根据你的需求，可以选择最合适的工具进行打包。如果你需要灵活且简单的方案，PyInstaller 是推荐的首选。如果你对文件大小和执行效率有要求，可以考虑 Nuitka。\n搜索之后，大致有了了解，就可以开始尝试了，看着比较简单的是：cx_Freeze，于是就先试了它，采取什么策略来尝试呢？\n比如，从最小可实现的方式出发吧，调用opencv读取图像并显示出来。尝试可行，似乎路能走通，并且发现了一些在Windows开发的一些规律：\nexe点击运行后都是通过.dll方式来找需要的依赖（动态链接库），如果没有就会出错 如果程序一打开就崩溃了，第一想到是不是链接库没有（这里想到小时候玩的盗版游戏，打不开游戏到网上找一找原因，或者是不是程序自己弹出来缺少哪个.dll，这时候再去下载一个放进文件夹） 在这个过程中，也摸索到了怎么来排查.dll缺失的问题，简单来说就是先看少哪个，少了那就复制过去，但怎么排查呢？也是有工具能直接用的，我还是采用先收集信息再尝试的策略\ncx_Freeze本身是可以用的，但是后来，我产生了一个不成熟的需求：\n能不能将所有的dll和exe一起打包成一个独立exe文件？\n尝试cx_Freeze发现似乎不太行，所以后面就转战了PyInstaller，但是实际用起来，PyInstaller要更好用一些，**因为可以设定的参数更详细，**原本我以为就是命令行参数的输入那么简单，后来因为想到：这种打包工具，应该是有专门的配置文件可以设置的吧？于是就摸清楚了流程。而且如果带着问题和需求出发，可以设置的选项还有很多，比如：\n手动选择哪些dll是额外打包的 是否要显示终端（在cx_Freeze中叫做Win32GUI，显示终端配合打印语句，可以调试；同样，如果想要去除终端创建，那么一定不能出现打印输出到终端） 配置图标，版本信息等等等 实际使用的例子 对于cx_Freeze可以使用install_exe.py写一个打包配置：\nfrom cx_Freeze import setup, Executable import os # 额外的ddl文件 extra_dll_files = [ ('extra_dll/libomp140.x86_64.dll', 'libomp140.x86_64.dll'), ('extra_dll/libomp140d.x86_64.dll', 'libomp140d.x86_64.dll') ] # 合并所有需要包含的文件 include_files = extra_dll_files # 添加打包选项 options = { 'build_exe': { 'build_exe': 'mt3d_2.0', 'include_files': include_files, 'include_msvcr': True # 包含 Microsoft Visual C++ 运行时库 } } # 配置可执行文件 executables = [ Executable('main.py', base='Win32GUI', target_name='mt3d.exe') ] # 设置打包 setup( name='MT3D', version='1.0', description='Manifold Tech Limited 3D Rendererer', options=options, executables=executables ) 实际运行就是：\npython .\\install_exe.py build 而对于PyInstaller，则可以使用更复杂的配置文件，比如install.spec，这个spec文件本质上也可以看作是Python文件：\n# -*- mode: python ; coding: utf-8 -*- import os # 其他额外考虑的dll文件 extra_dll_files = [ (os.path.abspath('extra_dll/libomp140.x86_64.dll'), '.'), # 这里的 '.' 表示目标路径是打包后的根目录 (os.path.abspath('extra_dll/libomp140d.x86_64.dll'), '.'), ] pre_run_pkg_path = os.path.abspath('PreOps') pre_run_dlls = [(os.path.join(pre_run_pkg_path, dll), '.') for dll in os.listdir(pre_run_pkg_path) if dll.endswith('.dll')] exe_files = [ ('PreOps.exe', '.') ] # 设置附加文件 binaries = extra_dll_files + pre_run_dlls + exe_files # 定义 assets 文件夹的路径 assets_dir = os.path.abspath('assets') # 遍历 assets 目录及其子目录 data_files = [] for root, dirs, files in os.walk(assets_dir): for file in files: # 获取文件的绝对路径 file_path = os.path.join(root, file) # 在打包时，将文件放入 assets 文件夹内保持层次结构 target_path = os.path.join('assets', os.path.relpath(root, assets_dir)) # 将每个文件的源路径和目标路径添加到 data_files 列表 data_files.append((file_path, target_path)) # 定义 lib 文件夹的路径（包含 .js 文件） lib_dir = os.path.abspath('lib') # 遍历 lib 目录及其子目录 for root, dirs, files in os.walk(lib_dir): for file in files: # 获取文件的绝对路径 file_path = os.path.join(root, file) # 在打包时，将文件放入 lib 文件夹内保持层次结构 target_path = os.path.join('lib', os.path.relpath(root, lib_dir)) # 将每个文件的源路径和目标路径添加到 data_files 列表 data_files.append((file_path, target_path)) block_cipher = None # EXE 配置 a = Analysis( ['train.py'], pathex=['.'], binaries=binaries, datas=data_files, hiddenimports=[], hookspath=[], runtime_hooks=[], excludes=[], win_no_prefer_redirects=False, win_private_assemblies=False, cipher=block_cipher, noarchive=False, ) # PYZ 配置 pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher) # EXE 配置 exe = EXE( pyz, a.scripts, [], exclude_binaries=True, # 设置为 True，表示 EXE 中不包含 binaries，因为 binaries 将在 COLLECT 阶段处理 name='MindCloud Renderer', debug=False, bootloader_ignore_signals=False, strip=False, upx=True, upx_exclude=[], runtime_tmpdir=None, console=False, # 设置为 False 隐藏控制台窗口 icon='C:/Users/Quite/CKCode/3DGSMT/assets/logo.ico', version='mt3d_version.txt', # 从文件中读取版本信息 ) # COLLECT 配置 coll = COLLECT( exe, a.binaries, a.zipfiles, a.datas, strip=False, upx=True, upx_exclude=[], name='MindCloud Renderer' ) #### 以下是单独的一个exe方式 #### #### 32位系统单文件不能大于4G #### # # EXE 配置 # exe = EXE( # pyz, # a.scripts, # a.binaries, # a.zipfiles, # a.datas, # [], # name='MindCloud Renderer', # debug=False, # bootloader_ignore_signals=False, # strip=False, # upx=False, # upx_exclude=[], # runtime_tmpdir=None, # console=False, # 设置为 False 隐藏控制台窗口 # icon='C:/Users/Quite/CKCode/3DGSMT/assets/logo.ico', # version='mt3d_version.txt', # 从文件中读取版本信息 # onefile=True # 设置为 True 以生成单文件 # ) 使用的话就是：\npyinstaller .\\install.spec 其实从这里的注释可以看出，当时遇到了打包一个独立exe程序的问题：文件大小不能超过4G，底层原因可能和32位系统有关系，但如果打包成一个_internal文件夹，就是正常的。写到这里，想到了当时制作晕到死安装盘时候也是，那个晕到死的镜像文件大于4G了，用官网的工具压根复制不完全，结果都4202年了，问题还没有解决，最好是手动选择NTFS文件系统，手动复制进去的，也是折腾了老半天。。。refus+手动复制吧\n以上只能算是一次初步的使用和感受记录，后面如果再用到，可以在此基础上再往前迈进一步了。\nWindows的dll分析工具 说实话，一开始去搜索有哪些dll分析工具的时候，遇到下载失败，github显示的时间是10年前，我都在想，是不是这玩意不能用了，后面才知道是自己不会用。。。纯属傻，比较搞笑的是，点开Dependencies闪退就以为程序不行，但是人家还有个DependenciesGui呢，我给直接忽视掉，导致我一开始直接陷入自闭状态很长一段时间。。。\n搜集的信息是这样的：\n在Windows上检查一个程序的DLL依赖并判断是否有缺失的现代工具可以帮助开发者更好地解决动态链接库（DLL）加载问题。随着Windows系统的发展，传统工具如 Dependency Walker 逐渐无法适应现代系统的新特性，诸如API Set Schema和SxS（side-by-side）依赖等机制。因此，以下是一些最新、成熟且常用的工具，涵盖了从静态到动态分析的不同需求：\n1. Dependencies (lucasg/Dependencies) 简介：Dependencies 是一个现代化的DLL依赖分析工具，专为替代老旧的 Dependency Walker 而设计，能处理Windows 10及以后的API Set Schema和SxS依赖问题。 功能特点： 识别和解析Windows 10的API Set Schema。 支持SxS并行依赖分析。 显示DLL导入导出表，列出函数依赖。 支持静态和动态依赖分析，提供实时的DLL加载信息。 适用场景：处理现代Windows操作系统上的DLL加载问题，特别是涉及动态加载、并行依赖和重定向API的场景。 下载：Dependencies - GitHub 使用方法： 下载并运行 Dependencies.exe。 打开目标可执行文件或DLL，查看依赖树，缺失的DLL会标红。 支持导入表和导出表的查看，帮助你找到具体的函数依赖。 2. Process Monitor (ProcMon) 简介：Process Monitor 是由Microsoft Sysinternals提供的高级系统监控工具，用于实时跟踪所有文件、注册表操作以及DLL加载情况。它可以在应用程序运行时监控并记录DLL的加载过程。 功能特点： 实时监控DLL加载过程。 详细记录每个DLL的加载路径、状态、加载失败的原因。 支持设置复杂过滤器，聚焦DLL加载相关的操作（如 Load Image）。 适用场景：适合分析程序在运行时加载的DLL，调试缺失或加载失败的DLL，解决动态依赖问题。 下载：Process Monitor - Microsoft 使用方法： 启动ProcMon并设置进程过滤器。 运行目标程序，观察DLL的加载情况。 使用 Load Image 过滤器查看所有DLL加载操作，分析是否有加载失败的DLL。 3. ListDLLs 简介：ListDLLs 是一个轻量级命令行工具，来自Microsoft Sysinternals，用于列出正在运行的进程所加载的所有DLL。它能帮助你快速查看应用程序实际加载了哪些DLL以及这些DLL的路径。 功能特点： 列出所有正在运行的进程所加载的DLL。 显示DLL加载的路径和版本信息。 适用场景：快速查看某个进程当前使用的DLL，排查可能的DLL版本冲突或加载错误。 下载：ListDLLs - Microsoft 使用方法： 在命令行中运行 listdlls.exe [进程名或PID]。 查看该进程加载的所有DLL及其路径，排查问题。 4. CFF Explorer 简介：CFF Explorer 是一个强大的PE文件分析工具，允许你查看Windows可执行文件（如EXE、DLL）的结构和依赖。 功能特点： 允许查看PE文件的导入表和导出表。 分析文件的依赖DLL及其加载路径。 支持编辑PE文件的某些部分。 适用场景：适合需要深入分析可执行文件的PE结构、导入表、导出表及依赖关系的开发者。 下载：CFF Explorer - NTCore 使用方法： 打开CFF Explorer，载入目标可执行文件或DLL。 查看“Import Directory”以获取该文件的DLL依赖。 5. PE Explorer 简介：另一个功能强大的PE文件分析工具，类似于CFF Explorer。它专注于查看可执行文件的依赖和内部结构。 功能特点： 查看导入表、导出表以及依赖DLL。 支持编辑文件内部结构。 适用场景：对PE文件结构进行详细分析，解决复杂的DLL依赖问题。 下载：PE Explorer - Heaventools 6. Sigcheck 简介：Sigcheck 是Sysinternals的另一个工具，主要用于检查文件的数字签名，但它也可以列出文件的依赖DLL及其签名信息，适用于排查潜在的DLL安全问题。 功能特点： 列出文件的依赖DLL及其签名信息。 检查DLL是否未签名或有安全风险。 适用场景：适合用于安全分析，检查应用程序依赖的DLL的签名状态，确保没有不安全的依赖。 下载：Sigcheck - Microsoft 使用方法： 在命令行中运行 sigcheck -e [可执行文件或DLL]。 工具会列出依赖的DLL以及它们的签名状态。 7. DLL Export Viewer 简介：这是一个轻量工具，用于查看DLL文件导出的所有函数，帮助你分析DLL内部函数是否完整或者是否被正确调用。 功能特点： 列出DLL的所有导出函数。 支持保存导出列表。 适用场景：适合检查某些DLL是否缺少导出函数，或者导出函数是否与预期一致。 下载：DLL Export Viewer - NirSoft 8. Nirsoft LoadedDllsView 简介：LoadedDllsView 是来自NirSoft的工具，它可以列出指定进程中加载的所有DLL文件及其完整路径。 功能特点： 列出所有加载的DLL文件及其路径。 支持导出DLL列表为文本文件。 适用场景：类似于ListDLLs，适合查看某个进程加载的DLL，解决加载冲突和依赖问题。 下载：LoadedDllsView - NirSoft 9. LDG (Load Dependency Graph) 简介：LDG 是一个新的工具，专门用于生成可执行文件的依赖关系图，帮助开发者可视化文件与DLL之间的关系。 功能特点： 可视化依赖关系图。 支持生成依赖图的文件输出。 适用场景：适合需要可视化文件依赖的场景，帮助更直观地分析复杂依赖树。 下载：LDG - GitHub 总结 在现代Windows环境中，Dependencies 是当前最适合替代 Dependency Walker 的工具，尤其对于Windows 10的API Set Schema和SxS支持，它具有极佳的处理能力。如果你需要动态分析DLL加载情况，Process Monitor 提供了实时监控功能，适合调试复杂的依赖问题。对于轻量级和特定场景的需求，ListDLLs、Sigcheck、CFF Explorer 等工具则可以快速、有效地帮助你分析问题。\n根据你的具体需求，选择合适的工具可以帮助你更快地找到和解决DLL缺失、加载失败或依赖冲突问题。\n以上都不重要，关键是能用，所以第一步要做的是先上手，后来实际发现Dependencies挺好用的，在其他Windows上运行程序时，如果出现一打开就直接挂掉，那么直接用DependenciesGUI分析一下，一般就能找到是哪个dll缺失，然后再把缺失的dll放到程序运行的目录就能解决了。\n查找exe的所有dll依赖并复制在一起 实际开发过程中，我还产生了一个新的需求：比如我cmake编译的exe，运行时所依赖的dll在哪？我想把这些dll 都放到一起，那么这样在其他Windows上，不就可以运行这个exe了吗？\n我最后使用的是这种方法：\n# PowerShell 脚本：Copy-AllDependencies.ps1 param ( [string]$ExePath, # 可执行文件的路径 [string]$OutputDir # 输出目录的路径 ) # 检查输入参数是否有效 if (-not (Test-Path $ExePath)) { Write-Error \"Error: The specified EXE file does not exist: $ExePath\" exit 1 } if (-not (Test-Path $OutputDir)) { Write-Output \"Output directory does not exist. Creating directory: $OutputDir\" New-Item -Path $OutputDir -ItemType Directory } # 启动进程以获取所有 DLL 依赖项 $process = Start-Process -FilePath $ExePath -PassThru -WindowStyle Hidden # 暂停几秒钟，以便进程加载所有 DLL Start-Sleep -Seconds 2 # 获取所有加载的 DLL $loadedModules = $process.Modules | Where-Object { $_.FileName -like \"*.dll\" } # 复制 EXE 文件到输出目录 Copy-Item -Path $ExePath -Destination $OutputDir -Force Write-Output \"Copied: $(Split-Path -Leaf $ExePath) to $OutputDir\" # 遍历所有找到的 DLL 文件并复制 foreach ($module in $loadedModules) { $dllPath = $module.FileName $dllName = [System.IO.Path]::GetFileName($dllPath) # 构建目标路径 $targetPath = Join-Path -Path $OutputDir -ChildPath $dllName # 复制 DLL 文件到输出目录 try { Copy-Item -Path $dllPath -Destination $targetPath -Force Write-Output \"Copied: $dllName to $OutputDir\" } catch { Write-Warning \"Failed to copy: $dllName\" } } # 检查进程是否仍在运行 if (-not $process.HasExited) { # 尝试结束进程 try { Stop-Process -Id $process.Id -Force Write-Output \"Process terminated: $process.Id\" } catch { Write-Warning \"Could not terminate process: $_\" } } else { Write-Output \"The process has already exited.\" } Write-Output \"All DLL dependencies copied to: $OutputDir\" 或者下面的这种可以重试的写法也行：\nparam ( [string]$ExePath, # 可执行文件的路径 [string]$OutputDir # 输出目录的路径 ) # 检查输入参数是否有效 if (-not (Test-Path $ExePath)) { Write-Error \"Error: The specified EXE file does not exist: $ExePath\" exit 1 } if (-not (Test-Path $OutputDir)) { Write-Output \"Output directory does not exist. Creating directory: $OutputDir\" New-Item -Path $OutputDir -ItemType Directory } # 定义最多尝试的次数 $maxRetries = 3 $retryCount = 0 # 复制 EXE 文件到输出目录 Copy-Item -Path $ExePath -Destination $OutputDir -Force Write-Output \"Copied: $(Split-Path -Leaf $ExePath) to $OutputDir\" # 循环尝试重启进程 do { # 启动进程并确保它在后台运行，防止它被快速终止 $process = Start-Process -FilePath $ExePath -PassThru -WindowStyle Hidden # 暂停几秒钟，以确保 DLL 加载完成 Start-Sleep -Seconds 5 # 检查进程是否仍在运行 if (-not $process.HasExited) { # 获取加载的模块（DLL） $loadedModules = $process.Modules | Where-Object { $_.FileName -like \"*.dll\" } # 遍历所有找到的 DLL 文件并复制 foreach ($module in $loadedModules) { $dllPath = $module.FileName $dllName = [System.IO.Path]::GetFileName($dllPath) # 构建目标路径 $targetPath = Join-Path -Path $OutputDir -ChildPath $dllName # 复制 DLL 文件到输出目录 try { Copy-Item -Path $dllPath -Destination $targetPath -Force Write-Output \"Copied: $dllName to $OutputDir\" } catch { Write-Warning \"Failed to copy: $dllName\" } } # 停止进程 try { Stop-Process -Id $process.Id -Force Write-Output \"Process terminated: $process.Id\" } catch { Write-Warning \"Could not terminate process: $_\" } # 退出循环 break } else { Write-Error \"Error: The process has already exited before capturing dependencies. Retrying...\" $retryCount++ Start-Sleep -Seconds 2 # 等待几秒钟后再试 } } while ($retryCount -lt $maxRetries) if ($retryCount -ge $maxRetries) { Write-Error \"Failed to capture dependencies after multiple attempts.\" } Write-Output \"All DLL dependencies copied to: $OutputDir\" 但是这里有一个关键，程序运行后不能直接退出，所以我在代码里加了一个线程等待，还有一个输入等待，算是一个取巧的做法吧~\n// 延时 10 秒 printf(\"Delay 10 seconds...\\n\"); std::this_thread::sleep_for(std::chrono::seconds(10)); std::cout \u003c\u003c \"Press Enter to continue...\" \u003c\u003c std::endl; std::cin.get(); // 等待用户输入，按下 Enter 键继续 实际情况说明，如果只是输入等待，有时候是不行的，就是程序直接跳出了，什么dll也没复制，所以后面又强行加入了线程等待。\n我是之前没有及时记录，结果发现：确实，都忘了！\n好记性不如好记下啊！！！\nWindows打包安装程序 其实PyInstaller这种打包了就能用，如果缺少什么dll依赖，直接复制放进去就行。\n这种就已经是纯净绿色免安装版了，用起来挺方便，分发的话，进行压缩后就可以。\n但是呢，既然都已经做到这一步了，那就再往前多探一步吧。\n将 .exe 和 .dll 文件打包成安装包形式是软件发布的常见需求，特别是对于Windows平台的应用程序。为了实现这一点，可以使用多种工具来打包和生成安装程序，这些工具可以帮助你将可执行文件、依赖的动态链接库（.dll 文件）、资源文件等一起打包为可安装的格式，如 .msi 或 .exe 安装程序。以下是一些常见且成熟的打包工具，详细说明了它们的功能及适用场景。\n1. Inno Setup 简介：Inno Setup 是一个功能强大且易于使用的免费安装程序创建工具，适用于 Windows 平台。它允许你将应用程序的 .exe、.dll、配置文件等打包为单个 .exe 安装程序。\n主要特点：\n支持将多个文件和目录打包成单个 .exe 安装文件。 支持自定义安装向导界面、许可协议、安装路径等。 提供脚本功能，用于编写复杂的安装逻辑。 支持安装和卸载时的注册表操作、DLL注册等。 适用场景：适合需要简单到中等复杂度的安装包创建需求，适用于个人项目和小型到中型的软件分发。\n使用方法：\n下载 Inno Setup 并安装。 创建 .iss 脚本文件，定义要打包的文件、安装路径等。 使用 Inno Setup 编译生成安装程序。 示例 .iss 文件：\n[Setup] AppName=My Application AppVersion=1.0 DefaultDirName={pf}\\MyApplication OutputBaseFilename=setup Compression=lzma SolidCompression=yes [Files] Source: \"bin\\MyApp.exe\"; DestDir: \"{app}\"; Flags: ignoreversion Source: \"bin\\*.dll\"; DestDir: \"{app}\"; Flags: ignoreversion [Icons] Name: \"{group}\\My Application\"; Filename: \"{app}\\MyApp.exe\" 2. NSIS (Nullsoft Scriptable Install System) 简介：NSIS 是一个非常灵活的开源安装程序创建工具，广泛用于创建 Windows 安装程序。它允许自定义安装逻辑和界面，并支持安装包压缩和多种格式的打包。\n主要特点：\n高度可自定义的安装过程，通过脚本编写安装逻辑。 支持多种安装模式（静默安装、标准安装等）。 内置的压缩算法，能生成体积较小的安装包。 支持多语言安装界面、注册表修改、DLL注册等操作。 适用场景：适用于需要高度定制化安装包的开发者和项目，通常用于大型项目或复杂的安装需求。\n使用方法：\n下载 NSIS 并安装。 创建 .nsi 脚本文件，编写打包逻辑和安装流程。 使用 NSIS 编译器生成安装程序。 示例 .nsi 文件：\nOutFile \"setup.exe\" InstallDir \"$PROGRAMFILES\\MyApp\" Section SetOutPath $INSTDIR File \"bin\\MyApp.exe\" File \"bin\\MyLibrary.dll\" CreateShortcut \"$DESKTOP\\MyApp.lnk\" \"$INSTDIR\\MyApp.exe\" SectionEnd 3. WiX Toolset (Windows Installer XML) 简介：WiX Toolset 是一个用于创建 Windows 安装包的工具集，专注于生成 .msi 文件。它通过 XML 配置文件定义安装逻辑，是一个高度可定制的工具，常用于企业级软件安装包。\n主要特点：\n生成标准的 Windows Installer 安装包（.msi 文件）。 支持复杂的安装方案，包括服务安装、注册表修改、文件权限设置等。 可集成到 CI/CD 管道，适合大型项目的安装包自动化生成。 支持多语言安装、安装时依赖检查等功能。 适用场景：适合大型企业级项目，特别是那些需要生成 .msi 安装包的场景。由于其复杂性，它常用于高级用户和团队开发。\n使用方法：\n下载 WiX Toolset 并安装。 编写 .wxs XML 文件，定义安装包结构和逻辑。 使用 WiX 编译工具生成 .msi 安装包。 示例 .wxs 文件：\n",
  "wordCount" : "33391",
  "inLanguage": "zh",
  "datePublished": "2024-09-24T10:32:02+08:00",
  "dateModified": "2024-09-29T18:14:02+08:00",
  "author":[{
    "@type": "Person",
    "name": "CKYoung"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ahaknow.com/posts/know/dev-python-to-app/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "AhaKnow",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ahaknow.com/Q.gif"
    }
  }
}
</script>
    
    
    
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://ahaknow.com/" accesskey="h" title="AhaKnow (Alt + H)">
                <img src="https://ahaknow.com/Q.gif" alt="" aria-label="logo"
                    height="35">AhaKnow</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://ahaknow.com/search" title="🪄魔法 (Alt &#43; /)" accesskey=/>
                    <span>🪄魔法</span>
                </a>
            </li>
            <li>
                <a href="https://ahaknow.com/" title="🏡主页">
                    <span>🏡主页</span>
                </a>
            </li>
            <li>
                <a href="https://ahaknow.com/posts" title="🚀天天向上">
                    <span>🚀天天向上</span>
                </a>
            </li>
            <li>
                <a href="https://ahaknow.com/archives" title="⏱️时间线">
                    <span>⏱️时间线</span>
                </a>
            </li>
            <li>
                <a href="https://ahaknow.com/tags" title="🏷️标签">
                    <span>🏷️标签</span>
                </a>
            </li>
            <li>
                <a href="https://ahaknow.com/categories" title="🖇归档">
                    <span>🖇归档</span>
                </a>
            </li>
            <li>
                <a href="https://ahaknow.com/toolkits" title="🧰医疗箱">
                    <span>🧰医疗箱</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://ahaknow.com/">🏡主页</a>&nbsp;»&nbsp;<a href="https://ahaknow.com/posts/">🚀 天天向上</a>&nbsp;»&nbsp;<a href="https://ahaknow.com/posts/know/">🌟知识</a></div>
    <h1 class="post-title entry-hint-parent">
      全栈开发：从Python脚本到独立的App（初稿）
    </h1>
    <div class="post-meta">



























<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<span class="parent-post-meta">
        <span id="post_meta_style_1">
            <span class="fa fa-calendar-check-o"></span>
            <span>2024-09-29
                &nbsp;&nbsp;
            </span>
        </span>
        <span id="post_meta_style_2">
        <span class="fa fa-calendar-plus-o"></span>
        <span>2024-09-24
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>33391 字
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>67 分钟
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>CKYoung
            &nbsp;&nbsp;
        </span>
    </span>
</span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">📚目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%89%8d%e8%a8%80" aria-label="前言">前言</a></li>
                <li>
                    <a href="#%e6%95%b4%e4%bd%93%e6%84%9f%e5%8f%97" aria-label="整体感受">整体感受</a></li>
                <li>
                    <a href="#%e5%b7%a5%e5%85%b7%e7%af%87" aria-label="工具篇">工具篇</a><ul>
                        
                <li>
                    <a href="#windows%e4%b8%8a%e7%9a%84cmake%e7%bc%96%e8%af%91" aria-label="Windows上的CMake编译">Windows上的CMake编译</a><ul>
                        
                <li>
                    <a href="#1-%e5%b7%a5%e5%85%b7%e9%93%be%e7%9a%84%e5%b7%ae%e5%bc%82" aria-label="1. 工具链的差异">1. <strong>工具链的差异</strong></a></li>
                <li>
                    <a href="#2-cmake-%e4%b8%8e-make-%e7%9a%84%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="2. CMake 与 Make 的工作原理">2. <strong>CMake 与 Make 的工作原理</strong></a></li>
                <li>
                    <a href="#3-%e7%bc%96%e8%af%91%e5%99%a8%e7%9a%84%e5%b7%ae%e5%bc%82" aria-label="3. 编译器的差异">3. <strong>编译器的差异</strong></a></li>
                <li>
                    <a href="#4-make-%e4%b8%8e-nmake-%e7%9a%84%e5%8c%ba%e5%88%ab" aria-label="4. Make 与 NMake 的区别">4. <strong>Make 与 NMake 的区别</strong></a></li>
                <li>
                    <a href="#5-%e8%b7%a8%e5%b9%b3%e5%8f%b0%e5%85%bc%e5%ae%b9%e5%b7%a5%e5%85%b7" aria-label="5. 跨平台兼容工具">5. <strong>跨平台兼容工具</strong></a></li>
                <li>
                    <a href="#6-windows-subsystem-for-linux-wsl" aria-label="6. Windows Subsystem for Linux (WSL)">6. <strong>Windows Subsystem for Linux (WSL)</strong></a></li>
                <li>
                    <a href="#7-%e4%b8%8d%e7%94%a8visual-studio%e5%8f%af%e4%bb%a5%e5%90%97" aria-label="7. 不用Visual Studio可以吗？">7. <strong>不用Visual Studio可以吗？</strong></a></li>
                <li>
                    <a href="#8-%e6%80%bb%e7%bb%93" aria-label="8. 总结">8. <strong>总结</strong></a></li></ul>
                </li>
                <li>
                    <a href="#using-msys2-and-pacman-for-installing-dependencies" aria-label="Using MSYS2 and Pacman for Installing Dependencies"><strong>Using MSYS2 and Pacman for Installing Dependencies</strong></a><ul>
                        
                <li>
                    <a href="#1-introduction-to-msys2-and-pacman" aria-label="1. Introduction to MSYS2 and Pacman">1. <strong>Introduction to MSYS2 and Pacman</strong></a></li>
                <li>
                    <a href="#2-step-by-step-installation-and-setup" aria-label="2. Step-by-Step Installation and Setup">2. <strong>Step-by-Step Installation and Setup</strong></a><ul>
                        
                <li>
                    <a href="#21-download-and-install-msys2" aria-label="2.1 Download and Install MSYS2">2.1 <strong>Download and Install MSYS2</strong></a></li>
                <li>
                    <a href="#22-update-pacman-and-system" aria-label="2.2 Update Pacman and System">2.2 <strong>Update Pacman and System</strong></a></li>
                <li>
                    <a href="#23-install-essential-development-tools" aria-label="2.3 Install Essential Development Tools">2.3 <strong>Install Essential Development Tools</strong></a></li>
                <li>
                    <a href="#24-using-pacman-to-search-and-install-packages" aria-label="2.4 Using Pacman to Search and Install Packages">2.4 <strong>Using Pacman to Search and Install Packages</strong></a></li>
                <li>
                    <a href="#25-check-installed-packages" aria-label="2.5 Check Installed Packages">2.5 <strong>Check Installed Packages</strong></a></li>
                <li>
                    <a href="#26-compiling-code-using-mingw-in-msys2" aria-label="2.6 Compiling Code Using MinGW in MSYS2">2.6 <strong>Compiling Code Using MinGW in MSYS2</strong></a></li>
                <li>
                    <a href="#27-using-msys2-shells" aria-label="2.7 Using MSYS2 Shells">2.7 <strong>Using MSYS2 Shells</strong></a></li></ul>
                </li>
                <li>
                    <a href="#3-conclusion" aria-label="3. Conclusion">3. <strong>Conclusion</strong></a></li></ul>
                </li>
                <li>
                    <a href="#python%e6%89%93%e5%8c%85exe" aria-label="Python打包exe">Python打包exe</a><ul>
                        
                <li>
                    <a href="#1-pyinstaller" aria-label="1. PyInstaller">1. <strong>PyInstaller</strong></a></li>
                <li>
                    <a href="#2-cx_freeze" aria-label="2. cx_Freeze">2. <strong>cx_Freeze</strong></a></li>
                <li>
                    <a href="#3-py2exe" aria-label="3. Py2exe">3. <strong>Py2exe</strong></a></li>
                <li>
                    <a href="#4-nuitka" aria-label="4. Nuitka">4. <strong>Nuitka</strong></a></li>
                <li>
                    <a href="#5-pyoxidizer" aria-label="5. PyOxidizer">5. <strong>PyOxidizer</strong></a></li>
                <li>
                    <a href="#6-briefcase" aria-label="6. Briefcase">6. <strong>Briefcase</strong></a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%99%85%e4%bd%bf%e7%94%a8%e7%9a%84%e4%be%8b%e5%ad%90" aria-label="实际使用的例子">实际使用的例子</a></li></ul>
                </li>
                <li>
                    <a href="#windows%e7%9a%84dll%e5%88%86%e6%9e%90%e5%b7%a5%e5%85%b7" aria-label="Windows的dll分析工具">Windows的dll分析工具</a><ul>
                        
                <li>
                    <a href="#1-dependencies-lucasgdependencies" aria-label="1. Dependencies (lucasg/Dependencies)">1. <strong>Dependencies (lucasg/Dependencies)</strong></a></li>
                <li>
                    <a href="#2-process-monitor-procmon" aria-label="2. Process Monitor (ProcMon)">2. <strong>Process Monitor (ProcMon)</strong></a></li>
                <li>
                    <a href="#3-listdlls" aria-label="3. ListDLLs">3. <strong>ListDLLs</strong></a></li>
                <li>
                    <a href="#4-cff-explorer" aria-label="4. CFF Explorer">4. <strong>CFF Explorer</strong></a></li>
                <li>
                    <a href="#5-pe-explorer" aria-label="5. PE Explorer">5. <strong>PE Explorer</strong></a></li>
                <li>
                    <a href="#6-sigcheck" aria-label="6. Sigcheck">6. <strong>Sigcheck</strong></a></li>
                <li>
                    <a href="#7-dll-export-viewer" aria-label="7. DLL Export Viewer">7. <strong>DLL Export Viewer</strong></a></li>
                <li>
                    <a href="#8-nirsoft-loadeddllsview" aria-label="8. Nirsoft LoadedDllsView">8. <strong>Nirsoft LoadedDllsView</strong></a></li>
                <li>
                    <a href="#9-ldg-load-dependency-graph" aria-label="9. LDG (Load Dependency Graph)">9. <strong>LDG (Load Dependency Graph)</strong></a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-1" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%9f%a5%e6%89%beexe%e7%9a%84%e6%89%80%e6%9c%89dll%e4%be%9d%e8%b5%96%e5%b9%b6%e5%a4%8d%e5%88%b6%e5%9c%a8%e4%b8%80%e8%b5%b7" aria-label="查找exe的所有dll依赖并复制在一起">查找exe的所有dll依赖并复制在一起</a></li>
                <li>
                    <a href="#windows%e6%89%93%e5%8c%85%e5%ae%89%e8%a3%85%e7%a8%8b%e5%ba%8f" aria-label="Windows打包安装程序">Windows打包安装程序</a><ul>
                        
                <li>
                    <a href="#1-inno-setup" aria-label="1. Inno Setup">1. <strong>Inno Setup</strong></a></li>
                <li>
                    <a href="#2-nsis-nullsoft-scriptable-install-system" aria-label="2. NSIS (Nullsoft Scriptable Install System)">2. <strong>NSIS (Nullsoft Scriptable Install System)</strong></a></li>
                <li>
                    <a href="#3-wix-toolset-windows-installer-xml" aria-label="3. WiX Toolset (Windows Installer XML)">3. <strong>WiX Toolset (Windows Installer XML)</strong></a></li>
                <li>
                    <a href="#4-advanced-installer" aria-label="4. Advanced Installer">4. <strong>Advanced Installer</strong></a></li>
                <li>
                    <a href="#5-installshield" aria-label="5. InstallShield">5. <strong>InstallShield</strong></a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-2" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%be%e5%bd%a2%e5%8c%96ui" aria-label="图形化UI">图形化UI</a><ul>
                        
                <li>
                    <a href="#1-tkinter" aria-label="1. Tkinter">1. <strong>Tkinter</strong></a></li>
                <li>
                    <a href="#2-pyqt" aria-label="2. PyQt">2. <strong>PyQt</strong></a></li>
                <li>
                    <a href="#3-pyside-qt-for-python" aria-label="3. PySide (Qt for Python)">3. <strong>PySide (Qt for Python)</strong></a></li>
                <li>
                    <a href="#4-kivy" aria-label="4. Kivy">4. <strong>Kivy</strong></a></li>
                <li>
                    <a href="#5-wxpython" aria-label="5. wxPython">5. <strong>wxPython</strong></a></li>
                <li>
                    <a href="#6-dear-pygui" aria-label="6. Dear PyGui">6. <strong>Dear PyGui</strong></a></li>
                <li>
                    <a href="#7-flask--electron-%e6%88%96-flask--pywebview" aria-label="7. Flask &#43; Electron (或 Flask &#43; Pywebview)">7. <strong>Flask + Electron (或 Flask + Pywebview)</strong></a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-3" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#node%e5%92%8cnpm%e5%88%b0%e5%ba%95%e6%98%af%e4%b8%aa%e4%bb%80%e4%b9%88%e4%b8%9c%e8%a5%bf" aria-label="Node和npm到底是个什么东西？">Node和npm到底是个什么东西？</a><ul>
                        
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-nodejs-%e5%92%8c-npm" aria-label="什么是 Node.js 和 npm？"><strong>什么是 Node.js 和 npm？</strong></a></li>
                <li>
                    <a href="#npm-run-%e4%bb%a5%e5%8f%8a%e4%b8%8e-nodejs-%e7%9a%84%e5%85%b3%e7%b3%bb" aria-label="npm run 以及与 Node.js 的关系"><strong><code>npm run</code> 以及与 Node.js 的关系</strong></a></li>
                <li>
                    <a href="#%e7%90%86%e8%ae%ba%e4%b8%8a%e8%ae%b2%e4%b8%8d%e4%be%9d%e8%b5%96-nodejs-%e5%92%8c-npm-%e5%8f%af%e4%bb%a5%e8%bf%90%e8%a1%8c-web-%e5%ba%94%e7%94%a8" aria-label="理论上讲，不依赖 Node.js 和 npm 可以运行 Web 应用？"><strong>理论上讲，不依赖 Node.js 和 npm 可以运行 Web 应用？</strong></a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%99%85%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af%e5%af%b9%e6%af%94" aria-label="实际使用场景对比"><strong>实际使用场景对比</strong></a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-4" aria-label="总结"><strong>总结</strong></a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-python-%e5%90%af%e5%8a%a8-html-%e5%ba%94%e7%94%a8" aria-label="使用 Python 启动 HTML 应用">使用 Python 启动 HTML 应用</a></li>
                <li>
                    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-cors-cross-origin-resource-sharing" aria-label="什么是 CORS (Cross-Origin Resource Sharing)?"><strong>什么是 CORS (Cross-Origin Resource Sharing)?</strong></a><ul>
                        
                <li>
                    <a href="#cors-%e9%97%ae%e9%a2%98%e7%9a%84%e8%a7%a6%e5%8f%91%e6%9d%a1%e4%bb%b6" aria-label="CORS 问题的触发条件："><strong>CORS 问题的触发条件</strong>：</a></li>
                <li>
                    <a href="#%e5%b8%b8%e8%a7%81%e7%9a%84-cors-%e9%94%99%e8%af%af%e4%bf%a1%e6%81%af" aria-label="常见的 CORS 错误信息："><strong>常见的 CORS 错误信息</strong>：</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3-cors-%e9%97%ae%e9%a2%98" aria-label="如何解决 CORS 问题？"><strong>如何解决 CORS 问题？</strong></a><ul>
                        
                <li>
                    <a href="#1-%e6%9c%8d%e5%8a%a1%e7%ab%af%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e6%8e%a8%e8%8d%90%e6%96%b9%e5%bc%8f" aria-label="1. 服务端解决方案（推荐方式）">1. <strong>服务端解决方案（推荐方式）</strong></a></li>
                <li>
                    <a href="#2-%e4%bd%bf%e7%94%a8%e5%89%8d%e7%ab%af%e4%bb%a3%e7%90%86%e8%a7%a3%e5%86%b3-cors" aria-label="2. 使用前端代理解决 CORS">2. <strong>使用前端代理解决 CORS</strong></a></li>
                <li>
                    <a href="#3-%e5%9c%a8%e6%b5%8f%e8%a7%88%e5%99%a8%e4%b8%ad%e7%a6%81%e7%94%a8-cors%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83%e4%b8%ad%e4%b8%8d%e6%8e%a8%e8%8d%90%e7%94%a8%e4%ba%8e%e7%94%9f%e4%ba%a7" aria-label="3. 在浏览器中禁用 CORS（开发环境中，不推荐用于生产）">3. <strong>在浏览器中禁用 CORS（开发环境中，不推荐用于生产）</strong></a></li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93-5" aria-label="总结"><strong>总结</strong></a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%bb%a3%e7%a0%81%e8%ae%b0%e5%bd%95" aria-label="代码记录">代码记录</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8pyqt" aria-label="使用PyQT">使用PyQT</a></li>
                <li>
                    <a href="#%e4%b9%8b%e5%89%8d%e4%bd%bf%e7%94%a8tk%e7%9a%84%e6%96%b9%e5%bc%8f" aria-label="之前使用tk的方式">之前使用tk的方式</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8qt%e4%b9%8b%e5%90%8e%e7%9a%84main%e5%87%bd%e6%95%b0%e5%86%99%e6%b3%95" aria-label="使用QT之后的main函数写法">使用QT之后的main函数写法</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8tk%e6%97%b6%e6%b2%a1%e6%9c%89%e9%82%a3%e4%b9%88%e5%a4%8d%e6%9d%82%e7%9a%84main%e5%87%bd%e6%95%b0%e5%86%99%e6%b3%95" aria-label="使用tk时没有那么复杂的main函数写法">使用tk时没有那么复杂的main函数写法</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87python%e6%89%93%e5%bc%80%e5%90%abjs%e7%bd%91%e9%a1%b5%e7%9a%84%e5%86%99%e6%b3%95" aria-label="通过python打开含js网页的写法">通过python打开含js网页的写法</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
  <div class="post-content"><h2 id="前言">前言<a hidden class="anchor" aria-hidden="true" href="#前言">#</a></h2>
<p><mark>怎么样从一个Python脚本一步一步变成一个可以在多平台上独立使用的App呢？</mark></p>
<p>在这一部分之前，是改进和优化Python的训练脚本，其中涉及到很多知识点，也有很多心得和体悟，这些需要之后总结补充。</p>
<p>不记录，肯定是会忘记的，以前干了很多次这样的事，到最后就只剩下一个标题，内容啥的完全想不起来了，所以要实时记录，时常温习。</p>
<p>教，也是一种学习；输出，温故而知新。</p>
<p><img loading="lazy" src="../images/mindcloud-renderer" alt="mindcloud-renderer"  />
</p>
<h2 id="整体感受">整体感受<a hidden class="anchor" aria-hidden="true" href="#整体感受">#</a></h2>
<p>想要把一个Python的脚本转换成一个App，比如在Windows平台上双击即可使用的exe程序，怎么做呢？</p>
<ul>
<li>首先，应该是有成熟的工具可以直接使用的，所以先收集信息看看有哪些，做一个整体的了解；</li>
<li>然后，做成App后，需要有交互，并且是基于图形界面的交互（GUI），因此就不能再是简单粗暴的命令行传递参数了；</li>
<li>再者，在设计时，要考虑美观，也要考虑用户体验，因此有很多细节上的需要注意，同时很多功能逻辑上的严谨也需要顾及；</li>
</ul>
<p>这么来看，在一开始想做的时候，心里大概是有一个数的，<strong>知道一步一步分解之后需要怎么做，也能够凭借已有的经验来预估哪些逻辑需要设计</strong>，从这一点呢，其实也能学到一个好用的技巧（虽然这个道理以前就已经知道了）：</p>
<ul>
<li>拿一张白纸或者一面白板，一步一步写列出思路和提纲，具体往后做的时候就不怕自己脑子里给忘掉了；</li>
<li>而且一旦有灵感之后，还能直接补充到这个白纸或者白板上，<mark>有时候就需要这种外置的记忆，想到了就记下来很重要</mark>；</li>
<li>不应该纠结于工具本身，而应该落实在具体的做上面；</li>
<li>一次性想明白所有当然是最好的，但更多的时候可能是，一边做，一边更新迭代。</li>
</ul>
<p>那现在开始做吧！</p>
<h2 id="工具篇">工具篇<a hidden class="anchor" aria-hidden="true" href="#工具篇">#</a></h2>
<h3 id="windows上的cmake编译">Windows上的CMake编译<a hidden class="anchor" aria-hidden="true" href="#windows上的cmake编译">#</a></h3>
<p>好像是晕到死（Windows）要配合Visual Studio开发打包，但我就是不信这个邪，因为在Linux平台上就是一行命令就能解决的事，凭啥到Windows上要搞一套臃肿的软件呢？！</p>
<p>确实，想要在Windows上实现cmake+make，很难，但不是不可能！</p>
<p>首先也是收集了一些信息：</p>
<blockquote>
<p>在Windows上使用 <strong>CMake</strong> 和 <strong>make</strong> 通常比在Linux上更复杂，这是由于两者的架构和工具链有根本性的差异。以下是Windows与Linux在构建系统方面的不同之处，以及为什么在Windows上不能像在Linux上直接运行 <code>cmake</code> 和 <code>make</code>。</p>
<h4 id="1-工具链的差异">1. <strong>工具链的差异</strong><a hidden class="anchor" aria-hidden="true" href="#1-工具链的差异">#</a></h4>
<ul>
<li>
<p><strong>Linux</strong>：Linux系统有一个非常标准化的开发环境，几乎所有发行版都预装了GNU工具链，包括<code>gcc</code>编译器和<code>make</code>构建工具。因此，开发人员只需要安装一些基本的开发工具包（如<code>build-essential</code>）即可轻松编译C/C++程序。 <code>CMake</code> 作为跨平台的构建系统，能生成Makefile，然后通过 <code>make</code> 工具来进行编译、链接等任务。</p>
</li>
<li>
<p><strong>Windows</strong>：Windows系统没有预装类似于Linux的GNU工具链，而是主要依赖于<strong>Microsoft Visual Studio</strong> 和 <strong>MSVC</strong> 编译器（Microsoft Visual C++）。Windows的开发环境与Linux存在本质区别，没有默认的标准构建工具如 <code>make</code>。因此，要在Windows上使用CMake生成和构建项目，通常需要依赖Visual Studio或第三方工具。</p>
</li>
</ul>
<h4 id="2-cmake-与-make-的工作原理">2. <strong>CMake 与 Make 的工作原理</strong><a hidden class="anchor" aria-hidden="true" href="#2-cmake-与-make-的工作原理">#</a></h4>
<ul>
<li><strong>CMake</strong> 是一个跨平台的构建系统生成工具，但它本身并不执行编译或构建工作。CMake 的任务是根据项目配置文件（<code>CMakeLists.txt</code>）生成相应平台的构建文件，例如：
<ul>
<li><strong>Linux</strong>：CMake 通常生成 <code>Makefile</code>，然后通过 <code>make</code> 进行构建。</li>
<li><strong>Windows</strong>：CMake 通常生成 <strong>Visual Studio项目文件</strong> 或 <strong>NMake Makefiles</strong>。Visual Studio 是 Windows 上常用的编译器和构建环境，NMake 是Windows下的一种 <code>make</code> 工具，虽然和GNU <code>make</code> 不完全兼容，但功能类似。</li>
</ul>
</li>
</ul>
<p>因此，CMake 在Windows上默认生成Visual Studio解决方案文件 (<code>.sln</code>) 或者 <code>NMake Makefiles</code>，而不是传统的GNU <code>Makefile</code>。</p>
<h4 id="3-编译器的差异">3. <strong>编译器的差异</strong><a hidden class="anchor" aria-hidden="true" href="#3-编译器的差异">#</a></h4>
<ul>
<li>
<p><strong>Linux</strong>：Linux系统广泛使用GNU编译器（<code>gcc</code>、<code>g++</code>）和 <code>clang</code>，并且这些工具能够直接与<code>make</code>等构建工具配合工作。编译器和构建工具可以通过统一的方式来调用，CMake也支持生成 <code>Makefile</code> 并与 <code>gcc</code> 配合使用。</p>
</li>
<li>
<p><strong>Windows</strong>：Windows的默认编译器是 <strong>MSVC</strong>，它的命令行工具（如 <code>cl.exe</code>、<code>link.exe</code>）与GNU工具链有较大区别。Windows上并没有内置的 <code>gcc</code> 或 <code>clang</code>，这意味着如果不使用Visual Studio，开发人员需要手动安装并配置编译器（如 <strong>MinGW-w64</strong> 或 <strong>Cygwin</strong>）和构建工具（如 <strong>MSYS2</strong>）来提供GNU工具链的支持。</p>
</li>
</ul>
<h4 id="4-make-与-nmake-的区别">4. <strong>Make 与 NMake 的区别</strong><a hidden class="anchor" aria-hidden="true" href="#4-make-与-nmake-的区别">#</a></h4>
<ul>
<li><strong>GNU Make</strong>：这是Linux上的默认构建工具，结合<code>Makefile</code>进行依赖管理和构建过程。它与GNU工具链高度集成。</li>
<li><strong>NMake</strong>：这是微软提供的 <code>make</code> 工具，专为Windows开发环境设计，通常与MSVC配合使用。虽然NMake的基本功能类似于GNU Make，但它的语法和行为与GNU Make有所不同，NMake不能直接使用GNU风格的Makefile。</li>
</ul>
<h4 id="5-跨平台兼容工具">5. <strong>跨平台兼容工具</strong><a hidden class="anchor" aria-hidden="true" href="#5-跨平台兼容工具">#</a></h4>
<p>如果不想使用Visual Studio，可以在Windows上通过安装GNU工具链来实现类似Linux的构建体验：</p>
<ul>
<li><strong>MinGW-w64</strong>：提供了Windows上的GNU编译工具链（<code>gcc</code> 和 <code>g++</code>），并且能够与 <code>CMake</code> 配合使用生成 GNU <code>Makefile</code>，然后可以使用 <code>make</code> 进行构建。MinGW-w64 使你可以在Windows上使用类似Linux的编译环境。</li>
<li><strong>MSYS2</strong>：这是一个兼容性更强的环境，基于MinGW和Cygwin，允许在Windows上运行许多Linux工具，包括 <code>bash</code>、<code>gcc</code>、<code>make</code> 等。MSYS2提供了一个接近Linux的终端环境，可以通过CMake生成GNU <code>Makefile</code>，然后使用GNU <code>make</code> 来编译项目。</li>
<li><strong>Cygwin</strong>：Cygwin 提供了类似于Linux的环境，支持使用 <code>gcc</code> 和 <code>make</code> 进行开发，但其模拟层较重，性能不如MinGW，并且有时会引入一些额外的兼容性问题。</li>
</ul>
<h4 id="6-windows-subsystem-for-linux-wsl">6. <strong>Windows Subsystem for Linux (WSL)</strong><a hidden class="anchor" aria-hidden="true" href="#6-windows-subsystem-for-linux-wsl">#</a></h4>
<p><strong>Windows Subsystem for Linux (WSL)</strong> 提供了一个原生的Linux子系统，允许在Windows上运行Linux二进制程序。你可以在WSL中直接使用 <code>CMake</code> 和 <code>make</code>，因为WSL是一个完整的Linux环境，使用Ubuntu等发行版，你可以完全按照Linux的开发流程进行操作，而无需安装Visual Studio或其他工具链。</p>
<p><strong>使用WSL的步骤</strong>：</p>
<ol>
<li>安装WSL和Linux发行版（如Ubuntu）。</li>
<li>在WSL中安装 <code>build-essential</code> 包，包含 <code>gcc</code>、<code>make</code> 等工具。</li>
<li>在WSL中运行 <code>cmake</code> 和 <code>make</code> 完成项目的构建。</li>
</ol>
<h4 id="7-不用visual-studio可以吗">7. <strong>不用Visual Studio可以吗？</strong><a hidden class="anchor" aria-hidden="true" href="#7-不用visual-studio可以吗">#</a></h4>
<ul>
<li><strong>答案是可以</strong>，但需要选择合适的工具链。你可以通过以下方式在Windows上避免使用Visual Studio：
<ol>
<li><strong>使用MinGW-w64</strong> 或 <strong>MSYS2</strong> 来提供GNU工具链，配合CMake生成GNU <code>Makefile</code>，然后使用 <code>make</code> 进行编译。</li>
<li><strong>使用WSL</strong>，直接在Windows中运行Linux的CMake和Make工具。</li>
<li><strong>使用NMake</strong>，如果仍然想使用MSVC编译器，但不希望依赖Visual Studio IDE，CMake也可以生成适用于NMake的Makefile。</li>
</ol>
</li>
</ul>
<h4 id="8-总结">8. <strong>总结</strong><a hidden class="anchor" aria-hidden="true" href="#8-总结">#</a></h4>
<ul>
<li>Windows和Linux在构建系统上的差异主要体现在工具链和编译器上。Linux拥有标准的GNU工具链和 <code>make</code>，而Windows默认使用Visual Studio和MSVC编译器，导致在Windows上开发时，通常需要依赖Visual Studio或其他第三方工具。</li>
<li>如果你不想使用Visual Studio，可以通过安装MinGW-w64、MSYS2、Cygwin或WSL来获得类似于Linux的开发体验，在Windows上直接使用 <code>cmake</code> 和 <code>make</code>。</li>
</ul>
</blockquote>
<p>实际尝试后发现：</p>
<ol>
<li>MSYS2是个好东西，通过设置Path可以在PowerShell中使用，但单独使用MSYS2自带的终端会更好用，因为完全是类Unix风格；</li>
<li>MSYS2安装的时候应该是自带MinGW的；</li>
<li>MinGW也能单独安装，但好像安装完不知道咋用才好。</li>
</ol>
<p>用到最后发现核心是这两句：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cmake -DCMAKE_PREFIX_PATH<span class="o">=</span><span class="s2">&#34;C:/msys64/mingw64&#34;</span> -G <span class="s2">&#34;MinGW Makefiles&#34;</span> .. -Wno-dev    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mingw32-make 
</span></span></code></pre></div><p>以及对于各种依赖和安装包，可以通过pacman来安装，这个其实就是arch linux上面那套，虽然可能没有apt那么完全。</p>
<p><mark>然后，我发现今天新点亮了一颗技能点，就是在使用搜索时，可以同时回答中英文，甚至加上一些调皮的话，比如下面这样的：</mark></p>
<blockquote>
<p>Got it! Let&rsquo;s create a detailed guide on using <strong>MSYS2</strong> and <strong>pacman</strong>, which will include the steps for setting up the environment and using <strong>pacman</strong> to install dependencies efficiently. I&rsquo;ll provide the instructions in both <strong>English</strong> and <strong>Chinese</strong> for each step, as requested. 😊</p>
<hr>
<h3 id="using-msys2-and-pacman-for-installing-dependencies"><strong>Using MSYS2 and Pacman for Installing Dependencies</strong><a hidden class="anchor" aria-hidden="true" href="#using-msys2-and-pacman-for-installing-dependencies">#</a></h3>
<p><strong>在 MSYS2 中使用 Pacman 安装依赖</strong></p>
<h4 id="1-introduction-to-msys2-and-pacman">1. <strong>Introduction to MSYS2 and Pacman</strong><a hidden class="anchor" aria-hidden="true" href="#1-introduction-to-msys2-and-pacman">#</a></h4>
<p><strong>MSYS2 和 Pacman 介绍</strong></p>
<ul>
<li>
<p><strong>MSYS2</strong> is a powerful platform that brings a Unix-like environment to Windows. It provides a complete package management system through <strong>pacman</strong> (the same package manager used in Arch Linux) to install and manage software and libraries easily.</p>
<p><strong>MSYS2</strong> 是一个强大的平台，它为 Windows 带来了类似 Unix 的环境。它通过 <strong>pacman</strong> 提供了一个完整的包管理系统（与 Arch Linux 相同的包管理工具），可以轻松安装和管理软件和库。</p>
</li>
<li>
<p><strong>Pacman</strong> allows you to quickly install packages and manage dependencies. Instead of manually compiling software from source, you can use <code>pacman</code> to install pre-built binaries, making the setup process much smoother.</p>
<p><strong>Pacman</strong> 允许你快速安装软件包并管理依赖项。与手动从源代码编译软件相比，你可以使用 <code>pacman</code> 安装预编译的二进制文件，这使得设置过程更加顺畅。</p>
</li>
</ul>
<h4 id="2-step-by-step-installation-and-setup">2. <strong>Step-by-Step Installation and Setup</strong><a hidden class="anchor" aria-hidden="true" href="#2-step-by-step-installation-and-setup">#</a></h4>
<p><strong>分步安装和设置</strong></p>
<h5 id="21-download-and-install-msys2">2.1 <strong>Download and Install MSYS2</strong><a hidden class="anchor" aria-hidden="true" href="#21-download-and-install-msys2">#</a></h5>
<p><strong>下载并安装 MSYS2</strong></p>
<ol>
<li>
<p>Go to the <a href="https://www.msys2.org/">official MSYS2 website</a> and download the installer for Windows.<br>
访问 <a href="https://www.msys2.org/">MSYS2 官网</a> 并下载适用于 Windows 的安装程序。</p>
</li>
<li>
<p>Run the installer and follow the default installation path (<code>C:\msys64</code> is recommended).<br>
运行安装程序，并选择默认的安装路径（推荐使用 <code>C:\msys64</code>）。</p>
</li>
</ol>
<h5 id="22-update-pacman-and-system">2.2 <strong>Update Pacman and System</strong><a hidden class="anchor" aria-hidden="true" href="#22-update-pacman-and-system">#</a></h5>
<p><strong>更新 Pacman 和系统</strong></p>
<p>After installation, you need to update the package database and core packages to ensure you’re working with the latest versions.<br>
安装完成后，需要更新包数据库和核心包，以确保你使用的是最新版本。</p>
<ol>
<li>
<p>Open <strong>MSYS2</strong> (either from the Start menu or from the installation folder).<br>
打开 <strong>MSYS2</strong>（可以通过开始菜单或从安装文件夹打开）。</p>
</li>
<li>
<p>Run the following command to update the package database and the core system:<br>
运行以下命令以更新包数据库和核心系统：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -Syu
</span></span></code></pre></div><blockquote>
<p>You may need to close and reopen MSYS2 to continue the update.<br>
你可能需要关闭并重新打开 MSYS2 来继续更新。</p>
</blockquote>
</li>
<li>
<p>After reopening, run the update again to ensure everything is up to date:<br>
重新打开后，再次运行更新命令以确保所有内容都是最新的：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -Su
</span></span></code></pre></div></li>
</ol>
<h5 id="23-install-essential-development-tools">2.3 <strong>Install Essential Development Tools</strong><a hidden class="anchor" aria-hidden="true" href="#23-install-essential-development-tools">#</a></h5>
<p><strong>安装必要的开发工具</strong></p>
<p>You can install key development tools like GCC, G++, make, and CMake using pacman.<br>
你可以通过 pacman 安装关键的开发工具，如 GCC、G++、make 和 CMake。</p>
<ol>
<li>
<p>To install the 64-bit toolchain (for compiling 64-bit applications):<br>
安装 64 位工具链（用于编译 64 位应用程序）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -S mingw-w64-x86_64-toolchain
</span></span></code></pre></div></li>
<li>
<p>To install CMake (a common build system generator):<br>
安装 CMake（一个常用的构建系统生成器）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -S mingw-w64-x86_64-cmake
</span></span></code></pre></div></li>
<li>
<p>To install other useful tools (such as Git or Python):<br>
安装其他有用的工具（如 Git 或 Python）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -S git python
</span></span></code></pre></div></li>
</ol>
<h5 id="24-using-pacman-to-search-and-install-packages">2.4 <strong>Using Pacman to Search and Install Packages</strong><a hidden class="anchor" aria-hidden="true" href="#24-using-pacman-to-search-and-install-packages">#</a></h5>
<p><strong>使用 Pacman 搜索并安装软件包</strong></p>
<ul>
<li>
<p>To search for a package:<br>
搜索软件包：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -Ss &lt;package-name&gt;
</span></span></code></pre></div><p>Example:<br>
例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -Ss cmake
</span></span></code></pre></div></li>
<li>
<p>To install a package:<br>
安装软件包：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -S &lt;package-name&gt;
</span></span></code></pre></div><p>Example:<br>
例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -S mingw-w64-x86_64-cmake
</span></span></code></pre></div></li>
<li>
<p>To remove a package:<br>
删除软件包：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -R &lt;package-name&gt;
</span></span></code></pre></div></li>
</ul>
<h5 id="25-check-installed-packages">2.5 <strong>Check Installed Packages</strong><a hidden class="anchor" aria-hidden="true" href="#25-check-installed-packages">#</a></h5>
<p><strong>检查已安装的软件包</strong></p>
<p>To list all installed packages, run:<br>
要列出所有已安装的软件包，运行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -Q
</span></span></code></pre></div><h5 id="26-compiling-code-using-mingw-in-msys2">2.6 <strong>Compiling Code Using MinGW in MSYS2</strong><a hidden class="anchor" aria-hidden="true" href="#26-compiling-code-using-mingw-in-msys2">#</a></h5>
<p><strong>在 MSYS2 中使用 MinGW 编译代码</strong></p>
<p>Once you’ve installed the MinGW toolchain, you can compile C/C++ code using the standard tools like <code>gcc</code> and <code>g++</code>.<br>
一旦你安装了 MinGW 工具链，你就可以使用 <code>gcc</code> 和 <code>g++</code> 等标准工具编译 C/C++ 代码。</p>
<ul>
<li>
<p>To compile a C++ file:<br>
编译 C++ 文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">g++ -o output main.cpp
</span></span></code></pre></div></li>
<li>
<p>To use CMake for a project:<br>
使用 CMake 进行项目构建：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir build
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> build
</span></span><span class="line"><span class="cl">cmake -G <span class="s2">&#34;MSYS Makefiles&#34;</span> ..
</span></span><span class="line"><span class="cl">make
</span></span></code></pre></div></li>
</ul>
<h5 id="27-using-msys2-shells">2.7 <strong>Using MSYS2 Shells</strong><a hidden class="anchor" aria-hidden="true" href="#27-using-msys2-shells">#</a></h5>
<p><strong>使用 MSYS2 Shell</strong></p>
<p>MSYS2 provides different shells for different purposes. The most common shells are:</p>
<ul>
<li><strong>MSYS2 Shell</strong>: For using Unix-like tools but not for compiling Windows applications.</li>
<li><strong>MinGW 64-bit Shell</strong>: For compiling 64-bit Windows applications using MinGW-w64.</li>
<li><strong>MinGW 32-bit Shell</strong>: For compiling 32-bit Windows applications.</li>
</ul>
<p><strong>MSYS2 提供了不同用途的 Shell。常见的 Shell 有：</strong></p>
<ul>
<li><strong>MSYS2 Shell</strong>：用于使用类 Unix 工具，但不适合编译 Windows 应用程序。</li>
<li><strong>MinGW 64-bit Shell</strong>：用于使用 MinGW-w64 编译 64 位 Windows 应用程序。</li>
<li><strong>MinGW 32-bit Shell</strong>：用于编译 32 位 Windows 应用程序。</li>
</ul>
<p>Make sure you open the correct shell depending on what you&rsquo;re building.<br>
确保你根据要构建的内容打开正确的 Shell。</p>
<hr>
<h4 id="3-conclusion">3. <strong>Conclusion</strong><a hidden class="anchor" aria-hidden="true" href="#3-conclusion">#</a></h4>
<p><strong>总结</strong></p>
<p><strong>MSYS2</strong> combined with <strong>pacman</strong> provides a powerful and convenient development environment on Windows, bringing the simplicity of package management and tool installation from Linux-like systems. By using pacman, you can quickly install dependencies and libraries without the need to manually compile them from source unless absolutely necessary.</p>
<p><strong>MSYS2</strong> 与 <strong>pacman</strong> 相结合，为 Windows 提供了一个强大且方便的开发环境，带来了类似 Linux 系统的包管理和工具安装的简便性。通过使用 pacman，你可以快速安装依赖和库，除非万不得已，否则不需要手动从源代码编译。</p>
<p>With this guide, you should now be able to install and configure MSYS2, use pacman to manage packages, and set up a working development environment.<br>
通过本指南，你现在应该能够安装和配置 MSYS2，使用 pacman 管理软件包，并设置一个可用的开发环境。</p>
<hr>
<p>That&rsquo;s it! 🎉 I hope the bilingual style helps you with both your development and language learning.</p>
</blockquote>
<p>总的来说结合使用MSYS2，MinGW，pacman这些，是可以不依赖Visual Studio来实现exe的编译。</p>
<p><mark>其实一开始也遇到很多小问题，比如没有PCL库，然后PCL又依赖各种库，一开始的想法就是各种尝试嘛，甚至想到了手动安装，然后手动编译安装也是一个巨大的坑啊，后来是配合pacman一起服用了，虽然不及apt那么强大，但至少常用的库都有的，然后再编译需要的库就会顺畅很多。</mark></p>
<h3 id="python打包exe">Python打包exe<a hidden class="anchor" aria-hidden="true" href="#python打包exe">#</a></h3>
<p>理论上讲，应该是有直接将Python打包成exe程序的工具的，所以我的第一想法是<strong>先收集一些信息</strong>，比如得到下面这些：</p>
<blockquote>
<p>将Python打包成exe可执行文件的常见需求是为了将Python项目分发给没有Python环境的用户。以下是几种常用的打包工具，并且每种工具都有其优势和适用场景。</p>
<h4 id="1-pyinstaller">1. <strong>PyInstaller</strong><a hidden class="anchor" aria-hidden="true" href="#1-pyinstaller">#</a></h4>
<ul>
<li><strong>优势</strong>：最广泛使用的Python打包工具之一，支持多平台（Windows、Linux、Mac），能够将整个Python项目及其依赖包打包为一个单独的可执行文件。</li>
<li><strong>安装</strong>：<code>pip install pyinstaller</code></li>
<li><strong>使用</strong>：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pyinstaller --onefile your_script.py
</span></span></code></pre></div><code>--onefile</code> 参数会将所有依赖打包到一个可执行文件中。生成的exe文件通常位于 <code>dist/</code> 文件夹中。</li>
<li><strong>优点</strong>：
<ul>
<li>支持多平台。</li>
<li>配置灵活，可以指定隐藏控制台窗口（通过 <code>--noconsole</code>），或者包含额外的资源文件。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li>打包后文件较大，因为会打包所有依赖。</li>
<li>对于动态加载的模块或资源文件，需要额外配置。</li>
</ul>
</li>
</ul>
<h4 id="2-cx_freeze">2. <strong>cx_Freeze</strong><a hidden class="anchor" aria-hidden="true" href="#2-cx_freeze">#</a></h4>
<ul>
<li><strong>优势</strong>：与PyInstaller类似，支持多平台打包，尤其适合需要将Python程序打包为Windows可执行文件的场景。它更注重跨平台的兼容性和可扩展性。</li>
<li><strong>安装</strong>：<code>pip install cx-Freeze</code></li>
<li><strong>使用</strong>：
需要编写一个 <code>setup.py</code> 文件来定义打包配置：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cx_Freeze</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Executable</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">setup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s2">&#34;your_app_name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Description of your app&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">executables</span><span class="o">=</span><span class="p">[</span><span class="n">Executable</span><span class="p">(</span><span class="s2">&#34;your_script.py&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div>然后运行：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python setup.py build
</span></span></code></pre></div></li>
<li><strong>优点</strong>：
<ul>
<li>比PyInstaller更灵活，适合复杂项目。</li>
<li>支持不同的目标平台。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li>配置复杂度较高。</li>
<li>需要手动设置依赖项。</li>
</ul>
</li>
</ul>
<h4 id="3-py2exe">3. <strong>Py2exe</strong><a hidden class="anchor" aria-hidden="true" href="#3-py2exe">#</a></h4>
<ul>
<li><strong>优势</strong>：专为Windows平台开发的工具，可以将Python程序打包成Windows可执行文件。</li>
<li><strong>安装</strong>：<code>pip install py2exe</code></li>
<li><strong>使用</strong>：
同样需要编写 <code>setup.py</code>：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">py2exe</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">setup</span><span class="p">(</span><span class="n">console</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;your_script.py&#39;</span><span class="p">])</span>
</span></span></code></pre></div>然后运行：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python setup.py py2exe
</span></span></code></pre></div></li>
<li><strong>优点</strong>：
<ul>
<li>针对Windows进行优化，适合Windows应用程序。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li>仅支持Windows。</li>
<li>相对较旧，不如PyInstaller和cx_Freeze活跃。</li>
</ul>
</li>
</ul>
<h4 id="4-nuitka">4. <strong>Nuitka</strong><a hidden class="anchor" aria-hidden="true" href="#4-nuitka">#</a></h4>
<ul>
<li><strong>优势</strong>：除了打包功能外，Nuitka还将Python代码编译为C代码，生成的可执行文件通常比PyInstaller和cx_Freeze生成的要小，并且在运行时性能更好。</li>
<li><strong>安装</strong>：<code>pip install nuitka</code></li>
<li><strong>使用</strong>：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nuitka --standalone --onefile your_script.py
</span></span></code></pre></div></li>
<li><strong>优点</strong>：
<ul>
<li>生成的可执行文件运行效率更高。</li>
<li>文件大小较小。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li>对于依赖复杂的项目，需要更多的配置。</li>
<li>打包速度较慢。</li>
</ul>
</li>
</ul>
<h4 id="5-pyoxidizer">5. <strong>PyOxidizer</strong><a hidden class="anchor" aria-hidden="true" href="#5-pyoxidizer">#</a></h4>
<ul>
<li><strong>优势</strong>：较新的工具，强调快速的启动时间和轻量级的打包结果。可以将Python解释器和应用程序一起打包，并且支持创建独立的Rust二进制文件。</li>
<li><strong>安装</strong>：可以通过Rust的包管理工具 <code>cargo</code> 安装：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cargo install pyoxidizer
</span></span></code></pre></div></li>
<li><strong>使用</strong>：
编写一个 <code>pyoxidizer.bzl</code> 配置文件，并运行 <code>pyoxidizer</code> 命令。</li>
<li><strong>优点</strong>：
<ul>
<li>能够打包出更小、更快的可执行文件。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li>需要学习Rust工具链的基础。</li>
<li>生态不如PyInstaller和cx_Freeze成熟。</li>
</ul>
</li>
</ul>
<h4 id="6-briefcase">6. <strong>Briefcase</strong><a hidden class="anchor" aria-hidden="true" href="#6-briefcase">#</a></h4>
<ul>
<li><strong>优势</strong>：是BeeWare项目的一部分，支持跨平台打包，并且能够将Python应用打包为原生平台应用（例如：Windows的exe，macOS的.dmg，甚至是Android和iOS应用）。</li>
<li><strong>安装</strong>：<code>pip install briefcase</code></li>
<li><strong>使用</strong>：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">briefcase create
</span></span><span class="line"><span class="cl">briefcase build
</span></span><span class="line"><span class="cl">briefcase run
</span></span></code></pre></div></li>
<li><strong>优点</strong>：
<ul>
<li>支持多种平台打包。</li>
<li>非常适合开发桌面应用。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li>主要用于GUI应用，命令行工具的打包支持较弱。</li>
</ul>
</li>
</ul>
<h4 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h4>
<ul>
<li><strong>PyInstaller</strong> 是目前最流行和最通用的选择，尤其适合跨平台和快速开发需求。</li>
<li><strong>cx_Freeze</strong> 提供了更多的灵活性和跨平台兼容性，但需要更多的配置。</li>
<li><strong>Nuitka</strong> 则更适合追求性能优化的场景，生成的文件更小。</li>
<li><strong>Py2exe</strong> 是Windows专用的工具，适合Windows平台开发者。</li>
<li><strong>PyOxidizer</strong> 和 <strong>Briefcase</strong> 则是一些新兴的工具，适合对性能和特定平台有特殊需求的场景。</li>
</ul>
<p>根据你的需求，可以选择最合适的工具进行打包。如果你需要灵活且简单的方案，<strong>PyInstaller</strong> 是推荐的首选。如果你对文件大小和执行效率有要求，可以考虑 <strong>Nuitka</strong>。</p>
</blockquote>
<p>搜索之后，大致有了了解，就可以开始尝试了，<strong>看着比较简单的是：cx_Freeze</strong>，于是就先试了它，采取什么策略来尝试呢？</p>
<p>比如，从最小可实现的方式出发吧，调用opencv读取图像并显示出来。尝试可行，似乎路能走通，并且发现了一些在Windows开发的一些规律：</p>
<ul>
<li>exe点击运行后都是通过<code>.dll</code>方式来找需要的依赖（动态链接库），如果没有就会出错</li>
<li>如果程序一打开就崩溃了，第一想到是不是链接库没有（这里想到小时候玩的盗版游戏，打不开游戏到网上找一找原因，或者是不是程序自己弹出来缺少哪个<code>.dll</code>，这时候再去下载一个放进文件夹）</li>
</ul>
<p><mark>在这个过程中，也摸索到了怎么来排查.dll缺失的问题，简单来说就是先看少哪个，少了那就复制过去，但怎么排查呢？也是有工具能直接用的，我还是采用先收集信息再尝试的策略</mark></p>
<p>cx_Freeze本身是可以用的，但是后来，我产生了一个不成熟的需求：</p>
<p><strong>能不能将所有的dll和exe一起打包成一个独立exe文件？</strong></p>
<p>尝试cx_Freeze发现似乎不太行，所以后面就转战了PyInstaller，但是实际用起来，PyInstaller要更好用一些，**因为可以设定的参数更详细，**原本我以为就是命令行参数的输入那么简单，后来因为想到：这种打包工具，应该是有专门的配置文件可以设置的吧？于是就摸清楚了流程。而且如果带着问题和需求出发，可以设置的选项还有很多，比如：</p>
<ul>
<li>手动选择哪些dll是额外打包的</li>
<li>是否要显示终端（<strong>在cx_Freeze中叫做Win32GUI，显示终端配合打印语句，可以调试；同样，如果想要去除终端创建，那么一定不能出现打印输出到终端</strong>）</li>
<li>配置图标，版本信息等等等</li>
</ul>
<h4 id="实际使用的例子">实际使用的例子<a hidden class="anchor" aria-hidden="true" href="#实际使用的例子">#</a></h4>
<p>对于cx_Freeze可以使用install_exe.py写一个打包配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cx_Freeze</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Executable</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 额外的ddl文件</span>
</span></span><span class="line"><span class="cl"><span class="n">extra_dll_files</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s1">&#39;extra_dll/libomp140.x86_64.dll&#39;</span><span class="p">,</span> <span class="s1">&#39;libomp140.x86_64.dll&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s1">&#39;extra_dll/libomp140d.x86_64.dll&#39;</span><span class="p">,</span> <span class="s1">&#39;libomp140d.x86_64.dll&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 合并所有需要包含的文件</span>
</span></span><span class="line"><span class="cl"><span class="n">include_files</span> <span class="o">=</span> <span class="n">extra_dll_files</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加打包选项</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;build_exe&#39;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;build_exe&#39;</span><span class="p">:</span> <span class="s1">&#39;mt3d_2.0&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;include_files&#39;</span><span class="p">:</span> <span class="n">include_files</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;include_msvcr&#39;</span><span class="p">:</span> <span class="kc">True</span>  <span class="c1"># 包含 Microsoft Visual C++ 运行时库</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置可执行文件</span>
</span></span><span class="line"><span class="cl"><span class="n">executables</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">Executable</span><span class="p">(</span><span class="s1">&#39;main.py&#39;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s1">&#39;Win32GUI&#39;</span><span class="p">,</span> <span class="n">target_name</span><span class="o">=</span><span class="s1">&#39;mt3d.exe&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置打包</span>
</span></span><span class="line"><span class="cl"><span class="n">setup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MT3D&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Manifold Tech Limited 3D Rendererer&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">executables</span><span class="o">=</span><span class="n">executables</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>实际运行就是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> python .<span class="se">\i</span>nstall_exe.py build
</span></span></code></pre></div><p>而对于PyInstaller，则可以使用更复杂的配置文件，比如<code>install.spec</code>，这个spec文件本质上也可以看作是Python文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># -*- mode: python ; coding: utf-8 -*-</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 其他额外考虑的dll文件</span>
</span></span><span class="line"><span class="cl"><span class="n">extra_dll_files</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;extra_dll/libomp140.x86_64.dll&#39;</span><span class="p">),</span> <span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="c1"># 这里的 &#39;.&#39; 表示目标路径是打包后的根目录</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;extra_dll/libomp140d.x86_64.dll&#39;</span><span class="p">),</span> <span class="s1">&#39;.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pre_run_pkg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;PreOps&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pre_run_dlls</span> <span class="o">=</span> <span class="p">[(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pre_run_pkg_path</span><span class="p">,</span> <span class="n">dll</span><span class="p">),</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">dll</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">pre_run_pkg_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">dll</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.dll&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">exe_files</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s1">&#39;PreOps.exe&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置附加文件</span>
</span></span><span class="line"><span class="cl"><span class="n">binaries</span> <span class="o">=</span> <span class="n">extra_dll_files</span> <span class="o">+</span> <span class="n">pre_run_dlls</span> <span class="o">+</span> <span class="n">exe_files</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义 assets 文件夹的路径  </span>
</span></span><span class="line"><span class="cl"><span class="n">assets_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 遍历 assets 目录及其子目录</span>
</span></span><span class="line"><span class="cl"><span class="n">data_files</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">assets_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取文件的绝对路径</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 在打包时，将文件放入 assets 文件夹内保持层次结构</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">assets_dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 将每个文件的源路径和目标路径添加到 data_files 列表</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义 lib 文件夹的路径（包含 .js 文件）</span>
</span></span><span class="line"><span class="cl"><span class="n">lib_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;lib&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 遍历 lib 目录及其子目录</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">lib_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取文件的绝对路径</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 在打包时，将文件放入 lib 文件夹内保持层次结构</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">lib_dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 将每个文件的源路径和目标路径添加到 data_files 列表</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">file_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">block_cipher</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># EXE 配置</span>
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="s1">&#39;train.py&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">pathex</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">binaries</span><span class="o">=</span><span class="n">binaries</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">datas</span><span class="o">=</span><span class="n">data_files</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">hiddenimports</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="n">hookspath</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="n">runtime_hooks</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="n">excludes</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="n">win_no_prefer_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">win_private_assemblies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">cipher</span><span class="o">=</span><span class="n">block_cipher</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">noarchive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># PYZ 配置</span>
</span></span><span class="line"><span class="cl"><span class="n">pyz</span> <span class="o">=</span> <span class="n">PYZ</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pure</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">zipped_data</span><span class="p">,</span> <span class="n">cipher</span><span class="o">=</span><span class="n">block_cipher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># EXE 配置</span>
</span></span><span class="line"><span class="cl"><span class="n">exe</span> <span class="o">=</span> <span class="n">EXE</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">pyz</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">.</span><span class="n">scripts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="n">exclude_binaries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 设置为 True，表示 EXE 中不包含 binaries，因为 binaries 将在 COLLECT 阶段处理</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MindCloud Renderer&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">bootloader_ignore_signals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">strip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">upx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">upx_exclude</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="n">runtime_tmpdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">console</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 设置为 False 隐藏控制台窗口</span>
</span></span><span class="line"><span class="cl">    <span class="n">icon</span><span class="o">=</span><span class="s1">&#39;C:/Users/Quite/CKCode/3DGSMT/assets/logo.ico&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">version</span><span class="o">=</span><span class="s1">&#39;mt3d_version.txt&#39;</span><span class="p">,</span>  <span class="c1"># 从文件中读取版本信息</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># COLLECT 配置</span>
</span></span><span class="line"><span class="cl"><span class="n">coll</span> <span class="o">=</span> <span class="n">COLLECT</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">exe</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">.</span><span class="n">binaries</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">.</span><span class="n">zipfiles</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span><span class="o">.</span><span class="n">datas</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">strip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">upx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">upx_exclude</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;MindCloud Renderer&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#### 以下是单独的一个exe方式 ####</span>
</span></span><span class="line"><span class="cl"><span class="c1">#### 32位系统单文件不能大于4G ####</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # EXE 配置</span>
</span></span><span class="line"><span class="cl"><span class="c1"># exe = EXE(</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     pyz,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     a.scripts,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     a.binaries,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     a.zipfiles,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     a.datas,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     [],</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     name=&#39;MindCloud Renderer&#39;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     debug=False,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     bootloader_ignore_signals=False,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     strip=False,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     upx=False,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     upx_exclude=[],</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     runtime_tmpdir=None,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     console=False,  # 设置为 False 隐藏控制台窗口</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     icon=&#39;C:/Users/Quite/CKCode/3DGSMT/assets/logo.ico&#39;,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     version=&#39;mt3d_version.txt&#39;,  # 从文件中读取版本信息</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     onefile=True  # 设置为 True 以生成单文件</span>
</span></span><span class="line"><span class="cl"><span class="c1"># )</span>
</span></span></code></pre></div><p>使用的话就是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pyinstaller .<span class="se">\i</span>nstall.spec
</span></span></code></pre></div><p><mark>其实从这里的注释可以看出，当时遇到了打包一个独立exe程序的问题：文件大小不能超过4G，底层原因可能和32位系统有关系，但如果打包成一个_internal文件夹，就是正常的。写到这里，想到了当时制作晕到死安装盘时候也是，那个晕到死的镜像文件大于4G了，用官网的工具压根复制不完全，结果都4202年了，问题还没有解决，最好是手动选择NTFS文件系统，手动复制进去的，也是折腾了老半天。。。refus+手动复制吧</mark></p>
<p>以上只能算是一次初步的使用和感受记录，后面如果再用到，可以在此基础上再往前迈进一步了。</p>
<h3 id="windows的dll分析工具">Windows的dll分析工具<a hidden class="anchor" aria-hidden="true" href="#windows的dll分析工具">#</a></h3>
<p>说实话，一开始去搜索有哪些dll分析工具的时候，遇到下载失败，github显示的时间是10年前，我都在想，是不是这玩意不能用了，后面才知道是自己不会用。。。纯属傻，比较搞笑的是，点开Dependencies闪退就以为程序不行，但是人家还有个DependenciesGui呢，我给直接忽视掉，导致我一开始直接陷入自闭状态很长一段时间。。。</p>
<p>搜集的信息是这样的：</p>
<blockquote>
<p>在Windows上检查一个程序的DLL依赖并判断是否有缺失的现代工具可以帮助开发者更好地解决动态链接库（DLL）加载问题。随着Windows系统的发展，传统工具如 <strong>Dependency Walker</strong> 逐渐无法适应现代系统的新特性，诸如API Set Schema和SxS（side-by-side）依赖等机制。因此，以下是一些最新、成熟且常用的工具，涵盖了从静态到动态分析的不同需求：</p>
<h4 id="1-dependencies-lucasgdependencies">1. <strong>Dependencies (lucasg/Dependencies)</strong><a hidden class="anchor" aria-hidden="true" href="#1-dependencies-lucasgdependencies">#</a></h4>
<ul>
<li><strong>简介</strong>：<strong>Dependencies</strong> 是一个现代化的DLL依赖分析工具，专为替代老旧的 <strong>Dependency Walker</strong> 而设计，能处理Windows 10及以后的API Set Schema和SxS依赖问题。</li>
<li><strong>功能特点</strong>：
<ul>
<li>识别和解析Windows 10的API Set Schema。</li>
<li>支持SxS并行依赖分析。</li>
<li>显示DLL导入导出表，列出函数依赖。</li>
<li>支持静态和动态依赖分析，提供实时的DLL加载信息。</li>
</ul>
</li>
<li><strong>适用场景</strong>：处理现代Windows操作系统上的DLL加载问题，特别是涉及动态加载、并行依赖和重定向API的场景。</li>
<li><strong>下载</strong>：<a href="https://github.com/lucasg/Dependencies">Dependencies - GitHub</a></li>
<li><strong>使用方法</strong>：
<ol>
<li>下载并运行 <code>Dependencies.exe</code>。</li>
<li>打开目标可执行文件或DLL，查看依赖树，缺失的DLL会标红。</li>
<li>支持导入表和导出表的查看，帮助你找到具体的函数依赖。</li>
</ol>
</li>
</ul>
<h4 id="2-process-monitor-procmon">2. <strong>Process Monitor (ProcMon)</strong><a hidden class="anchor" aria-hidden="true" href="#2-process-monitor-procmon">#</a></h4>
<ul>
<li><strong>简介</strong>：<strong>Process Monitor</strong> 是由Microsoft Sysinternals提供的高级系统监控工具，用于实时跟踪所有文件、注册表操作以及DLL加载情况。它可以在应用程序运行时监控并记录DLL的加载过程。</li>
<li><strong>功能特点</strong>：
<ul>
<li>实时监控DLL加载过程。</li>
<li>详细记录每个DLL的加载路径、状态、加载失败的原因。</li>
<li>支持设置复杂过滤器，聚焦DLL加载相关的操作（如 <code>Load Image</code>）。</li>
</ul>
</li>
<li><strong>适用场景</strong>：适合分析程序在运行时加载的DLL，调试缺失或加载失败的DLL，解决动态依赖问题。</li>
<li><strong>下载</strong>：<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">Process Monitor - Microsoft</a></li>
<li><strong>使用方法</strong>：
<ol>
<li>启动ProcMon并设置进程过滤器。</li>
<li>运行目标程序，观察DLL的加载情况。</li>
<li>使用 <code>Load Image</code> 过滤器查看所有DLL加载操作，分析是否有加载失败的DLL。</li>
</ol>
</li>
</ul>
<h4 id="3-listdlls">3. <strong>ListDLLs</strong><a hidden class="anchor" aria-hidden="true" href="#3-listdlls">#</a></h4>
<ul>
<li><strong>简介</strong>：<strong>ListDLLs</strong> 是一个轻量级命令行工具，来自Microsoft Sysinternals，用于列出正在运行的进程所加载的所有DLL。它能帮助你快速查看应用程序实际加载了哪些DLL以及这些DLL的路径。</li>
<li><strong>功能特点</strong>：
<ul>
<li>列出所有正在运行的进程所加载的DLL。</li>
<li>显示DLL加载的路径和版本信息。</li>
</ul>
</li>
<li><strong>适用场景</strong>：快速查看某个进程当前使用的DLL，排查可能的DLL版本冲突或加载错误。</li>
<li><strong>下载</strong>：<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/listdlls">ListDLLs - Microsoft</a></li>
<li><strong>使用方法</strong>：
<ol>
<li>在命令行中运行 <code>listdlls.exe [进程名或PID]</code>。</li>
<li>查看该进程加载的所有DLL及其路径，排查问题。</li>
</ol>
</li>
</ul>
<h4 id="4-cff-explorer">4. <strong>CFF Explorer</strong><a hidden class="anchor" aria-hidden="true" href="#4-cff-explorer">#</a></h4>
<ul>
<li><strong>简介</strong>：<strong>CFF Explorer</strong> 是一个强大的PE文件分析工具，允许你查看Windows可执行文件（如EXE、DLL）的结构和依赖。</li>
<li><strong>功能特点</strong>：
<ul>
<li>允许查看PE文件的导入表和导出表。</li>
<li>分析文件的依赖DLL及其加载路径。</li>
<li>支持编辑PE文件的某些部分。</li>
</ul>
</li>
<li><strong>适用场景</strong>：适合需要深入分析可执行文件的PE结构、导入表、导出表及依赖关系的开发者。</li>
<li><strong>下载</strong>：<a href="https://ntcore.com/?page_id=388">CFF Explorer - NTCore</a></li>
<li><strong>使用方法</strong>：
<ol>
<li>打开CFF Explorer，载入目标可执行文件或DLL。</li>
<li>查看“Import Directory”以获取该文件的DLL依赖。</li>
</ol>
</li>
</ul>
<h4 id="5-pe-explorer">5. <strong>PE Explorer</strong><a hidden class="anchor" aria-hidden="true" href="#5-pe-explorer">#</a></h4>
<ul>
<li><strong>简介</strong>：另一个功能强大的PE文件分析工具，类似于CFF Explorer。它专注于查看可执行文件的依赖和内部结构。</li>
<li><strong>功能特点</strong>：
<ul>
<li>查看导入表、导出表以及依赖DLL。</li>
<li>支持编辑文件内部结构。</li>
</ul>
</li>
<li><strong>适用场景</strong>：对PE文件结构进行详细分析，解决复杂的DLL依赖问题。</li>
<li><strong>下载</strong>：<a href="https://www.heaventools.com/overview.htm">PE Explorer - Heaventools</a></li>
</ul>
<h4 id="6-sigcheck">6. <strong>Sigcheck</strong><a hidden class="anchor" aria-hidden="true" href="#6-sigcheck">#</a></h4>
<ul>
<li><strong>简介</strong>：<strong>Sigcheck</strong> 是Sysinternals的另一个工具，主要用于检查文件的数字签名，但它也可以列出文件的依赖DLL及其签名信息，适用于排查潜在的DLL安全问题。</li>
<li><strong>功能特点</strong>：
<ul>
<li>列出文件的依赖DLL及其签名信息。</li>
<li>检查DLL是否未签名或有安全风险。</li>
</ul>
</li>
<li><strong>适用场景</strong>：适合用于安全分析，检查应用程序依赖的DLL的签名状态，确保没有不安全的依赖。</li>
<li><strong>下载</strong>：<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck">Sigcheck - Microsoft</a></li>
<li><strong>使用方法</strong>：
<ol>
<li>在命令行中运行 <code>sigcheck -e [可执行文件或DLL]</code>。</li>
<li>工具会列出依赖的DLL以及它们的签名状态。</li>
</ol>
</li>
</ul>
<h4 id="7-dll-export-viewer">7. <strong>DLL Export Viewer</strong><a hidden class="anchor" aria-hidden="true" href="#7-dll-export-viewer">#</a></h4>
<ul>
<li><strong>简介</strong>：这是一个轻量工具，用于查看DLL文件导出的所有函数，帮助你分析DLL内部函数是否完整或者是否被正确调用。</li>
<li><strong>功能特点</strong>：
<ul>
<li>列出DLL的所有导出函数。</li>
<li>支持保存导出列表。</li>
</ul>
</li>
<li><strong>适用场景</strong>：适合检查某些DLL是否缺少导出函数，或者导出函数是否与预期一致。</li>
<li><strong>下载</strong>：<a href="https://www.nirsoft.net/utils/dll_export_viewer.html">DLL Export Viewer - NirSoft</a></li>
</ul>
<h4 id="8-nirsoft-loadeddllsview">8. <strong>Nirsoft LoadedDllsView</strong><a hidden class="anchor" aria-hidden="true" href="#8-nirsoft-loadeddllsview">#</a></h4>
<ul>
<li><strong>简介</strong>：<strong>LoadedDllsView</strong> 是来自NirSoft的工具，它可以列出指定进程中加载的所有DLL文件及其完整路径。</li>
<li><strong>功能特点</strong>：
<ul>
<li>列出所有加载的DLL文件及其路径。</li>
<li>支持导出DLL列表为文本文件。</li>
</ul>
</li>
<li><strong>适用场景</strong>：类似于ListDLLs，适合查看某个进程加载的DLL，解决加载冲突和依赖问题。</li>
<li><strong>下载</strong>：<a href="https://www.nirsoft.net/utils/loaded_dll_view.html">LoadedDllsView - NirSoft</a></li>
</ul>
<h4 id="9-ldg-load-dependency-graph">9. <strong>LDG (Load Dependency Graph)</strong><a hidden class="anchor" aria-hidden="true" href="#9-ldg-load-dependency-graph">#</a></h4>
<ul>
<li><strong>简介</strong>：<strong>LDG</strong> 是一个新的工具，专门用于生成可执行文件的依赖关系图，帮助开发者可视化文件与DLL之间的关系。</li>
<li><strong>功能特点</strong>：
<ul>
<li>可视化依赖关系图。</li>
<li>支持生成依赖图的文件输出。</li>
</ul>
</li>
<li><strong>适用场景</strong>：适合需要可视化文件依赖的场景，帮助更直观地分析复杂依赖树。</li>
<li><strong>下载</strong>：<a href="https://github.com/sohonetlabs/LDG">LDG - GitHub</a></li>
</ul>
<h4 id="总结-1">总结<a hidden class="anchor" aria-hidden="true" href="#总结-1">#</a></h4>
<p>在现代Windows环境中，<strong>Dependencies</strong> 是当前最适合替代 <strong>Dependency Walker</strong> 的工具，尤其对于Windows 10的API Set Schema和SxS支持，它具有极佳的处理能力。如果你需要动态分析DLL加载情况，<strong>Process Monitor</strong> 提供了实时监控功能，适合调试复杂的依赖问题。对于轻量级和特定场景的需求，<strong>ListDLLs</strong>、<strong>Sigcheck</strong>、<strong>CFF Explorer</strong> 等工具则可以快速、有效地帮助你分析问题。</p>
<p>根据你的具体需求，选择合适的工具可以帮助你更快地找到和解决DLL缺失、加载失败或依赖冲突问题。</p>
</blockquote>
<p>以上都不重要，关键是能用，所以第一步要做的是先上手，后来实际发现Dependencies挺好用的，<strong>在其他Windows上运行程序时，如果出现一打开就直接挂掉，那么直接用DependenciesGUI分析一下，一般就能找到是哪个dll缺失，然后再把缺失的dll放到程序运行的目录就能解决了。</strong></p>
<h3 id="查找exe的所有dll依赖并复制在一起">查找exe的所有dll依赖并复制在一起<a hidden class="anchor" aria-hidden="true" href="#查找exe的所有dll依赖并复制在一起">#</a></h3>
<p><mark>实际开发过程中，我还产生了一个新的需求：比如我cmake编译的exe，运行时所依赖的dll在哪？我想把这些dll 都放到一起，那么这样在其他Windows上，不就可以运行这个exe了吗？</mark></p>
<p>我最后使用的是这种方法：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c"># PowerShell 脚本：Copy-AllDependencies.ps1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="no">string</span><span class="p">]</span><span class="nv">$ExePath</span><span class="p">,</span>       <span class="c"># 可执行文件的路径</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="no">string</span><span class="p">]</span><span class="nv">$OutputDir</span>      <span class="c"># 输出目录的路径</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 检查输入参数是否有效</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$ExePath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Error</span> <span class="s2">&#34;Error: The specified EXE file does not exist: </span><span class="nv">$ExePath</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$OutputDir</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Output</span> <span class="s2">&#34;Output directory does not exist. Creating directory: </span><span class="nv">$OutputDir</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="nv">$OutputDir</span> <span class="n">-ItemType</span> <span class="n">Directory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 启动进程以获取所有 DLL 依赖项</span>
</span></span><span class="line"><span class="cl"><span class="nv">$process</span> <span class="p">=</span> <span class="nb">Start-Process</span> <span class="n">-FilePath</span> <span class="nv">$ExePath</span> <span class="n">-PassThru</span> <span class="n">-WindowStyle</span> <span class="n">Hidden</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 暂停几秒钟，以便进程加载所有 DLL</span>
</span></span><span class="line"><span class="cl"><span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="mf">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 获取所有加载的 DLL</span>
</span></span><span class="line"><span class="cl"><span class="nv">$loadedModules</span> <span class="p">=</span> <span class="nv">$process</span><span class="p">.</span><span class="py">Modules</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="py">FileName</span> <span class="o">-like</span> <span class="s2">&#34;*.dll&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 复制 EXE 文件到输出目录</span>
</span></span><span class="line"><span class="cl"><span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="nv">$ExePath</span> <span class="n">-Destination</span> <span class="nv">$OutputDir</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Output</span> <span class="s2">&#34;Copied: </span><span class="p">$(</span><span class="nb">Split-Path</span> <span class="n">-Leaf</span> <span class="nv">$ExePath</span><span class="p">)</span><span class="s2"> to </span><span class="nv">$OutputDir</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 遍历所有找到的 DLL 文件并复制</span>
</span></span><span class="line"><span class="cl"><span class="k">foreach</span> <span class="p">(</span><span class="nv">$module</span> <span class="k">in</span> <span class="nv">$loadedModules</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$dllPath</span> <span class="p">=</span> <span class="nv">$module</span><span class="p">.</span><span class="py">FileName</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$dllName</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.IO.Path</span><span class="p">]::</span><span class="n">GetFileName</span><span class="p">(</span><span class="nv">$dllPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c"># 构建目标路径</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$targetPath</span> <span class="p">=</span> <span class="nb">Join-Path</span> <span class="n">-Path</span> <span class="nv">$OutputDir</span> <span class="n">-ChildPath</span> <span class="nv">$dllName</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c"># 复制 DLL 文件到输出目录</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="nv">$dllPath</span> <span class="n">-Destination</span> <span class="nv">$targetPath</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Output</span> <span class="s2">&#34;Copied: </span><span class="nv">$dllName</span><span class="s2"> to </span><span class="nv">$OutputDir</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Warning</span> <span class="s2">&#34;Failed to copy: </span><span class="nv">$dllName</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 检查进程是否仍在运行</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$process</span><span class="p">.</span><span class="n">HasExited</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c"># 尝试结束进程</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Stop-Process</span> <span class="n">-Id</span> <span class="nv">$process</span><span class="p">.</span><span class="py">Id</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Output</span> <span class="s2">&#34;Process terminated: </span><span class="nv">$process</span><span class="s2">.Id&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Warning</span> <span class="s2">&#34;Could not terminate process: </span><span class="nv">$_</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Output</span> <span class="s2">&#34;The process has already exited.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Output</span> <span class="s2">&#34;All DLL dependencies copied to: </span><span class="nv">$OutputDir</span><span class="s2">&#34;</span>
</span></span></code></pre></div><p>或者下面的这种可以重试的写法也行：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="no">string</span><span class="p">]</span><span class="nv">$ExePath</span><span class="p">,</span>       <span class="c"># 可执行文件的路径</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="no">string</span><span class="p">]</span><span class="nv">$OutputDir</span>      <span class="c"># 输出目录的路径</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 检查输入参数是否有效</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$ExePath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Error</span> <span class="s2">&#34;Error: The specified EXE file does not exist: </span><span class="nv">$ExePath</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">exit</span> <span class="mf">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="nv">$OutputDir</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Output</span> <span class="s2">&#34;Output directory does not exist. Creating directory: </span><span class="nv">$OutputDir</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="nv">$OutputDir</span> <span class="n">-ItemType</span> <span class="n">Directory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 定义最多尝试的次数</span>
</span></span><span class="line"><span class="cl"><span class="nv">$maxRetries</span> <span class="p">=</span> <span class="mf">3</span>
</span></span><span class="line"><span class="cl"><span class="nv">$retryCount</span> <span class="p">=</span> <span class="mf">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 复制 EXE 文件到输出目录</span>
</span></span><span class="line"><span class="cl"><span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="nv">$ExePath</span> <span class="n">-Destination</span> <span class="nv">$OutputDir</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl"><span class="nb">Write-Output</span> <span class="s2">&#34;Copied: </span><span class="p">$(</span><span class="nb">Split-Path</span> <span class="n">-Leaf</span> <span class="nv">$ExePath</span><span class="p">)</span><span class="s2"> to </span><span class="nv">$OutputDir</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c"># 循环尝试重启进程</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c"># 启动进程并确保它在后台运行，防止它被快速终止</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$process</span> <span class="p">=</span> <span class="nb">Start-Process</span> <span class="n">-FilePath</span> <span class="nv">$ExePath</span> <span class="n">-PassThru</span> <span class="n">-WindowStyle</span> <span class="n">Hidden</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c"># 暂停几秒钟，以确保 DLL 加载完成</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="mf">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c"># 检查进程是否仍在运行</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$process</span><span class="p">.</span><span class="n">HasExited</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c"># 获取加载的模块（DLL）</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$loadedModules</span> <span class="p">=</span> <span class="nv">$process</span><span class="p">.</span><span class="py">Modules</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="py">FileName</span> <span class="o">-like</span> <span class="s2">&#34;*.dll&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c"># 遍历所有找到的 DLL 文件并复制</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$module</span> <span class="k">in</span> <span class="nv">$loadedModules</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$dllPath</span> <span class="p">=</span> <span class="nv">$module</span><span class="p">.</span><span class="py">FileName</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$dllName</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.IO.Path</span><span class="p">]::</span><span class="n">GetFileName</span><span class="p">(</span><span class="nv">$dllPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c"># 构建目标路径</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$targetPath</span> <span class="p">=</span> <span class="nb">Join-Path</span> <span class="n">-Path</span> <span class="nv">$OutputDir</span> <span class="n">-ChildPath</span> <span class="nv">$dllName</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c"># 复制 DLL 文件到输出目录</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nb">Copy-Item</span> <span class="n">-Path</span> <span class="nv">$dllPath</span> <span class="n">-Destination</span> <span class="nv">$targetPath</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">                <span class="nb">Write-Output</span> <span class="s2">&#34;Copied: </span><span class="nv">$dllName</span><span class="s2"> to </span><span class="nv">$OutputDir</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nb">Write-Warning</span> <span class="s2">&#34;Failed to copy: </span><span class="nv">$dllName</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c"># 停止进程</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">Stop-Process</span> <span class="n">-Id</span> <span class="nv">$process</span><span class="p">.</span><span class="py">Id</span> <span class="n">-Force</span>
</span></span><span class="line"><span class="cl">            <span class="nb">Write-Output</span> <span class="s2">&#34;Process terminated: </span><span class="nv">$process</span><span class="s2">.Id&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">Write-Warning</span> <span class="s2">&#34;Could not terminate process: </span><span class="nv">$_</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c"># 退出循环</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Write-Error</span> <span class="s2">&#34;Error: The process has already exited before capturing dependencies. Retrying...&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$retryCount</span><span class="p">++</span>
</span></span><span class="line"><span class="cl">        <span class="nb">Start-Sleep</span> <span class="n">-Seconds</span> <span class="mf">2</span>  <span class="c"># 等待几秒钟后再试</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$retryCount</span> <span class="o">-lt</span> <span class="nv">$maxRetries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$retryCount</span> <span class="o">-ge</span> <span class="nv">$maxRetries</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Write-Error</span> <span class="s2">&#34;Failed to capture dependencies after multiple attempts.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">Write-Output</span> <span class="s2">&#34;All DLL dependencies copied to: </span><span class="nv">$OutputDir</span><span class="s2">&#34;</span>
</span></span></code></pre></div><p><strong>但是这里有一个关键，程序运行后不能直接退出，所以我在代码里加了一个线程等待，还有一个输入等待，算是一个取巧的做法吧~</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">//</span> <span class="n">延时</span> <span class="mi">10</span> <span class="n">秒</span>
</span></span><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span><span class="s2">&#34;Delay 10 seconds...</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="p">::</span><span class="n">this_thread</span><span class="p">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">chrono</span><span class="p">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="p">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s2">&#34;Press Enter to continue...&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="p">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="p">::</span><span class="n">cin</span><span class="o">.</span><span class="n">get</span><span class="p">();</span> <span class="o">//</span> <span class="n">等待用户输入</span><span class="err">，</span><span class="n">按下</span> <span class="n">Enter</span> <span class="n">键继续</span>
</span></span></code></pre></div><p><mark>实际情况说明，如果只是输入等待，有时候是不行的，就是程序直接跳出了，什么dll也没复制，所以后面又强行加入了线程等待。</mark></p>
<p>我是之前没有及时记录，结果发现：确实，都忘了！</p>
<p>好记性不如好记下啊！！！</p>
<h3 id="windows打包安装程序">Windows打包安装程序<a hidden class="anchor" aria-hidden="true" href="#windows打包安装程序">#</a></h3>
<p>其实PyInstaller这种打包了就能用，如果缺少什么dll依赖，直接复制放进去就行。</p>
<p>这种就已经是<strong>纯净绿色免安装版了</strong>，用起来挺方便，分发的话，进行压缩后就可以。</p>
<p>但是呢，既然都已经做到这一步了，那就再往前多探一步吧。</p>
<blockquote>
<p>将 <code>.exe</code> 和 <code>.dll</code> 文件打包成安装包形式是软件发布的常见需求，特别是对于Windows平台的应用程序。为了实现这一点，可以使用多种工具来打包和生成安装程序，这些工具可以帮助你将可执行文件、依赖的动态链接库（<code>.dll</code> 文件）、资源文件等一起打包为可安装的格式，如 <code>.msi</code> 或 <code>.exe</code> 安装程序。以下是一些常见且成熟的打包工具，详细说明了它们的功能及适用场景。</p>
<h4 id="1-inno-setup">1. <strong>Inno Setup</strong><a hidden class="anchor" aria-hidden="true" href="#1-inno-setup">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：Inno Setup 是一个功能强大且易于使用的免费安装程序创建工具，适用于 Windows 平台。它允许你将应用程序的 <code>.exe</code>、<code>.dll</code>、配置文件等打包为单个 <code>.exe</code> 安装程序。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li>支持将多个文件和目录打包成单个 <code>.exe</code> 安装文件。</li>
<li>支持自定义安装向导界面、许可协议、安装路径等。</li>
<li>提供脚本功能，用于编写复杂的安装逻辑。</li>
<li>支持安装和卸载时的注册表操作、DLL注册等。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：适合需要简单到中等复杂度的安装包创建需求，适用于个人项目和小型到中型的软件分发。</p>
</li>
<li>
<p><strong>使用方法</strong>：</p>
<ol>
<li><a href="https://jrsoftware.org/isinfo.php">下载 Inno Setup</a> 并安装。</li>
<li>创建 <code>.iss</code> 脚本文件，定义要打包的文件、安装路径等。</li>
<li>使用 Inno Setup 编译生成安装程序。</li>
</ol>
</li>
<li>
<p><strong>示例 <code>.iss</code> 文件</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[Setup]</span>
</span></span><span class="line"><span class="cl"><span class="na">AppName</span><span class="o">=</span><span class="s">My Application</span>
</span></span><span class="line"><span class="cl"><span class="na">AppVersion</span><span class="o">=</span><span class="s">1.0</span>
</span></span><span class="line"><span class="cl"><span class="na">DefaultDirName</span><span class="o">=</span><span class="s">{pf}\MyApplication</span>
</span></span><span class="line"><span class="cl"><span class="na">OutputBaseFilename</span><span class="o">=</span><span class="s">setup</span>
</span></span><span class="line"><span class="cl"><span class="na">Compression</span><span class="o">=</span><span class="s">lzma</span>
</span></span><span class="line"><span class="cl"><span class="na">SolidCompression</span><span class="o">=</span><span class="s">yes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Files]</span>
</span></span><span class="line"><span class="cl"><span class="na">Source: &#34;bin\MyApp.exe&#34;; DestDir: &#34;{app}&#34;; Flags: ignoreversion</span>
</span></span><span class="line"><span class="cl"><span class="na">Source: &#34;bin\*.dll&#34;; DestDir: &#34;{app}&#34;; Flags: ignoreversion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Icons]</span>
</span></span><span class="line"><span class="cl"><span class="na">Name: &#34;{group}\My Application&#34;; Filename: &#34;{app}\MyApp.exe&#34;</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="2-nsis-nullsoft-scriptable-install-system">2. <strong>NSIS (Nullsoft Scriptable Install System)</strong><a hidden class="anchor" aria-hidden="true" href="#2-nsis-nullsoft-scriptable-install-system">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：NSIS 是一个非常灵活的开源安装程序创建工具，广泛用于创建 Windows 安装程序。它允许自定义安装逻辑和界面，并支持安装包压缩和多种格式的打包。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li>高度可自定义的安装过程，通过脚本编写安装逻辑。</li>
<li>支持多种安装模式（静默安装、标准安装等）。</li>
<li>内置的压缩算法，能生成体积较小的安装包。</li>
<li>支持多语言安装界面、注册表修改、DLL注册等操作。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：适用于需要高度定制化安装包的开发者和项目，通常用于大型项目或复杂的安装需求。</p>
</li>
<li>
<p><strong>使用方法</strong>：</p>
<ol>
<li><a href="https://nsis.sourceforge.io/Download">下载 NSIS</a> 并安装。</li>
<li>创建 <code>.nsi</code> 脚本文件，编写打包逻辑和安装流程。</li>
<li>使用 NSIS 编译器生成安装程序。</li>
</ol>
</li>
<li>
<p><strong>示例 <code>.nsi</code> 文件</strong>：</p>
<pre tabindex="0"><code class="language-nsi" data-lang="nsi">OutFile &#34;setup.exe&#34;
InstallDir &#34;$PROGRAMFILES\MyApp&#34;

Section
SetOutPath $INSTDIR
File &#34;bin\MyApp.exe&#34;
File &#34;bin\MyLibrary.dll&#34;

CreateShortcut &#34;$DESKTOP\MyApp.lnk&#34; &#34;$INSTDIR\MyApp.exe&#34;
SectionEnd
</code></pre></li>
</ul>
<h4 id="3-wix-toolset-windows-installer-xml">3. <strong>WiX Toolset (Windows Installer XML)</strong><a hidden class="anchor" aria-hidden="true" href="#3-wix-toolset-windows-installer-xml">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：WiX Toolset 是一个用于创建 Windows 安装包的工具集，专注于生成 <code>.msi</code> 文件。它通过 XML 配置文件定义安装逻辑，是一个高度可定制的工具，常用于企业级软件安装包。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li>生成标准的 Windows Installer 安装包（<code>.msi</code> 文件）。</li>
<li>支持复杂的安装方案，包括服务安装、注册表修改、文件权限设置等。</li>
<li>可集成到 CI/CD 管道，适合大型项目的安装包自动化生成。</li>
<li>支持多语言安装、安装时依赖检查等功能。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：适合大型企业级项目，特别是那些需要生成 <code>.msi</code> 安装包的场景。由于其复杂性，它常用于高级用户和团队开发。</p>
</li>
<li>
<p><strong>使用方法</strong>：</p>
<ol>
<li><a href="https://wixtoolset.org/">下载 WiX Toolset</a> 并安装。</li>
<li>编写 <code>.wxs</code> XML 文件，定义安装包结构和逻辑。</li>
<li>使用 WiX 编译工具生成 <code>.msi</code> 安装包。</li>
</ol>
</li>
<li>
<p><strong>示例 <code>.wxs</code> 文件</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Wix</span> <span class="na">xmlns=</span><span class="s">&#34;http://schemas.microsoft.com/wix/2006/wi&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Product</span> <span class="na">Id=</span><span class="s">&#34;*&#34;</span> <span class="na">Name=</span><span class="s">&#34;MyApp&#34;</span> <span class="na">Version=</span><span class="s">&#34;1.0.0.0&#34;</span> <span class="na">Manufacturer=</span><span class="s">&#34;MyCompany&#34;</span> <span class="na">UpgradeCode=</span><span class="s">&#34;PUT-GUID-HERE&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Package</span> <span class="na">InstallerVersion=</span><span class="s">&#34;200&#34;</span> <span class="na">Compressed=</span><span class="s">&#34;yes&#34;</span> <span class="na">InstallScope=</span><span class="s">&#34;perMachine&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Media</span> <span class="na">Id=</span><span class="s">&#34;1&#34;</span> <span class="na">Cabinet=</span><span class="s">&#34;media1.cab&#34;</span> <span class="na">EmbedCab=</span><span class="s">&#34;yes&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">&#34;TARGETDIR&#34;</span> <span class="na">Name=</span><span class="s">&#34;SourceDir&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">&#34;ProgramFilesFolder&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">&#34;INSTALLFOLDER&#34;</span> <span class="na">Name=</span><span class="s">&#34;MyApp&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/Directory&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Directory&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Feature</span> <span class="na">Id=</span><span class="s">&#34;MainFeature&#34;</span> <span class="na">Title=</span><span class="s">&#34;MyApp&#34;</span> <span class="na">Level=</span><span class="s">&#34;1&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ComponentGroupRef</span> <span class="na">Id=</span><span class="s">&#34;ProductComponents&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Feature&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Product&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Fragment&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;DirectoryRef</span> <span class="na">Id=</span><span class="s">&#34;INSTALLFOLDER&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Component</span> <span class="na">Id=</span><span class="s">&#34;MyAppExe&#34;</span> <span class="na">Guid=</span><span class="s">&#34;PUT-GUID-HERE&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;File</span> <span class="na">Source=</span><span class="s">&#34;bin\MyApp.exe&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/Component&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Component</span> <span class="na">Id=</span><span class="s">&#34;MyAppDll&#34;</span> <span class="na">Guid=</span><span class="s">&#34;PUT-GUID-HERE&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;File</span> <span class="na">Source=</span><span class="s">&#34;bin\MyLibrary.dll&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/Component&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/DirectoryRef&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Fragment&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Wix&gt;</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="4-advanced-installer">4. <strong>Advanced Installer</strong><a hidden class="anchor" aria-hidden="true" href="#4-advanced-installer">#</a></h4>
<ul>
<li><strong>简介</strong>：Advanced Installer 是一个商业化的安装包创建工具，它提供了图形用户界面 (GUI)，不需要编写脚本，适合那些希望快速生成安装包的开发者。它支持生成 <code>.msi</code> 和 <code>.exe</code> 安装程序，并提供多种安装包配置选项。</li>
<li><strong>主要特点</strong>：
<ul>
<li>提供易于使用的图形界面，适合不熟悉脚本编写的用户。</li>
<li>支持 <code>.exe</code> 和 <code>.msi</code> 两种格式的安装包。</li>
<li>内置丰富的安装选项，包括许可证协议、UI 定制、依赖项检查等。</li>
<li>提供免费版和高级版（付费），高级版支持更多功能。</li>
</ul>
</li>
<li><strong>适用场景</strong>：适合不希望编写脚本的开发者，适用于快速生成安装包的需求，尤其适合小型项目。</li>
<li><strong>使用方法</strong>：
<ol>
<li><a href="https://www.advancedinstaller.com/">下载 Advanced Installer</a> 并安装。</li>
<li>使用 GUI 工具定义要打包的文件和安装逻辑。</li>
<li>生成安装包，无需手动编写脚本。</li>
</ol>
</li>
</ul>
<h4 id="5-installshield">5. <strong>InstallShield</strong><a hidden class="anchor" aria-hidden="true" href="#5-installshield">#</a></h4>
<ul>
<li><strong>简介</strong>：InstallShield 是一款商业化的高级安装包生成工具，广泛应用于企业级项目。它支持生成复杂的安装逻辑，并支持创建 <code>.exe</code>、<code>.msi</code>、跨平台的安装包。InstallShield 常用于需要高级安装选项和大规模分发的场景。</li>
<li><strong>主要特点</strong>：
<ul>
<li>支持创建复杂的安装逻辑，并提供企业级特性（如许可证管理、数据库安装等）。</li>
<li>图形化的用户界面和丰富的功能集，适合大型项目的安装包生成。</li>
<li>支持多语言、多平台安装包的生成。</li>
</ul>
</li>
<li><strong>适用场景</strong>：适合需要复杂安装功能的企业项目，特别是那些需要高度自定义安装流程的场景。</li>
<li><strong>使用方法</strong>：需要购买商业许可证，使用 GUI 工具创建安装程序。</li>
</ul>
<hr>
<h4 id="总结-2">总结<a hidden class="anchor" aria-hidden="true" href="#总结-2">#</a></h4>
<ul>
<li><strong>Inno Setup</strong> 和 <strong>NSIS</strong> 是两款非常流行的开源工具，适合绝大多数中小型项目，且支持高度自定义。</li>
<li><strong>WiX Toolset</strong> 非常适合需要创建企业级 <code>.msi</code> 安装包的场景，但其学习曲线较陡。</li>
<li><strong>Advanced Installer</strong> 和 <strong>InstallShield</strong> 则提供了图形界面，更适合那些不希望编写脚本的开发者或需要高级功能的企业项目。</li>
</ul>
<p>根据项目的规模和复杂度选择合适的打包工具，可以显著提高打包效率并优化安装流程。</p>
</blockquote>
<p>实际使用的感受发现： <strong>Inno Setup</strong>很好用。</p>
<p><strong>因为在后面的测试中发现，由于我安装位置需要发生读写，一般而来，C盘软件的默认安装位置的文件删除、更改等操作是需要管理员权限的，其实这个挺费劲，当然可以以管理员权限重新打开程序（晕到死上很多盗版软件需要这么操作吧？）但更好的方式应该是可以手动设置一个文件夹，这个文件夹是可以支持读写的。</strong></p>
<p>当然，我觉得还有更多的功能可以探索，这个可以需要的时候再去搜索了。</p>
<p>（人可能越来越像发出指令和命令的终端了，因为有人工智能为你实现检索和定位以及回答。。。。）</p>
<p>下面这个是使用Inno Setup的配置文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="k">[Setup]</span>
</span></span><span class="line"><span class="cl"><span class="na">AppName</span><span class="o">=</span><span class="s">MindCloud Renderer</span>
</span></span><span class="line"><span class="cl"><span class="na">AppVersion</span><span class="o">=</span><span class="s">1.0</span>
</span></span><span class="line"><span class="cl"><span class="na">AppPublisher</span><span class="o">=</span><span class="s">Manifold Tech Limited</span>
</span></span><span class="line"><span class="cl"><span class="na">PrivilegesRequired</span><span class="o">=</span><span class="s">admin</span>
</span></span><span class="line"><span class="cl"><span class="na">AppPublisherURL</span><span class="o">=</span><span class="s">https://www.manifoldtech.cn/</span>
</span></span><span class="line"><span class="cl"><span class="c1">; AppSupportURL=https://www.manifoldtech.cn/support</span>
</span></span><span class="line"><span class="cl"><span class="c1">; AppUpdatesURL=https://www.manifoldtech.cn/update</span>
</span></span><span class="line"><span class="cl"><span class="na">DefaultDirName</span><span class="o">=</span><span class="s">{pf}\MindCloud Renderer</span>
</span></span><span class="line"><span class="cl"><span class="na">DefaultGroupName</span><span class="o">=</span><span class="s">MindCloud Renderer</span>
</span></span><span class="line"><span class="cl"><span class="na">OutputBaseFilename</span><span class="o">=</span><span class="s">MindCloud Renderer Installer  </span>
</span></span><span class="line"><span class="cl"><span class="na">Compression</span><span class="o">=</span><span class="s">lzma</span>
</span></span><span class="line"><span class="cl"><span class="na">SolidCompression</span><span class="o">=</span><span class="s">yes</span>
</span></span><span class="line"><span class="cl"><span class="na">VersionInfoVersion</span><span class="o">=</span><span class="s">1.0.0.0</span>
</span></span><span class="line"><span class="cl"><span class="na">VersionInfoCompany</span><span class="o">=</span><span class="s">Manifold Tech Limited</span>
</span></span><span class="line"><span class="cl"><span class="na">VersionInfoDescription</span><span class="o">=</span><span class="s">MindCloud Renderer Application</span>
</span></span><span class="line"><span class="cl"><span class="na">VersionInfoCopyright</span><span class="o">=</span><span class="s">© 2024 Manifold Tech Ltd. All rights reserved.</span>
</span></span><span class="line"><span class="cl"><span class="na">VersionInfoProductName</span><span class="o">=</span><span class="s">MindCloud Renderer</span>
</span></span><span class="line"><span class="cl"><span class="na">VersionInfoProductVersion</span><span class="o">=</span><span class="s">1.0.0.0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Dirs]</span>
</span></span><span class="line"><span class="cl"><span class="c1">; 创建 _internal\datas 目录，并授予 Users 组修改权限</span>
</span></span><span class="line"><span class="cl"><span class="na">Name: &#34;{app}\_internal\datas&#34;; Permissions: users-modify</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Files]</span>
</span></span><span class="line"><span class="cl"><span class="c1">; 递归地复制 dist\MindCloud Renderer 文件夹下的所有内容到安装目录 {app}</span>
</span></span><span class="line"><span class="cl"><span class="na">Source: &#34;C:\Users\Quite\CKCode\3DGSMT\dist\MindCloud Renderer\*&#34;; DestDir: &#34;{app}&#34;; Flags: ignoreversion recursesubdirs createallsubdirs</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Icons]</span>
</span></span><span class="line"><span class="cl"><span class="c1">; 在开始菜单中创建一个指向 MindCloud Renderer.exe 的快捷方式</span>
</span></span><span class="line"><span class="cl"><span class="na">Name: &#34;{group}\MindCloud Renderer&#34;; Filename: &#34;{app}\MindCloud Renderer.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">; 在桌面创建一个指向 MindCloud Renderer.exe 的快捷方式</span>
</span></span><span class="line"><span class="cl"><span class="na">Name: &#34;{commondesktop}\MindCloud Renderer&#34;; Filename: &#34;{app}\MindCloud Renderer.exe&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">[Run]</span>
</span></span><span class="line"><span class="cl"><span class="c1">; Filename: &#34;{app}\MindCloud Renderer.exe&#34;; Description: &#34;Run MindCloud Renderer&#34;; Flags: runasoriginaluser</span>
</span></span></code></pre></div><h3 id="图形化ui">图形化UI<a hidden class="anchor" aria-hidden="true" href="#图形化ui">#</a></h3>
<p>一开始也是搜索得到的信息：</p>
<blockquote>
<p>在给 <strong>Python</strong> 项目添加图形化用户界面（GUI）时，有许多可用的工具和库。每个工具都有不同的特点、优缺点以及适用的场景。以下是常见的 Python GUI 库及其特点和差异：</p>
<h4 id="1-tkinter">1. <strong>Tkinter</strong><a hidden class="anchor" aria-hidden="true" href="#1-tkinter">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：<code>Tkinter</code> 是 Python 标准库自带的 GUI 库，因此不需要额外安装。它是构建简单 GUI 程序的不错选择，非常适合那些希望快速构建 GUI 界面的初学者。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li><strong>易于学习</strong>：由于它是 Python 标准库的一部分，文档丰富且社区支持广泛，适合初学者。</li>
<li><strong>跨平台</strong>：可以在 Windows、macOS 和 Linux 上运行。</li>
<li><strong>轻量级</strong>：适合小型应用程序或简单的工具。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：构建简单的、基本的桌面应用程序。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">root</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Simple GUI&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&#34;Hello, World!&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="2-pyqt">2. <strong>PyQt</strong><a hidden class="anchor" aria-hidden="true" href="#2-pyqt">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：<code>PyQt</code> 是基于 Qt 库的 Python 绑定，提供了丰富的 GUI 组件。它是功能最全、最成熟的 Python GUI 库之一，可以构建复杂的桌面应用程序。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li><strong>功能强大</strong>：支持复杂的 GUI 元素，如菜单、工具栏、状态栏、表格等，适合构建功能复杂的大型应用。</li>
<li><strong>丰富的组件</strong>：Qt 本身就是一个强大的跨平台 GUI 框架，<code>PyQt</code> 继承了 Qt 库的所有功能。</li>
<li><strong>跨平台</strong>：支持 Windows、macOS 和 Linux。</li>
<li><strong>商业化</strong>：<code>PyQt</code> 在商业用途时需要购买许可证，虽然有免费版本，但要注意许可证问题。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：适合需要复杂 UI 和丰富组件的大型桌面应用程序。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QLabel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s1">&#39;Hello, PyQt!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">label</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="3-pyside-qt-for-python">3. <strong>PySide (Qt for Python)</strong><a hidden class="anchor" aria-hidden="true" href="#3-pyside-qt-for-python">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：<code>PySide</code> 和 <code>PyQt</code> 类似，都是 Qt 的 Python 绑定，区别在于 <code>PySide</code> 是由 Qt 官方维护的免费开源版本，并且商业用途也无需许可证。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li><strong>与 PyQt 相似</strong>：与 <code>PyQt</code> 提供的功能几乎相同，API 也很相似。</li>
<li><strong>开源</strong>：<code>PySide</code> 是 LGPL 许可证，因此对于商业用途更加友好。</li>
<li><strong>跨平台</strong>：和 <code>PyQt</code> 一样，支持多平台。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：需要 Qt 的功能，但希望在商业项目中免费使用的场景。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PySide2.QtWidgets</span> <span class="kn">import</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QLabel</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s1">&#39;Hello, PySide!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">label</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="4-kivy">4. <strong>Kivy</strong><a hidden class="anchor" aria-hidden="true" href="#4-kivy">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：<code>Kivy</code> 是一个开源的 Python GUI 库，专注于跨平台开发，特别是移动应用开发。它可以用于构建具有响应式触摸界面的应用程序，支持 Windows、macOS、Linux、iOS 和 Android。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li><strong>跨平台支持</strong>：支持桌面和移动平台，适合开发跨平台应用程序。</li>
<li><strong>响应式界面</strong>：<code>Kivy</code> 允许创建可响应触摸输入的应用，适合平板和手机等触摸设备。</li>
<li><strong>图形化界面定制</strong>：非常适合构建自定义界面和动画丰富的应用。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：适合移动端应用开发，或需要响应式设计的桌面应用。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">kivy.app</span> <span class="kn">import</span> <span class="n">App</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">kivy.uix.label</span> <span class="kn">import</span> <span class="n">Label</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyApp</span><span class="p">(</span><span class="n">App</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Label</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Hello, Kivy!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">MyApp</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="5-wxpython">5. <strong>wxPython</strong><a hidden class="anchor" aria-hidden="true" href="#5-wxpython">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：<code>wxPython</code> 是一个封装了 wxWidgets 的 Python GUI 库。wxWidgets 是一个成熟的 C++ 库，提供了大量的原生 UI 组件，<code>wxPython</code> 则使 Python 程序可以调用这些组件。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li><strong>原生组件</strong>：使用系统的原生控件，因此生成的界面与平台的本地应用界面一致（特别是在 Windows 和 macOS 上）。</li>
<li><strong>跨平台</strong>：支持 Windows、macOS 和 Linux。</li>
<li><strong>功能全面</strong>：拥有大量的控件和布局管理器，适合构建复杂的桌面应用。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：适合需要本地化外观、复杂 GUI 布局的大型应用程序。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">wx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">App</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">frame</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span> <span class="s2">&#34;Hello wxPython&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">frame</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">MainLoop</span><span class="p">()</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="6-dear-pygui">6. <strong>Dear PyGui</strong><a hidden class="anchor" aria-hidden="true" href="#6-dear-pygui">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：<code>Dear PyGui</code> 是一个现代的、基于 GPU 的 Python GUI 库，专注于高效、快速的渲染，特别适合需要高性能的应用，如数据可视化、游戏开发或实时控制应用。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li><strong>GPU 加速</strong>：使用 GPU 渲染界面，因此性能非常好，适合需要大量绘图或动画的应用。</li>
<li><strong>现代设计</strong>：提供了现代化的 UI 组件，如数据表格、绘图、图表等。</li>
<li><strong>跨平台</strong>：支持 Windows、macOS 和 Linux。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：适合开发需要高性能渲染的应用程序，如图形可视化、数据展示和游戏开发。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">dearpygui.dearpygui</span> <span class="k">as</span> <span class="nn">dpg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dpg</span><span class="o">.</span><span class="n">create_context</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">dpg</span><span class="o">.</span><span class="n">window</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&#34;Example Window&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">dpg</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s2">&#34;Hello, Dear PyGui&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dpg</span><span class="o">.</span><span class="n">create_viewport</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Custom Title&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dpg</span><span class="o">.</span><span class="n">setup_dearpygui</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">dpg</span><span class="o">.</span><span class="n">show_viewport</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">dpg</span><span class="o">.</span><span class="n">start_dearpygui</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">dpg</span><span class="o">.</span><span class="n">destroy_context</span><span class="p">()</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="7-flask--electron-或-flask--pywebview">7. <strong>Flask + Electron (或 Flask + Pywebview)</strong><a hidden class="anchor" aria-hidden="true" href="#7-flask--electron-或-flask--pywebview">#</a></h4>
<ul>
<li>
<p><strong>简介</strong>：<code>Flask</code> 本身是一个 Python Web 框架，但是你可以结合 <code>Electron</code> 或 <code>Pywebview</code> 来开发桌面应用。Electron 可以将 Web 应用打包成桌面应用，<code>Pywebview</code> 则提供了一个更轻量的方案。</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
<ul>
<li><strong>跨平台</strong>：可以通过 Electron 或 Pywebview 构建跨平台的桌面应用。</li>
<li><strong>基于 Web 技术</strong>：使用 HTML、CSS 和 JavaScript 构建前端界面，后端逻辑由 Flask 提供。</li>
<li><strong>灵活性高</strong>：前端开发者可以使用现有的 Web 技术栈，非常适合对 Web 开发熟悉的团队。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：适合需要使用 Web 技术栈构建桌面应用的项目，特别是希望利用现有的 Web 开发资源的场景。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Flask 后端</span>
</span></span><span class="line"><span class="cl">from flask import Flask
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">app</span> <span class="o">=</span> Flask<span class="o">(</span>__name__<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@app.route<span class="o">(</span><span class="s1">&#39;/&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">def index<span class="o">()</span>:
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;Hello, Flask + Electron!&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nv">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span>:
</span></span><span class="line"><span class="cl">    app.run<span class="o">()</span>
</span></span></code></pre></div></li>
</ul>
<hr>
<h4 id="总结-3">总结<a hidden class="anchor" aria-hidden="true" href="#总结-3">#</a></h4>
<ul>
<li><strong>Tkinter</strong>：入门简单，适合构建轻量级应用。</li>
<li><strong>PyQt / PySide</strong>：功能强大，适合复杂桌面应用，<code>PySide</code> 适合商业用途。</li>
<li><strong>Kivy</strong>：专注于跨平台和触摸界面，适合移动和桌面双端应用。</li>
<li><strong>wxPython</strong>：提供原生外观控件，适合需要本地化 UI 的项目。</li>
<li><strong>Dear PyGui</strong>：适合高性能的图形和数据可视化应用。</li>
<li><strong>Flask + Electron/Pywebview</strong>：结合 Web 技术构建跨平台桌面应用。</li>
</ul>
<p>根据项目的需求和你的技术栈，选择合适的工具可以帮助你更快地完成 GUI 的开发。</p>
</blockquote>
<p>但我记得，一开始偷懒，写的很low，使用的是tk，就是一个对话窗口，没有设计风格，土土的Windows98的感觉。</p>
<p>然后呢，又发现python脚本启动慢，<mark>后面发现是和import有关系，import可以后置</mark>，然后灵机一动，还搞出来一个程序启动的logo，甚至还加了logo等待，等待import那么大的库完成之后，比如torch之类，再把logo去掉，用户体验上感觉是好多了。</p>
<p>后来，觉得tk太土，尝试使用qt，qt确实好用，可以使用类似css的方式来美化界面，所以就可能搞出很多花里胡哨的设计了，比如什么:</p>
<ol>
<li>动态进度条；</li>
<li>悬置和按压都有效果的按钮；</li>
<li>黄金比例；</li>
<li>各种圆角；</li>
<li>以及好看不违和的表格；</li>
</ol>
<p>扣细节能扣到头皮发麻的那种，并且最重要还不是UI的显示好看与否，而是<mark>qt的槽信号机制太好用了</mark>，可以实现很多想要的功能，比如：</p>
<ol>
<li>
<p>点击一次开始后，就不能点击第二次，除非等到一次运行完成；</p>
</li>
<li>
<p>打开主界面，要能持续运行，点击一次开始，运行完，保存显示，再点击一次，又能重复；</p>
</li>
<li>
<p>点击了恢复任务，就不能再点击其他恢复任务，更不能点击开始任务，反之也是一样；</p>
</li>
<li>
<p>……</p>
</li>
</ol>
<p>可能这些点在app开发的老手来看都是家常便饭，不对确实对于比较系统地从设计到开发的初次尝试者，确实印象很深刻。</p>
<h3 id="node和npm到底是个什么东西">Node和npm到底是个什么东西？<a hidden class="anchor" aria-hidden="true" href="#node和npm到底是个什么东西">#</a></h3>
<p><strong>在打通这个软件的最后一步，是实现点击查看，之前通过web端实现了demo，主要基于three.js的开源方案，在开发阶段这个demo的运行依赖node和npm，当时我是对这两个东西作为工具使用，但直接告诉我，已经用浏览器打开了呀，把html，css，js三个文件放在一起不就行了？如果不行，遇到问题解决问题就是咯！</strong></p>
<p>现在查询和搜索了一些关于node和npm的信息：</p>
<blockquote>
<h4 id="什么是-nodejs-和-npm"><strong>什么是 Node.js 和 npm？</strong><a hidden class="anchor" aria-hidden="true" href="#什么是-nodejs-和-npm">#</a></h4>
<ol>
<li>
<p><strong>Node.js</strong>：</p>
<ul>
<li><strong>Node.js</strong> 是一个基于 <strong>Chrome V8 JavaScript 引擎</strong> 构建的 <strong>JavaScript 运行时环境</strong>。它允许你在 <strong>服务器端</strong> 使用 JavaScript 编写代码，而不仅仅局限于在浏览器中运行 JavaScript。</li>
<li><strong>特点</strong>：
<ul>
<li>它使得 JavaScript 可以用于编写服务器端的应用程序，如后端 API、Web 服务器等。</li>
<li>Node.js 是 <strong>单线程</strong> 的，但通过 <strong>事件驱动</strong> 和 <strong>异步非阻塞 I/O</strong> 模型，非常适合高并发的应用场景。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>npm (Node Package Manager)</strong>：</p>
<ul>
<li><strong>npm</strong> 是 <strong>Node.js</strong> 的包管理器，用于下载、安装、管理 <strong>JavaScript</strong> 项目的依赖包。类似于 Python 的 <code>pip</code> 或 Java 的 <code>Maven</code>。</li>
<li><strong>特点</strong>：
<ul>
<li>你可以使用 <code>npm install</code> 来安装第三方库和依赖包。</li>
<li><code>npm</code> 也允许你运行项目中的脚本命令（如 <code>npm run</code>）。</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h4 id="npm-run-以及与-nodejs-的关系"><strong><code>npm run</code> 以及与 Node.js 的关系</strong><a hidden class="anchor" aria-hidden="true" href="#npm-run-以及与-nodejs-的关系">#</a></h4>
<p>当你运行 <code>npm run start</code> 或类似的命令时，实际上是 <strong>npm</strong> 运行了一个 <strong>脚本</strong>，这个脚本通常会启动一个 <strong>开发服务器</strong>，比如使用 <strong>Webpack</strong>、<strong>Parcel</strong>、<strong>Vite</strong> 或 <strong>Next.js</strong> 等工具来打包、编译项目，并实时更新页面。</p>
<p><strong>npm</strong> 和 <strong>Node.js</strong> 的作用主要在于 <strong>开发阶段</strong>，它们提供了一些工具帮助你快速构建和启动项目，但在实际生产环境中，构建好的项目（即 HTML、CSS、JavaScript 文件）可以独立运行，不再依赖 Node.js 和 npm。</p>
<p><strong>开发阶段使用 <code>npm run</code> 的原因</strong>：</p>
<ul>
<li><strong>打包/编译</strong>：工具如 <strong>Webpack</strong> 或 <strong>Vite</strong> 会将项目中的 <strong>模块化代码</strong> 打包为浏览器可以直接执行的代码。</li>
<li><strong>开发服务器</strong>：启动一个本地服务器，提供热更新（hot-reload）功能，每次你修改文件时，页面自动刷新。</li>
<li><strong>处理静态资源</strong>：如图片、CSS、字体等，这些工具会自动优化和处理静态资源。</li>
</ul>
<p><strong>示例</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scripts&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="s2">&#34;webpack serve --config webpack.config.js&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>当你运行 <code>npm run start</code> 时，实际上是执行了 <code>webpack serve</code>，它启动了 Webpack 的开发服务器，用于开发阶段快速查看效果。</p>
<hr>
<h4 id="理论上讲不依赖-nodejs-和-npm-可以运行-web-应用"><strong>理论上讲，不依赖 Node.js 和 npm 可以运行 Web 应用？</strong><a hidden class="anchor" aria-hidden="true" href="#理论上讲不依赖-nodejs-和-npm-可以运行-web-应用">#</a></h4>
<p><strong>是的，理论上讲，Web 应用并不依赖 Node.js 和 npm</strong>。因为最终的 Web 应用是基于浏览器的，浏览器只需要 <strong>HTML、CSS 和 JavaScript</strong> 文件。这意味着，生产环境中已经打包好的代码可以直接部署到任意 Web 服务器上，浏览器可以直接解析和运行这些文件。</p>
<p><strong>为什么在生产环境不需要 Node.js 和 npm？</strong></p>
<ol>
<li><strong>HTML、CSS 和 JavaScript 是静态文件</strong>，这些文件可以在任何 Web 服务器上运行，如 Apache、Nginx，甚至本地文件系统。</li>
<li><strong>Node.js 和 npm 只是开发工具</strong>，它们帮助开发者在开发阶段进行模块打包、编译、代码分割、性能优化等工作。一旦这些工作完成，生成的文件可以独立运行。</li>
</ol>
<hr>
<h4 id="实际使用场景对比"><strong>实际使用场景对比</strong><a hidden class="anchor" aria-hidden="true" href="#实际使用场景对比">#</a></h4>
<ol>
<li>
<p><strong>开发阶段（依赖 Node.js 和 npm）</strong>：</p>
<ul>
<li>使用 Node.js 和 npm 来管理依赖、启动开发服务器。</li>
<li>使用现代前端工具（如 Webpack、Vite、Babel 等）来处理模块化、编译和打包。</li>
<li>提供热更新（Hot Reloading）、ES6+ 编译、代码压缩等功能。</li>
</ul>
</li>
<li>
<p><strong>生产阶段（不依赖 Node.js 和 npm）</strong>：</p>
<ul>
<li>构建后的文件通常会生成一个静态文件夹（如 <code>dist/</code> 或 <code>build/</code>），其中包含了 HTML、CSS 和编译后的 JavaScript 文件。</li>
<li>部署时，只需将这些静态文件上传到 Web 服务器（如 Apache、Nginx）或内容分发网络（CDN）中，浏览器即可直接加载并运行。</li>
</ul>
</li>
</ol>
<hr>
<h4 id="总结-4"><strong>总结</strong><a hidden class="anchor" aria-hidden="true" href="#总结-4">#</a></h4>
<ul>
<li><strong>Node.js</strong> 是用于在服务器端运行 JavaScript 的环境，适合开发服务器端应用，也在前端开发中用于构建工具。</li>
<li><strong>npm</strong> 是 Node.js 的包管理器，用于管理项目中的依赖库，并运行构建脚本。</li>
<li><strong>npm run</strong> 常用于启动开发服务器或执行构建任务。</li>
<li><strong>Web 应用在生产环境中不需要依赖 Node.js 和 npm</strong>，只需要最终的 HTML、CSS 和 JavaScript 静态文件即可。</li>
</ul>
<p>虽然 <strong>Node.js 和 npm</strong> 在开发阶段提供了许多便利，但在最终的生产环境中，前端项目通常只依赖静态资源，并不需要 Node.js 运行。因此，理论上来说，HTML + CSS + JavaScript 是不依赖于 Node.js 和 npm 的，除非你在使用某些需要服务器端支持的动态功能（如 SSR 或 API）。</p>
</blockquote>
<p>后来其实也是用了python来实现，启动了一个python的web服务，然后也遇到了CORS的问题，查阅收集的信息如下：</p>
<blockquote>
<p>如果不用 <strong>npm</strong> 来启动开发服务器，完全可以使用 <strong>Python</strong> 提供的轻量级服务器来启动 HTML 文件。Python 自带的 HTTP 服务器可以通过简单的命令快速启动，直接服务静态文件，例如 HTML、CSS 和 JavaScript。</p>
<h4 id="使用-python-启动-html-应用">使用 Python 启动 HTML 应用<a hidden class="anchor" aria-hidden="true" href="#使用-python-启动-html-应用">#</a></h4>
<p>在 <strong>Python 3</strong> 中，你可以使用以下命令来启动一个简单的 HTTP 服务器，来服务你当前目录中的文件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## Python 3.x</span>
</span></span><span class="line"><span class="cl">python -m http.server <span class="m">8000</span>
</span></span></code></pre></div><p>这个命令将在当前目录启动一个服务器，并在 <code>http://localhost:8000/</code> 提供访问。通过这个简单的 HTTP 服务器，浏览器可以访问你的 HTML 文件。</p>
<p>然而，使用这种方法在开发过程中，可能会遇到一个常见的问题——<strong>CORS (跨域资源共享)</strong> 问题。</p>
<hr>
<h4 id="什么是-cors-cross-origin-resource-sharing"><strong>什么是 CORS (Cross-Origin Resource Sharing)?</strong><a hidden class="anchor" aria-hidden="true" href="#什么是-cors-cross-origin-resource-sharing">#</a></h4>
<p><strong>CORS</strong> 是浏览器的一种安全机制，防止一个网页在浏览器上从另一个域名、协议或端口请求资源。也就是说，如果网页的资源（例如：JavaScript、CSS、图片）来自与页面不同的域名，浏览器就会根据 CORS 策略限制跨域请求。这种限制防止了潜在的安全风险，比如跨站脚本攻击（XSS）。</p>
<h5 id="cors-问题的触发条件"><strong>CORS 问题的触发条件</strong>：<a hidden class="anchor" aria-hidden="true" href="#cors-问题的触发条件">#</a></h5>
<p>CORS 问题通常在以下场景下会触发：</p>
<ol>
<li><strong>跨域请求</strong>：例如，你的网页在 <code>localhost:8000</code> 上运行，而你请求的 API 在 <code>http://api.example.com</code>，这是两个不同的源，因此浏览器会限制该请求。</li>
<li><strong>AJAX 请求</strong>：当使用 JavaScript 发起 <code>XMLHttpRequest</code> 或 <code>fetch</code> 请求时，目标服务器需要允许跨域请求，否则浏览器会阻止请求并报错。</li>
</ol>
<h5 id="常见的-cors-错误信息"><strong>常见的 CORS 错误信息</strong>：<a hidden class="anchor" aria-hidden="true" href="#常见的-cors-错误信息">#</a></h5>
<p>当出现 CORS 问题时，你会在浏览器控制台中看到类似以下错误：</p>
<pre tabindex="0"><code>Access to fetch at &#39;http://api.example.com/data&#39; from origin &#39;http://localhost:8000&#39; has been blocked by CORS policy: No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource.
</code></pre><hr>
<h4 id="如何解决-cors-问题"><strong>如何解决 CORS 问题？</strong><a hidden class="anchor" aria-hidden="true" href="#如何解决-cors-问题">#</a></h4>
<p>CORS 的解决方案通常分为两种：<strong>服务端配置</strong> 和 <strong>前端解决方案</strong>。解决 CORS 问题的关键在于服务器如何响应请求，并设置适当的 HTTP 头信息来允许跨域。</p>
<h5 id="1-服务端解决方案推荐方式">1. <strong>服务端解决方案（推荐方式）</strong><a hidden class="anchor" aria-hidden="true" href="#1-服务端解决方案推荐方式">#</a></h5>
<p>CORS 问题的最佳解决方式是 <strong>在服务器端配置正确的 CORS 头信息</strong>。服务器需要在响应头中添加 <code>Access-Control-Allow-Origin</code>，明确允许哪些域可以访问该资源。</p>
<ul>
<li>
<p><strong>添加 CORS 头信息</strong>：
服务器需要在响应头中返回以下内容：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">Access-Control-Allow-Origin: *
</span></span></span></code></pre></div><p>这里的 <code>*</code> 表示允许所有来源的跨域请求。也可以将 <code>*</code> 替换为指定的域名，例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">Access-Control-Allow-Origin: http://localhost:8000
</span></span></span></code></pre></div></li>
<li>
<p><strong>其他常见的 CORS 头信息</strong>：</p>
<ul>
<li><code>Access-Control-Allow-Methods</code>：指定允许的 HTTP 请求方法（如 <code>GET</code>、<code>POST</code>）。</li>
<li><code>Access-Control-Allow-Headers</code>：指定允许的自定义请求头。</li>
<li><code>Access-Control-Allow-Credentials</code>：是否允许客户端发送 cookies。</li>
</ul>
<p><strong>示例</strong>：假设你使用的是一个 Flask API，可以使用以下代码来启用 CORS：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;Hello, CORS is enabled!&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></span></code></pre></div><p>通过 <code>CORS(app)</code>，你启用了 CORS 支持，使得不同来源的请求可以访问该服务器。</p>
</li>
</ul>
<h5 id="2-使用前端代理解决-cors">2. <strong>使用前端代理解决 CORS</strong><a hidden class="anchor" aria-hidden="true" href="#2-使用前端代理解决-cors">#</a></h5>
<p>如果你无法控制服务端配置，也可以通过 <strong>前端代理</strong> 的方式来绕过 CORS 问题。前端代理在本地运行一个服务器，将所有请求代理到目标服务器，以此来规避 CORS 限制。</p>
<ul>
<li>
<p><strong>使用 Webpack 的 Dev Server 代理</strong>：
在开发过程中，你可以使用 Webpack 的开发服务器来代理 API 请求。例如，在 <code>webpack.config.js</code> 中添加以下配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">devServer</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">proxy</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;/api&#39;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;http://api.example.com&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">changeOrigin</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pathRewrite</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;^/api&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>通过这种代理方式，前端发出的请求先由 Webpack 的本地服务器处理，再转发到目标 API，从而避免 CORS 限制。</p>
</li>
</ul>
<h5 id="3-在浏览器中禁用-cors开发环境中不推荐用于生产">3. <strong>在浏览器中禁用 CORS（开发环境中，不推荐用于生产）</strong><a hidden class="anchor" aria-hidden="true" href="#3-在浏览器中禁用-cors开发环境中不推荐用于生产">#</a></h5>
<p>在开发环境中，你可以通过一些浏览器扩展或命令行参数来 <strong>禁用 CORS</strong>，这样浏览器就不会阻止跨域请求。不过这种方法仅限于调试，不建议在生产环境中使用，因为它会增加安全风险。</p>
<ul>
<li>
<p><strong>Chrome 中禁用 CORS</strong>：
你可以通过启动 Chrome 时添加以下参数来禁用 CORS：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chrome.exe --disable-web-security --user-data-dir<span class="o">=</span><span class="s2">&#34;C:/ChromeDev&#34;</span>
</span></span></code></pre></div><p>这种方式适合本地开发调试，但切记 <strong>不要在生产环境使用</strong>。</p>
</li>
</ul>
<hr>
<h4 id="总结-5"><strong>总结</strong><a hidden class="anchor" aria-hidden="true" href="#总结-5">#</a></h4>
<ul>
<li><strong>Node.js 和 npm</strong> 提供了开发阶段的便利，但实际上，使用 Python 的 HTTP 服务器等简单工具也能启动和查看 Web 应用。</li>
<li><strong>CORS（跨域资源共享）</strong> 是浏览器的一种安全策略，主要用于防止网页跨域请求资源时的安全问题。</li>
<li><strong>解决 CORS</strong> 问题的最佳方法是在服务器端设置合适的 CORS 头信息，允许客户端跨域访问资源。</li>
<li>如果无法修改服务端配置，前端代理也是一个有效的替代方案。</li>
</ul>
<p>通过理解和正确处理 CORS 问题，你可以在开发和生产环境中避免不必要的跨域错误，从而更高效地开发和部署 Web 应用。</p>
</blockquote>
<h2 id="代码记录">代码记录<a hidden class="anchor" aria-hidden="true" href="#代码记录">#</a></h2>
<h3 id="使用pyqt">使用PyQT<a hidden class="anchor" aria-hidden="true" href="#使用pyqt">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="p">(</span><span class="n">QWidget</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QHeaderView</span><span class="p">,</span> <span class="n">QSpacerItem</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                             <span class="n">QLabel</span><span class="p">,</span> <span class="n">QTableWidget</span><span class="p">,</span> <span class="n">QTableWidgetItem</span><span class="p">,</span> <span class="n">QDialog</span><span class="p">,</span> <span class="n">QProgressBar</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QTimer</span><span class="p">,</span> <span class="n">QPoint</span><span class="p">,</span> <span class="n">QThread</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QPixmap</span><span class="p">,</span> <span class="n">QPainter</span><span class="p">,</span> <span class="n">QColor</span><span class="p">,</span> <span class="n">QFontDatabase</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">,</span> <span class="n">QBrush</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">utils.path_utils</span> <span class="kn">import</span> <span class="n">resource_path</span><span class="p">,</span> <span class="n">get_local_data_directory</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">utils.viewer_utils</span> <span class="kn">import</span> <span class="n">start_http_server</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ServerThread</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;在后台运行 HTTP 服务器&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">start_http_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">InputDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowFlags</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">FramelessWindowHint</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Dialog</span><span class="p">)</span>  <span class="c1"># 无边框窗口，模态对话框</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowModality</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">ApplicationModal</span><span class="p">)</span>  <span class="c1"># 设置为应用程序模态，阻止与其他窗口交互</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_TranslucentBackground</span><span class="p">)</span>  <span class="c1"># 确保背景透明</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">680</span><span class="p">,</span> <span class="mi">420</span><span class="p">)</span>  <span class="c1"># 设置窗口大小</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">common_style</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            background-color: #2a2a2a;
</span></span></span><span class="line"><span class="cl"><span class="s2">            color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">            font-size: 26px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            padding-left: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">combo_box_style</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QComboBox {{
</span></span></span><span class="line"><span class="cl"><span class="s2">                </span><span class="si">{common_style}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            }}
</span></span></span><span class="line"><span class="cl"><span class="s2">            QComboBox::drop-down {{
</span></span></span><span class="line"><span class="cl"><span class="s2">                width: 0px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                border: none;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }}
</span></span></span><span class="line"><span class="cl"><span class="s2">            QComboBox::down-arrow {{
</span></span></span><span class="line"><span class="cl"><span class="s2">                width: 0px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }}
</span></span></span><span class="line"><span class="cl"><span class="s2">            QComboBox QAbstractItemView {{
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #2a2a2a;
</span></span></span><span class="line"><span class="cl"><span class="s2">                color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">                selection-background-color: rgb(87, 204, 153);
</span></span></span><span class="line"><span class="cl"><span class="s2">                selection-color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }}
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">common_style</span><span class="o">=</span><span class="n">common_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">line_edit_style</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QLineEdit {{
</span></span></span><span class="line"><span class="cl"><span class="s2">                </span><span class="si">{common_style}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            }}
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">common_style</span><span class="o">=</span><span class="n">common_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">common_font_style</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            font-size: 26px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            font-weight: bold;
</span></span></span><span class="line"><span class="cl"><span class="s2">            color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">common_grenn_button_style</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(54, 176, 123);
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">                font-size: 26px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:hover { 
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(87, 204, 153); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(42, 137, 96); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">common_red_button_style</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(240, 113, 103); 
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">                font-size: 26px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:hover { 
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(244, 146, 139); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(238, 80, 68); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建名称输入框</span>
</span></span><span class="line"><span class="cl">        <span class="n">name_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&#34;Data Name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">name_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">common_font_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model_name_input</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">(</span><span class="s2">&#34;Untitled&#34;</span><span class="p">)</span>  <span class="c1"># 默认名称</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model_name_input</span><span class="o">.</span><span class="n">setFixedHeight</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># 设置输入框高度为50px</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model_name_input</span><span class="o">.</span><span class="n">setPlaceholderText</span><span class="p">(</span><span class="s2">&#34;Please enter the data name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">model_name_input</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">line_edit_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">name_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">name_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">name_label</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">name_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name_input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 文件选择按钮</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&#34;Select File&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">common_font_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">file_path_input</span> <span class="o">=</span> <span class="n">QLineEdit</span><span class="p">()</span>  <span class="c1"># 展示路径</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">file_path_input</span><span class="o">.</span><span class="n">setFixedHeight</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">file_path_input</span><span class="o">.</span><span class="n">setReadOnly</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">file_path_input</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">line_edit_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_select_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;Browse&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_select_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># 设置按钮的固定大小</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_select_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">common_grenn_button_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_select_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open_file_dialog</span><span class="p">)</span>  <span class="c1"># 绑定点击事件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">file_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">file_label</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path_input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">file_select_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 渲染迭代次数下拉列表</span>
</span></span><span class="line"><span class="cl">        <span class="n">iteration_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&#34;Iterations&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">iteration_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">common_font_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_combo</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_combo</span><span class="o">.</span><span class="n">setFixedHeight</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># 设置下拉框高度为50px</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_combo</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="s2">&#34;3000&#34;</span><span class="p">,</span> <span class="s2">&#34;7000&#34;</span><span class="p">,</span> <span class="s2">&#34;15000&#34;</span><span class="p">,</span> <span class="s2">&#34;1000&#34;</span><span class="p">,</span> <span class="s2">&#34;50&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_combo</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">combo_box_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">iteration_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">iteration_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">iteration_label</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">iteration_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration_combo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 点云密度下拉列表</span>
</span></span><span class="line"><span class="cl">        <span class="n">density_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&#34;Resolution&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">density_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">common_font_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">density_combo</span> <span class="o">=</span> <span class="n">QComboBox</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">density_combo</span><span class="o">.</span><span class="n">setFixedHeight</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># 设置下拉框高度为50px</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">density_combo</span><span class="o">.</span><span class="n">addItems</span><span class="p">([</span><span class="s2">&#34;0.02&#34;</span><span class="p">,</span> <span class="s2">&#34;0.01&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">density_combo</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">combo_box_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">density_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">density_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">density_label</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">density_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">density_combo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 确定和取消按钮</span>
</span></span><span class="line"><span class="cl">        <span class="n">buttons_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;Confirm&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># 设置按钮的固定大小</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">common_grenn_button_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 初始禁用按钮</span>
</span></span><span class="line"><span class="cl">        <span class="n">cancel_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;Cancel&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cancel_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># 设置按钮的固定大小</span>
</span></span><span class="line"><span class="cl">        <span class="n">cancel_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="n">common_red_button_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>  <span class="c1"># 接受输入</span>
</span></span><span class="line"><span class="cl">        <span class="n">cancel_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>  <span class="c1"># 取消输入</span>
</span></span><span class="line"><span class="cl">        <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">buttons_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">cancel_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 添加到布局</span>
</span></span><span class="line"><span class="cl">        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">name_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">file_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">iteration_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">density_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">buttons_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1"># 左上右下</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 监听路径变化以控制 Confirm 按钮的状态</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">file_path_input</span><span class="o">.</span><span class="n">textChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_confirm_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">open_file_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;打开文件选择对话框，选择 lx 文件&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&#34;Select File&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;lx Files (*.lx)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">file_path</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 将路径转换为正斜杠</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">file_path_input</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_confirm_button</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;检查是否选择了文件路径，以控制确认按钮的启用状态&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path_input</span><span class="o">.</span><span class="n">text</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;获取用户输入的所有值&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 定义Windows不允许的字符</span>
</span></span><span class="line"><span class="cl">        <span class="n">invalid_chars</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[&lt;&gt;:&#34;/</span><span class="se">\\</span><span class="s1">|?*]&#39;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 替换模型名称中的非法字符为下划线</span>
</span></span><span class="line"><span class="cl">        <span class="n">model_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">invalid_chars</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name_input</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;model_name&#34;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;file_path&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path_input</span><span class="o">.</span><span class="n">text</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;iterations&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_combo</span><span class="o">.</span><span class="n">currentText</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;density&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">density_combo</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">paintEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;自定义绘制背景以实现倒角&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span> <span class="o">=</span> <span class="n">QPainter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">setRenderHint</span><span class="p">(</span><span class="n">QPainter</span><span class="o">.</span><span class="n">Antialiasing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>  <span class="c1"># 背景颜色</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">NoPen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">drawRoundedRect</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 10px 倒角</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ConfirmDialog</span><span class="p">(</span><span class="n">QDialog</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&#34;Proceed with this action?&#34;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowFlags</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">FramelessWindowHint</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">Dialog</span><span class="p">)</span>  <span class="c1"># 去除边框，设置为对话框模式</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_TranslucentBackground</span><span class="p">)</span>  <span class="c1"># 透明背景</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置布局</span>
</span></span><span class="line"><span class="cl">        <span class="n">layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置窗口大小</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">356</span><span class="p">,</span> <span class="mi">220</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建提示标签</span>
</span></span><span class="line"><span class="cl">        <span class="n">label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;font-weight:bold; font-size: 28px;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建按钮</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">yes_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;Yes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">yes_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>  <span class="c1"># 设置固定的宽度和高度</span>
</span></span><span class="line"><span class="cl">        <span class="n">yes_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(240, 113, 103);
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:hover { 
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(244, 146, 139); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(238, 80, 68); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">yes_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>  <span class="c1"># 绑定确认事件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">no_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;No&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">no_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">no_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(54, 176, 123); 
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:hover { 
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(87, 204, 153); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(42, 137, 96); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">no_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">)</span>  <span class="c1"># 绑定取消事件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">yes_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">no_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">button_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>  <span class="c1"># 调整底部间距为40</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">show_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;显示对话框并返回用户选择&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>  <span class="c1"># 0: reject, 1: accept</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">paintEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 使用 QPainter 绘制整个窗口的背景</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span> <span class="o">=</span> <span class="n">QPainter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">setRenderHint</span><span class="p">(</span><span class="n">QPainter</span><span class="o">.</span><span class="n">Antialiasing</span><span class="p">)</span>  <span class="c1"># 抗锯齿</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>  <span class="c1"># 墨黑色背景</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">NoPen</span><span class="p">)</span>  <span class="c1"># 无边框</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">drawRoundedRect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">(),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 设置圆角半径为 10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 自定义无边框窗口类</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MainWindow</span><span class="p">(</span><span class="n">QWidget</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">comm</span>  <span class="c1"># 传入 Communicator 实例</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 训练状态标志</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">restore_disabled_row</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># 用于记录禁用恢复按钮的行号</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">### 主窗口 ###</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 实现鼠标拖动</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_is_dragging</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start_position</span> <span class="o">=</span> <span class="n">QPoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置窗口始终置顶</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># self.setWindowFlag(Qt.WindowStaysOnTopHint)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&#34;MindCloud Renderer&#34;</span><span class="p">)</span>  <span class="c1"># 设置窗口标题</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowIcon</span><span class="p">(</span><span class="n">QIcon</span><span class="p">(</span><span class="n">resource_path</span><span class="p">(</span><span class="s2">&#34;assets/logo.ico&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowFlag</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">FramelessWindowHint</span><span class="p">)</span>  <span class="c1"># 去除窗口边框</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_TranslucentBackground</span><span class="p">)</span>  <span class="c1"># 设置透明背景以实现无边框设计</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置主窗口大小，黄金比例</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">1618</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QWidget {
</span></span></span><span class="line"><span class="cl"><span class="s2">                font-family: &#39;LXGW WenKai GB Screen&#39;, iconfont;  /* 同时设置文本和图标字体 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                font-size: 26px;  /* 设置全局默认字体大小 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                color: rgb(250, 250, 240);  /* 暖白色 设置全局字体颜色 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 加载字体</span>
</span></span><span class="line"><span class="cl">        <span class="n">font_id_icon</span> <span class="o">=</span> <span class="n">QFontDatabase</span><span class="o">.</span><span class="n">addApplicationFont</span><span class="p">(</span><span class="n">resource_path</span><span class="p">(</span><span class="s2">&#34;assets/iconfont.ttf&#34;</span><span class="p">))</span> <span class="c1"># 动态加载字体</span>
</span></span><span class="line"><span class="cl">        <span class="n">font_family_icon</span> <span class="o">=</span> <span class="n">QFontDatabase</span><span class="o">.</span><span class="n">applicationFontFamilies</span><span class="p">(</span><span class="n">font_id_icon</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># 获取字体的名称</span>
</span></span><span class="line"><span class="cl">        <span class="n">font_id_text</span> <span class="o">=</span> <span class="n">QFontDatabase</span><span class="o">.</span><span class="n">addApplicationFont</span><span class="p">(</span><span class="n">resource_path</span><span class="p">(</span><span class="s2">&#34;assets/textfont.ttf&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">font_family_text</span> <span class="o">=</span> <span class="n">QFontDatabase</span><span class="o">.</span><span class="n">applicationFontFamilies</span><span class="p">(</span><span class="n">font_id_text</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置整体布局</span>
</span></span><span class="line"><span class="cl">        <span class="n">main_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">### 标题栏区域 ###</span>
</span></span><span class="line"><span class="cl">        <span class="n">title_bar</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">title_bar</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># 左上右下</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建应用程序名称</span>
</span></span><span class="line"><span class="cl">        <span class="n">app_name_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&#34;MindCloud Renderer v1.0&#34;</span><span class="p">)</span>  <span class="c1"># 应用程序的名称</span>
</span></span><span class="line"><span class="cl">        <span class="n">app_name_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QLabel {
</span></span></span><span class="line"><span class="cl"><span class="s2">                color: white; 
</span></span></span><span class="line"><span class="cl"><span class="s2">                font-size: 24px; 
</span></span></span><span class="line"><span class="cl"><span class="s2">                font-weight: bold;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 将应用程序名称添加到标题栏的左侧</span>
</span></span><span class="line"><span class="cl">        <span class="n">title_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">app_name_label</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建最小化、最大化和关闭按钮</span>
</span></span><span class="line"><span class="cl">        <span class="n">min_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\uE1A6</span><span class="s2">&#34;</span><span class="p">)</span>  <span class="c1"># &amp;#xe1a6 -&gt; \uE1A6 16进制 Unicode</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\uE1A4</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">close_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\uE1A5</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置按钮大小和样式</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="p">[</span><span class="n">min_button</span><span class="p">,</span> <span class="n">max_button</span><span class="p">,</span> <span class="n">close_button</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: transparent;  /* 透明背景 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                    color: white; 
</span></span></span><span class="line"><span class="cl"><span class="s2">                    border: none;
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">                QPushButton:hover { 
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: #3a3a3a; 
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">                QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: #333333; 
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">title_bar</span><span class="o">.</span><span class="n">addSpacerItem</span><span class="p">(</span><span class="n">QSpacerItem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">))</span> <span class="c1"># 置于窗口最右侧</span>
</span></span><span class="line"><span class="cl">        <span class="n">title_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">min_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">title_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">max_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">title_bar</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">close_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 按钮点击事件绑定</span>
</span></span><span class="line"><span class="cl">        <span class="n">min_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">showMinimized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_max_restore</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">close_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confirm_close</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 追踪最大化状态</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">is_maximized</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 添加标题栏到主布局</span>
</span></span><span class="line"><span class="cl">        <span class="n">main_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">title_bar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">### 左侧按钮区域 ###</span>
</span></span><span class="line"><span class="cl">        <span class="n">left_panel</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">left_panel</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 去除内边距</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 添加 logo 的 QLabel</span>
</span></span><span class="line"><span class="cl">        <span class="n">logo_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">logo_pixmap</span> <span class="o">=</span> <span class="n">QPixmap</span><span class="p">(</span><span class="n">resource_path</span><span class="p">(</span><span class="s2">&#34;assets/lx_logo.png&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">logo_pixmap</span> <span class="o">=</span> <span class="n">logo_pixmap</span><span class="o">.</span><span class="n">scaled</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">,</span> <span class="n">Qt</span><span class="o">.</span><span class="n">SmoothTransformation</span><span class="p">)</span>  <span class="c1"># 调整 logo 的大小</span>
</span></span><span class="line"><span class="cl">        <span class="n">logo_label</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">logo_pixmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 将 logo QLabel 添加到左侧面板</span>
</span></span><span class="line"><span class="cl">        <span class="n">left_panel</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">logo_label</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignTop</span> <span class="o">|</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AlignHCenter</span><span class="p">)</span>  <span class="c1"># 顶部对齐、水平居中对齐</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 添加一个可扩展空白项，保持按钮和logo之间的弹性空间</span>
</span></span><span class="line"><span class="cl">        <span class="n">left_panel</span><span class="o">.</span><span class="n">addSpacerItem</span><span class="p">(</span><span class="n">QSpacerItem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Minimum</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">.</span><span class="n">Expanding</span><span class="p">))</span>  <span class="c1"># 上下扩展</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建按钮</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">new_task_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">new_task_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">194</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>  <span class="c1"># 设置按钮尺寸，宽 高，黄金比例</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建图标和文本标签</span>
</span></span><span class="line"><span class="cl">        <span class="n">icon_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\uE1A3</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">icon_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;font-size: 48px; color: white; padding-top: 10px&#34;</span><span class="p">)</span>  <span class="c1"># 设置图标颜色</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">text_label</span> <span class="o">=</span> <span class="n">QLabel</span><span class="p">(</span><span class="s2">&#34;Create&#34;</span><span class="p">)</span>  <span class="c1"># 按钮下方的文字</span>
</span></span><span class="line"><span class="cl">        <span class="n">text_label</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;font-size: 28px; font-weight: bold; color: white; padding-bottom: 10px&#34;</span><span class="p">)</span>  <span class="c1"># 设置文字大小和颜色</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建垂直布局，将图标和文字添加到布局</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 去除内边距</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置图标和文字水平居中</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">icon_label</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignHCenter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">text_label</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignHCenter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 将布局设置为按钮的布局</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">new_task_button</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">button_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置按钮的样式</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">new_task_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #2a2a2a;
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:hover { 
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #3a3a3a; 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #333333; 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 按钮点击时，发射信号，并附带参数</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">new_task_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">show_input_dialog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 添加按钮到左侧面板并设置水平居中</span>
</span></span><span class="line"><span class="cl">        <span class="n">left_panel</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_task_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">### 中间显示区域（右侧） ###</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress_height</span> <span class="o">=</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_width</span> <span class="o">=</span> <span class="mi">131</span>
</span></span><span class="line"><span class="cl">        <span class="c1">### 进度条 ###</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span> <span class="o">=</span> <span class="n">QProgressBar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setMaximum</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>  <span class="c1"># 扩大100倍，以便显示小数点后两位</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 初始值为0</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setTextVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 默认不显示文字（包含按钮文字）</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 默认不显示</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>  <span class="c1"># 居中显示文字</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 浮点数值</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setFixedHeight</span><span class="p">(</span><span class="n">progress_height</span><span class="p">)</span>  <span class="c1"># 设置固定高度</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 自定义进度条样式</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QProgressBar {
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                text-align: center;
</span></span></span><span class="line"><span class="cl"><span class="s2">                color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #2a2a2a;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QProgressBar::chunk {
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 5px; /* 圆角比较小，适应进度为1%的情况 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                background: qlineargradient(
</span></span></span><span class="line"><span class="cl"><span class="s2">                    spread: pad,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    x1: 0, y1: 0, x2: 1, y2: 0,
</span></span></span><span class="line"><span class="cl"><span class="s2">                    stop: 0 rgb(54, 176, 123),  /* 渐变起点颜色 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                    stop: 1 rgb(87, 204, 153)  /* 渐变终点颜色 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                );
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建取消按钮</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;Cancel&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="n">button_width</span><span class="p">,</span> <span class="n">progress_height</span><span class="p">)</span>  <span class="c1"># 设置按钮大小</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(240, 113, 103);
</span></span></span><span class="line"><span class="cl"><span class="s2">                color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:hover { 
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(244, 146, 139); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(238, 80, 68); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }  
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confirm_cancel_training</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 默认隐藏按钮</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建确认按钮</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;Confirm&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="n">button_width</span><span class="p">,</span> <span class="n">progress_height</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(54, 176, 123);
</span></span></span><span class="line"><span class="cl"><span class="s2">                color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:hover { 
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(87, 204, 153); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(42, 137, 96); 
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confirm_complete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建水平布局（包括进度条和取消按钮）</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 移除进度条所在布局的内边距</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 将水平布局包装到一个 QWidget 中</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress_widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">progress_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 省略号效果</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 增加一个空格</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ellipsis_states</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34; ⠂⠄⠄&#34;</span><span class="p">,</span> <span class="s2">&#34; ⠄⠂⠄&#34;</span><span class="p">,</span> <span class="s2">&#34; ⠄⠄⠂&#34;</span><span class="p">,</span> <span class="s2">&#34; ⠄⠄⠄&#34;</span><span class="p">]</span>  <span class="c1"># Unicode 省略号效果</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">current_ellipsis_index</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建一个 QTimer 定时器，每333ms更新一次省略号效果（程序开始时就启动）</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ellipsis_timer</span> <span class="o">=</span> <span class="n">QTimer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ellipsis_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_ellipsis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">ellipsis_timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">333</span><span class="p">)</span>  <span class="c1"># 333ms</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 信号连接 </span>
</span></span><span class="line"><span class="cl">        <span class="n">comm</span><span class="o">.</span><span class="n">start_signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_progress_bar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">comm</span><span class="o">.</span><span class="n">progress_signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_progress_bar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">comm</span><span class="o">.</span><span class="n">training_complete</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_complete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">on_saving</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">comm</span><span class="o">.</span><span class="n">saving_signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_saving_trigger</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">### 历史记录表格 ###</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建表头和内容区域</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_table</span> <span class="o">=</span> <span class="n">QTableWidget</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 只作为表头</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span> <span class="o">=</span> <span class="n">QTableWidget</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 放内容的表格</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;Data Name&#34;</span><span class="p">,</span> <span class="s2">&#34;Creation Time&#34;</span><span class="p">,</span> <span class="s2">&#34;Status&#34;</span><span class="p">,</span> <span class="s2">&#34;Actions&#34;</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="o">.</span><span class="n">setHorizontalHeaderLabels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_labels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置表格整体样式，包括表头和行号</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QTableWidget {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #2a2a2a;  /* 较亮的灰色背景 */                  
</span></span></span><span class="line"><span class="cl"><span class="s2">                gridline-color: transparent;  /* 隐藏表格的线条 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                border: none;  /* 隐藏表格的边框 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-top-left-radius: 10px;  /* 手柄底部左角圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-top-right-radius: 10px; /* 手柄底部右角圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QHeaderView {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: transparent;  /* 设置表头背景透明 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                font-size: 28px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                font-weight: bold;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QHeaderView::section {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #3a3a3a;  /* 设置表头和行号的背景颜色 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                border: none;
</span></span></span><span class="line"><span class="cl"><span class="s2">                padding: 15px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            /* 设置表头的左上角圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            QHeaderView::section:first {
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-top-left-radius: 10px;    /* 设置左上角圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            /* 设置表头的右上角圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            QHeaderView::section:last {
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-top-right-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QHeaderView::up-arrow, QHeaderView::down-arrow {
</span></span></span><span class="line"><span class="cl"><span class="s2">                image: none;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置内容区域的样式</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QTableWidget {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #2a2a2a;  /* 较亮的灰色背景 */                  
</span></span></span><span class="line"><span class="cl"><span class="s2">                gridline-color: transparent;  /* 隐藏表格的线条 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                border: none;  /* 隐藏表格的边框 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-bottom-left-radius: 10px;  /* 手柄底部左角圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-bottom-right-radius: 10px; /* 手柄底部右角圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QTableWidget::item {
</span></span></span><span class="line"><span class="cl"><span class="s2">                border: none;  /* 隐藏单元格的边框 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            }                    
</span></span></span><span class="line"><span class="cl"><span class="s2">            QScrollBar:vertical {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: transparent;  /* 滚动条背景 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                width: 15px;  /* 滚动条宽度 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 5px;  /* 滚动条圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                margin-top: 1px;  /* 顶部留空 1px */
</span></span></span><span class="line"><span class="cl"><span class="s2">                margin-bottom: 1px;  /* 底部留空 1px */
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            /* 滚动条手柄，默认状态 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            QScrollBar::handle:vertical {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #3a3a3a;  /* 手柄默认颜色 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 5px;  /* 手柄的圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                min-height: 20px;  /* 手柄最小高度，防止变得太小 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            /* 鼠标悬停时手柄的颜色 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            QScrollBar::handle:vertical:hover {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #4a4a4a;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            /* 鼠标点击拖动手柄时的颜色 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            QScrollBar::handle:vertical:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: #333333;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            /* 滚动条两端的按钮（上箭头和下箭头），隐藏它们 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background: none;
</span></span></span><span class="line"><span class="cl"><span class="s2">                width: 0px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                height: 0px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            /* 滚动条的上、下部分留白区域 */
</span></span></span><span class="line"><span class="cl"><span class="s2">            QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background: none;
</span></span></span><span class="line"><span class="cl"><span class="s2">                width: 0px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                height: 0px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 调整表头的高度</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="o">.</span><span class="n">setFixedHeight</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>  <span class="c1"># 表头的高度固定为80px</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 隐藏表头的第一列</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="o">.</span><span class="n">setColumnHidden</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置表内容</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;color: white;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;color: white;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置每行的默认高度</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setDefaultSectionSize</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="c1"># 禁用内容表格的表头</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 隐藏列序号</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">verticalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置表格的列宽自适应</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSectionResizeMode</span><span class="p">(</span><span class="n">QHeaderView</span><span class="o">.</span><span class="n">Stretch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 表头内容和内容表格列宽同步，保持水平滚动条同步</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">horizontalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="o">.</span><span class="n">horizontalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">setValue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置表头可以点击排序</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">setSortingEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 使内容表格支持排序</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="o">.</span><span class="n">setSortingEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># 表头支持点击排序</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 捕捉表头点击事件</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">sectionClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_header_icons</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 布局：将表头和表格内容组合</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建一个 QWidget 来包含 table_layout</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">table_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">### 更新历史记录 ###</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">history_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populate_history_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建右侧布局，用来放置进度条和表格</span>
</span></span><span class="line"><span class="cl">        <span class="n">right_panel</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 添加进度条和表格到右侧布局</span>
</span></span><span class="line"><span class="cl">        <span class="n">right_panel</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">progress_widget</span><span class="p">)</span>  <span class="c1"># 将进度条添加到表格上方</span>
</span></span><span class="line"><span class="cl">        <span class="n">right_panel</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">table_widget</span><span class="p">)</span>  <span class="c1"># 将表格添加到进度条下方</span>
</span></span><span class="line"><span class="cl">        <span class="n">right_panel</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 移除右侧布局的内边距</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">### 组合左侧面板和右侧显示区域 ###</span>
</span></span><span class="line"><span class="cl">        <span class="n">content_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">content_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">left_panel</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 左侧的内容</span>
</span></span><span class="line"><span class="cl">        <span class="n">content_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">right_panel</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 右侧的内容，比例3：1</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">main_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">content_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#! 这里也取巧了，如果在这里绑定按钮，可以应用到上层的CSS效果</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rebind_buttons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">### 绑定禁用按钮的信号 ###</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">disable_restore_buttons_signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_restore_buttons_in_row</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;鼠标按下事件：记录鼠标初始位置&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isMaximized</span><span class="p">():</span>  <span class="c1"># 禁止在最大化状态下拖动</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 检查鼠标是否点击在标题栏区域</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">80</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_is_dragging</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start_position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">globalPos</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">frameGeometry</span><span class="p">()</span><span class="o">.</span><span class="n">topLeft</span><span class="p">()</span>  <span class="c1"># 记录鼠标相对窗口的位置</span>
</span></span><span class="line"><span class="cl">            <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mouseMoveEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;鼠标移动事件：当鼠标按下时，拖动窗口&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_dragging</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isMaximized</span><span class="p">():</span>  <span class="c1"># 禁止在最大化状态下拖动</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">globalPos</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_start_position</span><span class="p">)</span>  <span class="c1"># 计算并设置新的窗口位置</span>
</span></span><span class="line"><span class="cl">            <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;鼠标释放事件：停止拖动&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">()</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">LeftButton</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_is_dragging</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 停止拖动</span>
</span></span><span class="line"><span class="cl">            <span class="n">event</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_ellipsis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;更新省略号效果，根据不同的进度显示不同的文本&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取当前的省略号状态</span>
</span></span><span class="line"><span class="cl">        <span class="n">ellipsis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ellipsis_states</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ellipsis_index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 数据加载阶段</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&#34;Canceling&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_text</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>  <span class="c1"># 不显示百分比</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">==</span> <span class="mi">101</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 渲染完成状态</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&#34;Finished&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_text</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 数据加载阶段</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&#34;Loading&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_text</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>  <span class="c1"># 不显示百分比</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_saving</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 保存阶段</span>
</span></span><span class="line"><span class="cl">                <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&#34;Saving&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">progress_text</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>  <span class="c1"># 不显示百分比</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 渲染阶段</span>
</span></span><span class="line"><span class="cl">                <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&#34;Rendering&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">progress_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&#34;</span>  <span class="c1"># 显示百分比</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 进度为100%时，停止省略号效果，并显示完成状态</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&#34;Complete&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_text</span> <span class="o">=</span> <span class="s2">&#34;(100%)&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                QProgressBar {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    border-radius: 10px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    text-align: center;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    color: white;
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: #2a2a2a;
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">                QProgressBar::chunk {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    border-radius: 10px; /* 圆角比较大，适应进度为100%的情况 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background: rgb(87, 204, 153)
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 隐藏取消按钮</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 更新进度条的文本</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setFormat</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">status_text</span><span class="si">}{</span><span class="n">ellipsis</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">!=</span> <span class="mi">100</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">progress_text</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 循环更新下一个省略号状态</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">current_ellipsis_index</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_ellipsis_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ellipsis_states</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_saving_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;保存状态触发&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">on_saving</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;启动进度条&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># 设置训练状态为 True</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 重置进度值</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">on_saving</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 重置保存状态</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 重置进度条</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setTextVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 显示文字</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 显示取消按钮</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 取消按钮可用</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 确认按钮可用</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#TODO</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">cancel_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;取消训练任务&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 触发信号或操作以停止训练线程</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;用户取消渲染&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 设置训练状态为 False</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 禁用取消按钮</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">cancel_button</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 隐藏取消按钮</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">cancel_signal</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>  <span class="c1"># 触发取消训练信号</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># 设置进度为 -1，表示取消</span>
</span></span><span class="line"><span class="cl">        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_progress_bar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">history_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populate_history_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rebind_buttons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">confirm_cancel_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;弹出确认框并在确认后取消训练&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">confirm_dialog</span> <span class="o">=</span> <span class="n">ConfirmDialog</span><span class="p">(</span><span class="s2">&#34;Cancel this action?&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">confirm_dialog</span><span class="o">.</span><span class="n">show_confirmation</span><span class="p">()</span> <span class="o">==</span> <span class="n">QDialog</span><span class="o">.</span><span class="n">Accepted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">cancel_training</span><span class="p">()</span>  <span class="c1"># 用户确认后取消训练</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;取消操作取消&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#TODO</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">confirm_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;确认任务完成&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;用户确认完成&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 设置训练状态为 False</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 隐藏确认按钮</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">confirm_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># 禁用确认按钮</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">=</span> <span class="mi">101</span>  <span class="c1"># 设置进度为 101，表示完成</span>
</span></span><span class="line"><span class="cl">        <span class="n">QTimer</span><span class="o">.</span><span class="n">singleShot</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hide_progress_bar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">hide_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;隐藏进度条&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setVisible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;更新进度条&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_value</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="c1">#TODO</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">training_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;训练完成后隐藏进度条&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">history_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">populate_history_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">rebind_buttons</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_header_icons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logicalIndex</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;根据排序顺序更新表头的 iconfont 图标&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取当前列的排序顺序（初始时没有排序状态时，默认为升序）</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">sortIndicatorSection</span><span class="p">()</span> <span class="o">==</span> <span class="n">logicalIndex</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果当前列是已经排序的列，那么获取其排序顺序并翻转它</span>
</span></span><span class="line"><span class="cl">            <span class="n">sort_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">sortIndicatorOrder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">sort_order</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">DescendingOrder</span> <span class="k">if</span> <span class="n">sort_order</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AscendingOrder</span> <span class="k">else</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AscendingOrder</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果是新列，默认为升序</span>
</span></span><span class="line"><span class="cl">            <span class="n">sort_order</span> <span class="o">=</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AscendingOrder</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 初始化原始表头标签</span>
</span></span><span class="line"><span class="cl">        <span class="n">base_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;Data Name&#34;</span><span class="p">,</span> <span class="s2">&#34;Creation Time&#34;</span><span class="p">,</span> <span class="s2">&#34;Status&#34;</span><span class="p">,</span> <span class="s2">&#34;Actions&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 复制 base_labels 以用于更新</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">header_labels</span> <span class="o">=</span> <span class="n">base_labels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 检查 logicalIndex 是否在 base_labels 的范围内</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">logicalIndex</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_labels</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 动态更新点击的列，其他列保持原样</span>
</span></span><span class="line"><span class="cl">            <span class="n">icon</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\uE1A1</span><span class="s2">&#34;</span> <span class="k">if</span> <span class="n">sort_order</span> <span class="o">==</span> <span class="n">Qt</span><span class="o">.</span><span class="n">AscendingOrder</span> <span class="k">else</span> <span class="s2">&#34;</span><span class="se">\uE1A2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 更新 logicalIndex 对应列的图标</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">header_labels</span><span class="p">[</span><span class="n">logicalIndex</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">base_labels</span><span class="p">[</span><span class="n">logicalIndex</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 更新表头标签</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">header_table</span><span class="o">.</span><span class="n">setHorizontalHeaderLabels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_labels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 对内容表格进行排序</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">sortItems</span><span class="p">(</span><span class="n">logicalIndex</span><span class="p">,</span> <span class="n">sort_order</span><span class="p">)</span>  <span class="c1"># 让内容表格根据相同的列进行排序</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置当前表格的排序状态</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">horizontalHeader</span><span class="p">()</span><span class="o">.</span><span class="n">setSortIndicator</span><span class="p">(</span><span class="n">logicalIndex</span><span class="p">,</span> <span class="n">sort_order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Warning: logicalIndex </span><span class="si">{</span><span class="n">logicalIndex</span><span class="si">}</span><span class="s2"> is out of range for header labels.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">show_input_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;弹出输入对话框&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dialog</span> <span class="o">=</span> <span class="n">InputDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">dialog</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span> <span class="o">==</span> <span class="n">QDialog</span><span class="o">.</span><span class="n">Accepted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">inputs</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;用户输入：</span><span class="si">{</span><span class="n">inputs</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">emit_training_signal</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">emit_training_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;通过信号发射用户输入的数据&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">model_name</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&#34;model_name&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">source_path</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&#34;file_path&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&#34;iterations&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">density</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&#34;density&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取当前时间戳，格式为：2024-08-22 23:43:29</span>
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">unique_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">training_params_signal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">unique_hash</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">populate_history_table_demo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#TODO 通过文件实际读取数据 (这里是样例数据)</span>
</span></span><span class="line"><span class="cl">        <span class="n">history_data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;loft 2024-07-18 08:58:00 2024-07-18 08:58:00 2024-07-18 08:58:00&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-07-18 08:58:00&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/loft&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;room&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-08-22 23:43:29&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/room&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;playroom&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-09-10 18:18:20&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A8</span><span class="s2"> Incomplete&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/playroom&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;loft&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-07-18 08:58:00&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/loft&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;room&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-08-22 23:43:29&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/room&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;playroom&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-09-10 18:18:20&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A8</span><span class="s2"> Incomplete&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/playroom&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;loft&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-07-18 08:58:00&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/loft&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;room&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-08-22 23:43:29&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/room&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;playroom&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-09-10 18:18:20&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A8</span><span class="s2"> Incomplete&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/playroom&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;loft&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-07-18 08:58:00&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/loft&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;room&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-08-22 23:43:29&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/room&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;playroom&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-09-10 18:18:20&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A8</span><span class="s2"> Incomplete&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/playroom&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;loft&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-07-18 08:58:00&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/loft&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;room&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-08-22 23:43:29&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/room&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;playroom&#34;</span><span class="p">,</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2024-09-10 18:18:20&#34;</span><span class="p">,</span> <span class="s2">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\uE1A8</span><span class="s2"> Incomplete&#34;</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;C:/Users/Quite/CKCode/CKData/MT20240318-184924/mt_output/playroom&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 清空表格</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 增加隐藏列</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 隐藏第一列</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="n">setColumnHidden</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">row_data</span> <span class="ow">in</span> <span class="n">history_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">row_position</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">row_position</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 创建并设置每一列的单元格</span>
</span></span><span class="line"><span class="cl">            <span class="n">name_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">row_data</span><span class="p">[</span><span class="s2">&#34;name&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">row_data</span><span class="p">[</span><span class="s2">&#34;timestamp&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">row_data</span><span class="p">[</span><span class="s2">&#34;status&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置状态单元格的颜色，根据不同状态来设置颜色</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;Completed&#34;</span> <span class="ow">in</span> <span class="n">row_data</span><span class="p">[</span><span class="s2">&#34;status&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">status_item</span><span class="o">.</span><span class="n">setForeground</span><span class="p">(</span><span class="n">QBrush</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="mi">87</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">153</span><span class="p">)))</span>  <span class="c1"># 设置字体颜色为舒适的绿色</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s2">&#34;Incomplete&#34;</span> <span class="ow">in</span> <span class="n">row_data</span><span class="p">[</span><span class="s2">&#34;status&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">status_item</span><span class="o">.</span><span class="n">setForeground</span><span class="p">(</span><span class="n">QBrush</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">103</span><span class="p">)))</span>  <span class="c1"># 设置字体颜色为柔和的红色</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 存储文件路径为 `Qt.UserRole` 数据</span>
</span></span><span class="line"><span class="cl">            <span class="n">name_item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span><span class="p">,</span> <span class="n">row_data</span><span class="p">[</span><span class="s2">&#34;path&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置每个单元格内容居中</span>
</span></span><span class="line"><span class="cl">            <span class="n">name_item</span><span class="o">.</span><span class="n">setTextAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp_item</span><span class="o">.</span><span class="n">setTextAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_item</span><span class="o">.</span><span class="n">setTextAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">name_item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">name_item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp_item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">timestamp_item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">status_item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 插入数据到表格</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#! 这里取巧了，用了五列来避免第一列（索引0）插入导致后面的错误</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_position</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name_item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_position</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">timestamp_item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_position</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">status_item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">table</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">populate_history_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 清空表格</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="n">setRowCount</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="n">setColumnCount</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>  <span class="c1"># 增加隐藏列</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 隐藏第一列和第六列</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="n">setColumnHidden</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="n">setColumnHidden</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;读取历史记录并填充表格&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取 LOCALAPPDATA 环境变量</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_app_data</span> <span class="o">=</span> <span class="n">get_local_data_directory</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 拼接历史记录文件路径</span>
</span></span><span class="line"><span class="cl">        <span class="n">history_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_app_data</span><span class="p">,</span> <span class="s1">&#39;MindCloud Renderer&#39;</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果文件不存在，则直接返回</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">history_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;历史记录文件不存在：</span><span class="si">{</span><span class="n">history_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">table</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 读取历史记录文件内容</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">history_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 遍历历史记录并填充表格</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">model_name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&#34;model_name&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&#34;timestamp&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_path</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&#34;file_path&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_id</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 检查文件是否存在，决定状态</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;文件存在：</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\uE1A7</span><span class="s2"> Completed&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;文件不存在：</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\uE1A8</span><span class="s2"> Incomplete&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 获取当前表格行数，插入新行</span>
</span></span><span class="line"><span class="cl">            <span class="n">row_position</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">insertRow</span><span class="p">(</span><span class="n">row_position</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置每一列的数据</span>
</span></span><span class="line"><span class="cl">            <span class="n">id_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">unique_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">name_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置状态单元格的颜色，根据不同状态来设置颜色</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;Completed&#34;</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">status_item</span><span class="o">.</span><span class="n">setForeground</span><span class="p">(</span><span class="n">QBrush</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="mi">87</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">153</span><span class="p">)))</span>  <span class="c1"># 设置字体颜色为绿色</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s2">&#34;Incomplete&#34;</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">status_item</span><span class="o">.</span><span class="n">setForeground</span><span class="p">(</span><span class="n">QBrush</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">103</span><span class="p">)))</span>  <span class="c1"># 设置字体颜色为红色</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 存储文件路径为 `Qt.UserRole` 数据</span>
</span></span><span class="line"><span class="cl">            <span class="n">name_item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 设置每个单元格内容居中</span>
</span></span><span class="line"><span class="cl">            <span class="n">name_item</span><span class="o">.</span><span class="n">setTextAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp_item</span><span class="o">.</span><span class="n">setTextAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_item</span><span class="o">.</span><span class="n">setTextAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 禁用单元格的选择和编辑</span>
</span></span><span class="line"><span class="cl">            <span class="n">name_item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">name_item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">timestamp_item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">timestamp_item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">status_item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 插入数据到表格</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_position</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name_item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_position</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">timestamp_item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_position</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">status_item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row_position</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">id_item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">table</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">rebind_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_delete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        绑定表格中的按钮点击事件。
</span></span></span><span class="line"><span class="cl"><span class="s2">        - row: 如果提供了行号，则只绑定该行的按钮；否则重新绑定整个表格的按钮。
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">row_count</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># 仅重新绑定特定行和之后的行</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">row_count</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_bind_button_for_row</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 绑定所有行</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row_count</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_bind_button_for_row</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 禁用恢复按钮</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">disable_restore_buttons_in_row</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">is_delete</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_disabled_row</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">restore_disabled_row</span> <span class="o">-=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">disable_restore_buttons_in_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restore_disabled_row</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_bind_button_for_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        绑定特定行的查看和删除按钮。
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取状态项内容，用于判断按钮类型</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_item</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_text</span> <span class="o">=</span> <span class="n">status_item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取模型名称和任务ID</span>
</span></span><span class="line"><span class="cl">        <span class="n">model_name</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">task_id</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 判断是否为“已完成”还是“进行中”</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;Completed&#34;</span> <span class="ow">in</span> <span class="n">status_text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">action_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;View&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">action_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: rgb(54, 176, 123);  /* 默认绿色背景 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                    border-radius: 10px;  /* 圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                    padding: 5px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">                QPushButton:hover {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: rgb(87, 204, 153);  /* 悬停时更亮的绿色 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">                QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: rgb(42, 137, 96);  /* 按下时更深的绿色 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 绑定“查看”按钮的点击事件</span>
</span></span><span class="line"><span class="cl">            <span class="n">action_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">checked</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">row</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_file_from_row</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">task_id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>  <span class="c1"># 进行中，设置为“继续”按钮</span>
</span></span><span class="line"><span class="cl">            <span class="n">action_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;Restore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">action_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: rgb(255, 159, 28);  /* 橙色背景 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                    border-radius: 10px;  /* 圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                    padding: 5px;
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">                QPushButton:hover {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: rgb(255, 191, 102);  /* 悬停时变亮 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">                QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                    background-color: rgb(230, 134, 0);  /* 按下时更深 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                }
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 绑定“继续”按钮的点击事件</span>
</span></span><span class="line"><span class="cl">            <span class="n">action_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">checked</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">row</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_training_from_row</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 删除按钮：红色背景</span>
</span></span><span class="line"><span class="cl">        <span class="n">delete_button</span> <span class="o">=</span> <span class="n">QPushButton</span><span class="p">(</span><span class="s2">&#34;Delete&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delete_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delete_button</span><span class="o">.</span><span class="n">setStyleSheet</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(240, 113, 103); 
</span></span></span><span class="line"><span class="cl"><span class="s2">                border-radius: 10px;  /* 圆角 */
</span></span></span><span class="line"><span class="cl"><span class="s2">                padding: 5px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:hover {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(244, 146, 139);
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">            QPushButton:pressed {
</span></span></span><span class="line"><span class="cl"><span class="s2">                background-color: rgb(238, 80, 68);
</span></span></span><span class="line"><span class="cl"><span class="s2">            }
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 重新绑定按钮的点击事件，更新每行的 row 索引</span>
</span></span><span class="line"><span class="cl">        <span class="n">delete_button</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">checked</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">row</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_delete_file_from_row</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 设置按钮大小</span>
</span></span><span class="line"><span class="cl">        <span class="n">action_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delete_button</span><span class="o">.</span><span class="n">setFixedSize</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建水平布局（左右）</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span> <span class="o">=</span> <span class="n">QHBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">setSpacing</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># 设置按钮之间的间距</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置内边距为0</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>  <span class="c1"># 左右居中</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">action_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_layout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="n">delete_button</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 创建垂直布局，将水平布局包裹以实现上下左右居中</span>
</span></span><span class="line"><span class="cl">        <span class="n">outer_layout</span> <span class="o">=</span> <span class="n">QVBoxLayout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">outer_layout</span><span class="o">.</span><span class="n">addLayout</span><span class="p">(</span><span class="n">button_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">outer_layout</span><span class="o">.</span><span class="n">setContentsMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 设置内边距为0</span>
</span></span><span class="line"><span class="cl">        <span class="n">outer_layout</span><span class="o">.</span><span class="n">setAlignment</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">)</span>  <span class="c1"># 上下居中</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 将布局添加到 QWidget 并设置为表格的单元格内容</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_widget</span> <span class="o">=</span> <span class="n">QWidget</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">button_widget</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">outer_layout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 禁止按钮所在单元格的点击</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span> <span class="o">=</span> <span class="n">QTableWidgetItem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span><span class="o">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="n">setItem</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>  <span class="c1"># 操作列为第4列</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 将按钮布局到表格  </span>
</span></span><span class="line"><span class="cl">        <span class="n">table</span><span class="o">.</span><span class="n">setCellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">button_widget</span><span class="p">)</span>  <span class="c1"># 操作列为第4列</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">delete_file_from_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;根据行号删除文件记录，更新历史记录并删除本地文件夹&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取第1列的内容，包含文件路径</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span><span class="p">)</span>  <span class="c1"># 获取文件路径</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;删除行: </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;删除文件: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">model_name</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_id</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 删除历史记录中的对应记录</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">delete_from_history_json</span><span class="p">(</span><span class="n">unique_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">#TODO 不转换splat了</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 删除与 unique_id 关联的 .mt3d 文件</span>
</span></span><span class="line"><span class="cl">            <span class="n">view_file_path</span> <span class="o">=</span> <span class="n">resource_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;datas&#34;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">unique_id</span><span class="si">}</span><span class="s2">.mt3d&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">view_file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">view_file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;成功删除 .mt3d 文件：</span><span class="si">{</span><span class="n">view_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;文件未找到，可能已经被删除：</span><span class="si">{</span><span class="n">view_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;没有权限删除文件：</span><span class="si">{</span><span class="n">view_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;删除文件时发生错误：</span><span class="si">{</span><span class="n">view_file_path</span><span class="si">}</span><span class="s2">, 错误: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;.mt3d 文件不存在：</span><span class="si">{</span><span class="n">view_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 从表格中删除该行</span>
</span></span><span class="line"><span class="cl">            <span class="n">table</span><span class="o">.</span><span class="n">removeRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 重新绑定删除行后的行，因为行号会递减</span>
</span></span><span class="line"><span class="cl">            <span class="n">remaining_rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">remaining_rows</span><span class="p">:</span>  <span class="c1"># 确保删除行不是最后一行</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">rebind_buttons</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">is_delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 重新绑定按钮</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error: Row </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2"> does not contain valid data.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">delete_from_history_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;从历史记录 JSON 文件中删除对应的记录&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取 LOCALAPPDATA 环境变量</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_app_data</span> <span class="o">=</span> <span class="n">get_local_data_directory</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 拼接历史记录文件路径</span>
</span></span><span class="line"><span class="cl">        <span class="n">history_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_app_data</span><span class="p">,</span> <span class="s1">&#39;MindCloud Renderer&#39;</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 如果文件存在，读取并修改历史记录</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">history_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">history_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 过滤掉与 unique_id 匹配的记录</span>
</span></span><span class="line"><span class="cl">            <span class="n">updated_history</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history_data</span> <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">unique_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 保存更新后的历史记录</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">updated_history</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;历史记录已更新，删除了ID为 </span><span class="si">{</span><span class="n">unique_id</span><span class="si">}</span><span class="s2"> 的记录。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;历史记录文件不存在：</span><span class="si">{</span><span class="n">history_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">confirm_delete_file_from_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;弹出确认框并在确认后删除文件&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">confirm_dialog</span> <span class="o">=</span> <span class="n">ConfirmDialog</span><span class="p">(</span><span class="s2">&#34;Delete this item?&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">confirm_dialog</span><span class="o">.</span><span class="n">show_confirmation</span><span class="p">()</span> <span class="o">==</span> <span class="n">QDialog</span><span class="o">.</span><span class="n">Accepted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">delete_file_from_row</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>  <span class="c1"># 用户确认后删除文件</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;删除操作取消&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># def subprocess_start_http_server(self, file_path):</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     &#34;&#34;&#34;启动 HTTP 服务器并打开指定文件的网页&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     import subprocess</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     import sys</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     # 获取 viewer.exe 的路径</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     server_script_path = resource_path(&#34;viewer.py&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     if not os.path.exists(server_script_path):</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#         print(f&#34;Error: {server_script_path} not found!&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#         return</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="c1">#     # 使用当前 Python 解释器来运行 viewer.py，并传递参数</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     python_executable = sys.executable  # 获取当前 Python 解释器的路径</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     subprocess.Popen([python_executable, server_script_path, &#34;--file&#34;, file_path])</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     print(f&#34;启动HTTP服务器并打开文件: {file_path}&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">thread_start_http_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;启动 HTTP 服务器并打开指定文件的网页（使用 QThread）&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">server_thread</span> <span class="o">=</span> <span class="n">ServerThread</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;启动HTTP服务器并打开文件: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">open_file_from_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;根据行号获取文件路径并打开所在的文件夹&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">item</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 获取第一列（name_item）的内容</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span><span class="p">)</span>  <span class="c1"># 通过 UserRole 获取文件路径</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>  <span class="c1"># 获取文件夹路径</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Windows: 打开文件所在的文件夹</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;已打开文件所在位置: </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;文件路径无效或文件不存在: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 不转换spalt文件</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">display_file_from_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">view_file_path</span> <span class="o">=</span> <span class="n">resource_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;datas&#34;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">{}</span><span class="s2">.mt3d&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">view_file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">thread_start_http_server</span><span class="p">(</span><span class="n">view_file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;文件不存在：</span><span class="si">{</span><span class="n">view_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">confirm_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;显示自定义的确认对话框，确认是否退出&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">dialog</span> <span class="o">=</span> <span class="n">ConfirmDialog</span><span class="p">(</span><span class="s2">&#34;Exit the application?&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">dialog</span><span class="o">.</span><span class="n">show_confirmation</span><span class="p">()</span> <span class="o">==</span> <span class="n">QDialog</span><span class="o">.</span><span class="n">Accepted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 用户点击了“是”，彻底退出</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">disable_restore_buttons_in_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        禁用所有行的“恢复”按钮，同时禁用当前行的“删除”按钮。
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">row_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row_count</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 获取操作列的按钮容器</span>
</span></span><span class="line"><span class="cl">            <span class="n">widget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_table</span><span class="o">.</span><span class="n">cellWidget</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">widget</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># 遍历容器中的按钮</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">widget</span><span class="o">.</span><span class="n">findChildren</span><span class="p">(</span><span class="n">QPushButton</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 禁用“恢复”按钮</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">btn</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&#34;Restore&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># 禁用当前行的“删除”按钮</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">btn</span><span class="o">.</span><span class="n">text</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&#34;Delete&#34;</span> <span class="ow">and</span> <span class="n">row</span> <span class="o">==</span> <span class="n">current_row</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">btn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">continue_training_from_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        继续未完成的训练任务，根据表格中的 ID 从 JSON 中获取训练参数。
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 发射信号禁用按钮</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">disable_restore_buttons_signal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">restore_disabled_row</span> <span class="o">=</span> <span class="n">row</span>  <span class="c1"># 保存当前行以便恢复按钮</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Curent row: </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 获取 LOCALAPPDATA 路径</span>
</span></span><span class="line"><span class="cl">        <span class="n">local_app_data</span> <span class="o">=</span> <span class="n">get_local_data_directory</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">history_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_app_data</span><span class="p">,</span> <span class="s1">&#39;MindCloud Renderer&#39;</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 读取历史记录文件内容</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">history_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">history_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">history_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 根据 task_id 找到对应的记录</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">history_data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">task_id</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">model_name</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">source_path</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;source_path&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">iterations</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">density</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="c1"># 发射信号开始恢复训练</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">training_params_signal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iterations</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">density</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;恢复训练:</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">iterations</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">density</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;未找到ID为 </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> 的任务记录&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;历史记录文件不存在&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">toggle_max_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;最大化或恢复窗口大小&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_maximized</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">showNormal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">is_maximized</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">is_maximized</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 重写绘制事件，设置无边框黑色背景</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">paintEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span> <span class="o">=</span> <span class="n">QPainter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">setRenderHint</span><span class="p">(</span><span class="n">QPainter</span><span class="o">.</span><span class="n">Antialiasing</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">QColor</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>  <span class="c1"># 墨黑色背景</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">NoPen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">painter</span><span class="o">.</span><span class="n">drawRoundedRect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">(),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># 圆角矩形</span>
</span></span></code></pre></div><h3 id="之前使用tk的方式">之前使用tk的方式<a hidden class="anchor" aria-hidden="true" href="#之前使用tk的方式">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">queue</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">Tk</span><span class="p">,</span> <span class="n">Toplevel</span><span class="p">,</span> <span class="n">Label</span><span class="p">,</span> <span class="n">Button</span><span class="p">,</span> <span class="n">filedialog</span><span class="p">,</span> <span class="n">Entry</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tkinter.ttk</span> <span class="kn">import</span> <span class="n">Progressbar</span><span class="p">,</span> <span class="n">Frame</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tkinter.font</span> <span class="k">as</span> <span class="nn">tkFont</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">GUIUtils</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Utility class for GUI-related common operations.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initialize_window</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">topmost</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Initialize a new top-level window with common settings.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param title: The title of the window.
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param topmost: Boolean indicating whether the window should stay on top.
</span></span></span><span class="line"><span class="cl"><span class="s2">        :return: Initialized Toplevel window instance.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">window</span> <span class="o">=</span> <span class="n">Toplevel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">window</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">window</span><span class="o">.</span><span class="n">resizable</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># Disable maximize button</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">topmost</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">window</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="s2">&#34;-topmost&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># Keep the window on top</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">window</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set_bold_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Create a bold font with a given size.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param size: Font size.
</span></span></span><span class="line"><span class="cl"><span class="s2">        :return: Font object with bold weight.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">tkFont</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">center_window</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Center a given window on the screen.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        :param window: The window to center.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">window</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">width</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">winfo_width</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">height</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">winfo_height</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">screen_width</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">winfo_screenwidth</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">screen_height</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">winfo_screenheight</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">screen_width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">screen_height</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">window</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s1">x</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gui_user_input</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Get user input for training parameters (iterations) and the point cloud file path.
</span></span></span><span class="line"><span class="cl"><span class="s2">    :return: Dictionary containing user input parameters.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Create root window to handle Tkinter initialization</span>
</span></span><span class="line"><span class="cl">    <span class="n">root</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>  <span class="c1"># Hide main window</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Create a custom input window (but don&#39;t show it yet)</span>
</span></span><span class="line"><span class="cl">    <span class="n">custom_window</span> <span class="o">=</span> <span class="n">GUIUtils</span><span class="o">.</span><span class="n">initialize_window</span><span class="p">(</span><span class="s2">&#34;渲染设置&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">custom_window</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>  <span class="c1"># First hide custom window</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bold_font</span> <span class="o">=</span> <span class="n">GUIUtils</span><span class="o">.</span><span class="n">set_bold_font</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Store user choice and parameters in dictionaries</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_choice</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;confirmed&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;iterations&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span> <span class="s1">&#39;source_path&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  <span class="c1"># Default values</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Instructions label</span>
</span></span><span class="line"><span class="cl">    <span class="n">label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="n">custom_window</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&#34;请输入渲染次数，点击确认后选择lx文件。&#34;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">bold_font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">padx</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Frame for input fields and buttons</span>
</span></span><span class="line"><span class="cl">    <span class="n">input_frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">custom_window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">input_frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Input for iterations</span>
</span></span><span class="line"><span class="cl">    <span class="n">Label</span><span class="p">(</span><span class="n">input_frame</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&#34;渲染次数（建议值10000）&#34;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">bold_font</span><span class="p">)</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">sticky</span><span class="o">=</span><span class="s2">&#34;e&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">iteration_entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="p">(</span><span class="n">input_frame</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">bold_font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">iteration_entry</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Confirm button callback function</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_confirm</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration_entry</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">ValueError</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&#34;输入的渲染次数无效，程序退出。&#34;</span><span class="p">)</span>  <span class="c1"># Directly exits on invalid input</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># File dialog for directory selection</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># source_path = filedialog.askdirectory(title=&#34;选择点云数据路径&#34;, parent=custom_window)</span>
</span></span><span class="line"><span class="cl">        <span class="n">source_path</span> <span class="o">=</span> <span class="n">filedialog</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">title</span><span class="o">=</span><span class="s2">&#34;选择lx文件&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">            <span class="n">parent</span><span class="o">=</span><span class="n">custom_window</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s2">&#34;LX Files&#34;</span><span class="p">,</span> <span class="s2">&#34;*.lx&#34;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&#34;All Files&#34;</span><span class="p">,</span> <span class="s2">&#34;*.*&#34;</span><span class="p">)]</span>  <span class="c1"># 可选：仅显示特定文件类型</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_path</span><span class="p">:</span>  <span class="c1"># Handle cancelation</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&#34;程序已退出，因为用户未选择路径。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;source_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_path</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_choice</span><span class="p">[</span><span class="s1">&#39;confirmed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">custom_window</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Cancel button callback function</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">on_cancel</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>  <span class="c1"># Close all windows</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&#34;程序已退出，因为用户选择了取消或关闭了窗口。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Confirm and cancel buttons</span>
</span></span><span class="line"><span class="cl">    <span class="n">button_confirm</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="n">custom_window</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&#34;确认&#34;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">bold_font</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">on_confirm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">button_confirm</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">button_cancel</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="n">custom_window</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&#34;取消&#34;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">bold_font</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">on_cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">button_cancel</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">padx</span><span class="o">=</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Handling window close action (X button)</span>
</span></span><span class="line"><span class="cl">    <span class="n">custom_window</span><span class="o">.</span><span class="n">protocol</span><span class="p">(</span><span class="s2">&#34;WM_DELETE_WINDOW&#34;</span><span class="p">,</span> <span class="n">on_cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">GUIUtils</span><span class="o">.</span><span class="n">center_window</span><span class="p">(</span><span class="n">custom_window</span><span class="p">)</span>  <span class="c1"># Center the window</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">custom_window</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>  <span class="c1"># Show the custom window after centering it</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">custom_window</span><span class="o">.</span><span class="n">wait_window</span><span class="p">()</span>  <span class="c1"># Wait for user interaction</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">user_choice</span><span class="p">[</span><span class="s1">&#39;confirmed&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">params</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&#34;程序已退出，因为用户未确认。&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TrainingProgressBar</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">,</span> <span class="n">progress_queue</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Initialize the training progress bar window.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span> <span class="o">=</span> <span class="n">stop_event</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress_queue</span> <span class="o">=</span> <span class="n">progress_queue</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Initialize loading dots state</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">dots</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">loading_variants</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;⠄⠄⠄&#34;</span><span class="p">,</span> <span class="s2">&#34;⠄⠂⠄&#34;</span><span class="p">,</span> <span class="s2">&#34;⠄⠄⠂&#34;</span><span class="p">,</span> <span class="s2">&#34;⠄⠄⠄&#34;</span><span class="p">]</span>  <span class="c1"># 动态加载的不同文本 Unicode 字符</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Create main window for progress bar</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;渲染进度&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">resizable</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="s2">&#34;-topmost&#34;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">bold_font</span> <span class="o">=</span> <span class="n">GUIUtils</span><span class="o">.</span><span class="n">set_bold_font</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Progress bar widget</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">Progressbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&#34;horizontal&#34;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;determinate&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">padx</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">[</span><span class="s2">&#34;maximum&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_iterations</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Percentage label</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">percent_label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&#34;奋力加载中⠄⠄⠄&#34;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">bold_font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">percent_label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stop button</span>
</span></span><span class="line"><span class="cl">        <span class="n">close_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&#34;停止渲染&#34;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_training</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">bold_font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">close_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">GUIUtils</span><span class="o">.</span><span class="n">center_window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>  <span class="c1"># Center window</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Disable the window close button (X)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">protocol</span><span class="p">(</span><span class="s2">&#34;WM_DELETE_WINDOW&#34;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Start the GUI main loop</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Stops the training and closes the progress bar.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">after_cancel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_queue_id</span><span class="p">)</span>  <span class="c1"># Cancel all pending after calls</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        更新显示文本。
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">percent_label</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_loading_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        动态更新加载中的文本。
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">loading_text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">loading_variants</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dots</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loading_variants</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">update_text</span><span class="p">(</span><span class="n">loading_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">dots</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Update the progress bar and percentage label.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">[</span><span class="s2">&#34;value&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
</span></span><span class="line"><span class="cl">        <span class="n">percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">[</span><span class="s2">&#34;maximum&#34;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">percent_label</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;进度: </span><span class="si">{</span><span class="n">percent</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">update_idletasks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">check_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Check for updates in the progress queue.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;update&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">update_progress</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;save&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">update_text</span><span class="p">(</span><span class="s2">&#34;正在保存结果⠄⠄⠄&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;close&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">check_queue_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_queue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Close the progress bar and show the result message.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">show_result_message</span><span class="p">(</span><span class="n">result_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">show_result_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Show a message window with the result path and an option to open the file manager.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">message_window</span> <span class="o">=</span> <span class="n">GUIUtils</span><span class="o">.</span><span class="n">initialize_window</span><span class="p">(</span><span class="s2">&#34;温馨提示&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">bold_font</span> <span class="o">=</span> <span class="n">GUIUtils</span><span class="o">.</span><span class="n">set_bold_font</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">result_label</span> <span class="o">=</span> <span class="n">Label</span><span class="p">(</span><span class="n">message_window</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;渲染结果已保存到</span><span class="se">\n\n</span><span class="s2"> </span><span class="si">{</span><span class="n">result_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">bold_font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result_label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">padx</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">pady</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">on_confirm</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">open_file_manager</span><span class="p">(</span><span class="n">result_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">message_window</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">confirm_button</span> <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="n">message_window</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&#34;确认&#34;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">on_confirm</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">bold_font</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">confirm_button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">GUIUtils</span><span class="o">.</span><span class="n">center_window</span><span class="p">(</span><span class="n">message_window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">message_window</span><span class="o">.</span><span class="n">wait_window</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">open_file_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Open the file manager at the given path.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>  <span class="c1"># Windows</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">:</span>  <span class="c1"># macOS or Linux</span>
</span></span><span class="line"><span class="cl">                    <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;xdg-open&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;无法打开文件管理器: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;路径不存在: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="使用qt之后的main函数写法">使用QT之后的main函数写法<a hidden class="anchor" aria-hidden="true" href="#使用qt之后的main函数写法">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">utils.path_utils</span> <span class="kn">import</span> <span class="n">resource_path</span><span class="p">,</span> <span class="n">save_user_params</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#! 需要输出才能保存GUI进度条的输出</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 重定向标准输出和标准错误到黑洞</span>
</span></span><span class="line"><span class="cl"><span class="c1"># log_blackhole = &#39;nul&#39; if os.name == &#39;nt&#39; else &#39;/dev/null&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sys.stdout = open(log_blackhole, &#39;w&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sys.stderr = open(log_blackhole, &#39;w&#39;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">training</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">opt_params</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">pipe_params</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">saving_iterations</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">checkpoint_iterations</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">checkpoint</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">debug_from</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">parameters_storage</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">shuffle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">point_density</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">unique_hash</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">progress_signal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="n">saving_signal</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">scene</span> <span class="kn">import</span> <span class="n">Scene</span><span class="p">,</span> <span class="n">GaussianModel</span>                                                                                              
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">utils.loss_utils</span> <span class="kn">import</span> <span class="n">l1_loss</span><span class="p">,</span> <span class="n">ssim</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">gaussian_renderer</span> <span class="kn">import</span> <span class="n">render</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 从这里开始    </span>
</span></span><span class="line"><span class="cl">    <span class="n">first_iter</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_params</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">resource_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;datas&#34;</span><span class="p">,</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 检查 render_path 下是否存在 success.txt</span>
</span></span><span class="line"><span class="cl">    <span class="n">lx_file_path</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">source_path</span>
</span></span><span class="line"><span class="cl">    <span class="n">render_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">lx_file_path</span><span class="p">),</span> <span class="s1">&#39;render_db&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">success_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">render_path</span><span class="p">,</span> <span class="s1">&#39;success.txt&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 更新 source_path</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_params</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="n">render_path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果 success.txt 存在，直接跳过处理</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">success_file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Processing already completed. Skipping execution of PreOps.exe.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 第一步：预处理</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 执行 PreOps.exe</span>
</span></span><span class="line"><span class="cl">        <span class="n">exe_path</span> <span class="o">=</span> <span class="n">resource_path</span><span class="p">(</span><span class="s2">&#34;PreOps.exe&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Executing PreOps.exe at </span><span class="si">{</span><span class="n">exe_path</span><span class="si">}</span><span class="s2">...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">exe_path</span><span class="p">,</span> <span class="n">lx_file_path</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">point_density</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;PreOps.exe executed successfully.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 创建 success.txt 并写入完成时间</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">success_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">success_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">success_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Process completed successfully at </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Success file created at </span><span class="si">{</span><span class="n">success_file_path</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;An error occurred while executing PreOps.exe: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 退出程序             </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 第二步：初始化模型和场景</span>
</span></span><span class="line"><span class="cl">    <span class="n">gaussians</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">sh_degree</span><span class="p">,</span> <span class="n">parameters_storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">scene</span> <span class="o">=</span> <span class="n">Scene</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">gaussians</span><span class="p">,</span> <span class="n">parameters_storage</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">gaussians</span><span class="o">.</span><span class="n">training_setup_init</span><span class="p">(</span><span class="n">opt_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">checkpoint</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">first_iter</span><span class="p">)</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">gaussians</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">opt_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bg_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">model_params</span><span class="o">.</span><span class="n">white_background</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">background</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&#34;cuda&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ema_loss_for_log</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">first_iter</span><span class="p">,</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">iterations</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;Training progress&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_iter</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_iter</span><span class="p">,</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Every 1000 iterations increase the levels of SH up to a maximum degree</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gaussians</span><span class="o">.</span><span class="n">oneupSHdegree</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">resolution_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">        <span class="n">viewpoint_cam</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">get_random_train_camera</span><span class="p">(</span><span class="n">resolution_scale</span><span class="p">,</span> <span class="n">model_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">viewpoint_cam</span><span class="o">.</span><span class="n">visible_voxel_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">current_points</span> <span class="o">=</span> <span class="n">gaussians</span><span class="o">.</span><span class="n">load_voxel_parameters_train</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">,</span> <span class="n">viewpoint_cam</span><span class="o">.</span><span class="n">visible_voxel_indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">gaussians</span><span class="o">.</span><span class="n">update_learning_rate</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Render</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">debug_from</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pipe_params</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">bg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">3</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="s2">&#34;cuda&#34;</span><span class="p">)</span> <span class="k">if</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">random_background</span> <span class="k">else</span> <span class="n">background</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">render_pkg</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="n">viewpoint_cam</span><span class="p">,</span> <span class="n">gaussians</span><span class="p">,</span> <span class="n">pipe_params</span><span class="p">,</span> <span class="n">bg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">image</span><span class="p">,</span> <span class="n">viewspace_point_tensor</span><span class="p">,</span> <span class="n">visibility_filter</span><span class="p">,</span> <span class="n">radii</span> <span class="o">=</span> <span class="n">render_pkg</span><span class="p">[</span><span class="s2">&#34;render&#34;</span><span class="p">],</span> <span class="n">render_pkg</span><span class="p">[</span><span class="s2">&#34;viewspace_points&#34;</span><span class="p">],</span> <span class="n">render_pkg</span><span class="p">[</span><span class="s2">&#34;visibility_filter&#34;</span><span class="p">],</span> <span class="n">render_pkg</span><span class="p">[</span><span class="s2">&#34;radii&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Loss</span>
</span></span><span class="line"><span class="cl">        <span class="n">gt_image</span> <span class="o">=</span> <span class="n">viewpoint_cam</span><span class="o">.</span><span class="n">original_image</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">Ll1</span> <span class="o">=</span> <span class="n">l1_loss</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">gt_image</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">lambda_dssim</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ll1</span> <span class="o">+</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">lambda_dssim</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ssim</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">gt_image</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">has_densified</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">densify_until_iter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">max_radii2D</span><span class="p">[</span><span class="n">visibility_filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gaussians</span><span class="o">.</span><span class="n">max_radii2D</span><span class="p">[</span><span class="n">visibility_filter</span><span class="p">],</span> <span class="n">radii</span><span class="p">[</span><span class="n">visibility_filter</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">add_densification_stats</span><span class="p">(</span><span class="n">viewspace_point_tensor</span><span class="p">,</span> <span class="n">visibility_filter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">densify_from_iter</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">%</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">densification_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size_threshold</span> <span class="o">=</span> <span class="mi">20</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">opacity_reset_interval</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                    <span class="n">gaussians</span><span class="o">.</span><span class="n">densify_and_prune</span><span class="p">(</span><span class="n">opt_params</span><span class="o">.</span><span class="n">densify_grad_threshold</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">cameras_extent</span><span class="p">,</span> <span class="n">size_threshold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">has_densified</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">opacity_reset_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">white_background</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">densify_from_iter</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">gaussians</span><span class="o">.</span><span class="n">reset_opacity</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">iterations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">checkpoint_iterations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">[ITER </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Saving Checkpoint&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">((</span><span class="n">gaussians</span><span class="o">.</span><span class="n">capture</span><span class="p">(),</span> <span class="n">iteration</span><span class="p">),</span> <span class="n">scene</span><span class="o">.</span><span class="n">model_path</span> <span class="o">+</span> <span class="s2">&#34;/chkpnt&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.pth&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">has_densified</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">save_densification_voxel_parameters</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">,</span> <span class="n">viewpoint_cam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">save_voxel_parameters</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">,</span> <span class="n">viewpoint_cam</span><span class="o">.</span><span class="n">visible_voxel_indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">saving_iterations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">saving_signal</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># scene.parameter_manager.sync_to_db()</span>
</span></span><span class="line"><span class="cl">                <span class="n">scene</span><span class="o">.</span><span class="n">save_memory</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">unique_hash</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Progress bar</span>
</span></span><span class="line"><span class="cl">            <span class="n">ema_loss_for_log</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">ema_loss_for_log</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">&#34;Loss&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">ema_loss_for_log</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="mi">7</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">progress_percent</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">iteration</span> <span class="o">/</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">iterations</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 发射进度更新信号</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_signal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">progress_percent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 更新 GUI 进度条</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">iterations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QSplashScreen</span><span class="p">,</span> <span class="n">QDesktopWidget</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">QThread</span><span class="p">,</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">QObject</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QPixmap</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Communicator</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个信号，发射时会附带timestamp, unique_hash, model_name, source_path, iterations, density, resume_training</span>
</span></span><span class="line"><span class="cl">    <span class="n">training_params_signal</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个信号来关闭启动画面</span>
</span></span><span class="line"><span class="cl">    <span class="n">splash_close_splash</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个信号，用于表示训练完成</span>
</span></span><span class="line"><span class="cl">    <span class="n">training_complete</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个信号，用于更新进度条</span>
</span></span><span class="line"><span class="cl">    <span class="n">progress_signal</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个信号，用于启动训练</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_signal</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个信号，用于取消训练</span>
</span></span><span class="line"><span class="cl">    <span class="n">cancel_signal</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个信号，用于禁用按钮</span>
</span></span><span class="line"><span class="cl">    <span class="n">disable_restore_buttons_signal</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 定义一个信号，用于显示正在保存</span>
</span></span><span class="line"><span class="cl">    <span class="n">saving_signal</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_splash_screen</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;显示启动画面&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pixmap_path</span> <span class="o">=</span> <span class="n">resource_path</span><span class="p">(</span><span class="s2">&#34;assets/lx_start.png&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pixmap</span> <span class="o">=</span> <span class="n">QPixmap</span><span class="p">(</span><span class="n">pixmap_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取用户的屏幕分辨率</span>
</span></span><span class="line"><span class="cl">    <span class="n">screen</span> <span class="o">=</span> <span class="n">QDesktopWidget</span><span class="p">()</span><span class="o">.</span><span class="n">screenGeometry</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">screen_width</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">screen_height</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 根据屏幕大小调整比例</span>
</span></span><span class="line"><span class="cl">    <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># 比例因子</span>
</span></span><span class="line"><span class="cl">    <span class="n">scaled_pixmap</span> <span class="o">=</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">scaled</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                                <span class="nb">int</span><span class="p">(</span><span class="n">screen_height</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                                <span class="n">Qt</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                <span class="n">Qt</span><span class="o">.</span><span class="n">SmoothTransformation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">splash</span> <span class="o">=</span> <span class="n">QSplashScreen</span><span class="p">(</span><span class="n">scaled_pixmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">splash</span><span class="o">.</span><span class="n">setWindowFlag</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowStaysOnTopHint</span><span class="p">)</span>  <span class="c1"># 启动画面保持在最前</span>
</span></span><span class="line"><span class="cl">    <span class="n">splash</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">splash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">TrainingThread</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_params</span><span class="p">,</span> <span class="n">comm</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span> <span class="o">=</span> <span class="n">user_params</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">comm</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;训练任务的执行逻辑，放在子线程的 run 方法中&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl">        <span class="kn">import</span> <span class="nn">tempfile</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">utils.general_utils</span> <span class="kn">import</span> <span class="n">safe_state</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
</span></span><span class="line"><span class="cl">        <span class="kn">from</span> <span class="nn">arguments</span> <span class="kn">import</span> <span class="n">ModelParams</span><span class="p">,</span> <span class="n">PipelineParams</span><span class="p">,</span> <span class="n">OptimizationParams</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">start_signal</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Temporary directory: </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">default_parameters_storage</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&#34;parameters_storage&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;Training script parameters&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">model_params</span> <span class="o">=</span> <span class="n">ModelParams</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;source_path&#39;</span><span class="p">],</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">opt_params</span> <span class="o">=</span> <span class="n">OptimizationParams</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">pipe_params</span> <span class="o">=</span> <span class="n">PipelineParams</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--debug_from&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--detect_anomaly&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--test_iterations&#34;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&#34;+&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">3_000</span><span class="p">,</span> <span class="mi">7_000</span><span class="p">,</span> <span class="mi">12_000</span><span class="p">,</span> <span class="mi">20_000</span><span class="p">,</span> <span class="mi">30_000</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--save_iterations&#34;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&#34;+&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">30_000</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--quiet&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--checkpoint_iterations&#34;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&#34;+&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--start_checkpoint&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--parameters_storage&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_parameters_storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--shuffle&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--point_density&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--unique_hash&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;unique_hash&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span><span class="o">.</span><span class="n">save_iterations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 初始化系统状态</span>
</span></span><span class="line"><span class="cl">        <span class="n">safe_state</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 是否开启异常检测</span>
</span></span><span class="line"><span class="cl">        <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_detect_anomaly</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">detect_anomaly</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 开始训练</span>
</span></span><span class="line"><span class="cl">        <span class="n">training</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">opt_params</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">pipe_params</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">args</span><span class="o">.</span><span class="n">save_iterations</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">args</span><span class="o">.</span><span class="n">checkpoint_iterations</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">args</span><span class="o">.</span><span class="n">start_checkpoint</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">args</span><span class="o">.</span><span class="n">debug_from</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                 <span class="n">args</span><span class="o">.</span><span class="n">shuffle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">args</span><span class="o">.</span><span class="n">point_density</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">args</span><span class="o">.</span><span class="n">unique_hash</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">progress_signal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">saving_signal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 删除缓存</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">rmtree</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Successfully deleted the folder: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error while deleting the folder </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Training complete.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 任务完成后发射信号</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">training_complete</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">comm</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#! 这里也取巧了，提前加载需要的模块</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">tempfile</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">utils.general_utils</span> <span class="kn">import</span> <span class="n">safe_state</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">arguments</span> <span class="kn">import</span> <span class="n">ModelParams</span><span class="p">,</span> <span class="n">PipelineParams</span><span class="p">,</span> <span class="n">OptimizationParams</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">utils.system_utils</span> <span class="kn">import</span> <span class="n">select_cuda_device</span> <span class="c1"># 涉及torch加载，会有等待时间</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">QEventLoop</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">utils.qt_gui_utils</span> <span class="kn">import</span> <span class="n">MainWindow</span>
</span></span><span class="line"><span class="cl">    <span class="n">select_cuda_device</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 发送信号来关闭启动画面</span>
</span></span><span class="line"><span class="cl">    <span class="n">comm</span><span class="o">.</span><span class="n">splash_close_splash</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 创建主窗口</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_window</span> <span class="o">=</span> <span class="n">MainWindow</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 显示主界面</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_window</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">### GUI主界面 ###</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 用于存储信号发出的值</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_params</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 创建一个事件循环，用于等待信号</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">QEventLoop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_train_args</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">unique_hash</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">source_path</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">resume_training</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;槽函数，用于接收信号发出的参数&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;unique_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_hash</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_name</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;source_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_path</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iterations</span>
</span></span><span class="line"><span class="cl">        <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">density</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">resume_training</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;继续训练...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">save_user_params</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>  <span class="c1"># 保存用户参数</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>  <span class="c1"># 信号发出后，退出事件循环</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 连接信号和槽：当信号发出时，调用 get_train_args 函数</span>
</span></span><span class="line"><span class="cl">    <span class="n">comm</span><span class="o">.</span><span class="n">training_params_signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">get_train_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># 持续循环，等待用户输入</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;等待新任务...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loop</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>  <span class="c1"># 等待新任务信号，同时阻塞当前线程，需要loop.quit()来退出</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">### 开始训练 ###</span>
</span></span><span class="line"><span class="cl">        <span class="n">main_window</span><span class="o">.</span><span class="n">new_task_button</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 禁用按钮</span>
</span></span><span class="line"><span class="cl">        <span class="n">comm</span><span class="o">.</span><span class="n">disable_restore_buttons_signal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 禁用所有的恢复按钮和所在行的删除按钮</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 启动训练线程，作为 main_window 的成员变量</span>
</span></span><span class="line"><span class="cl">        <span class="n">training_thread</span> <span class="o">=</span> <span class="n">TrainingThread</span><span class="p">(</span><span class="n">user_params</span><span class="p">,</span> <span class="n">comm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">main_window</span><span class="o">.</span><span class="n">training_thread</span> <span class="o">=</span> <span class="n">training_thread</span>
</span></span><span class="line"><span class="cl">        <span class="n">training_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 当训练任务完成时，恢复按钮</span>
</span></span><span class="line"><span class="cl">        <span class="n">comm</span><span class="o">.</span><span class="n">training_complete</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">main_window</span><span class="o">.</span><span class="n">new_task_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 当收到取消信号时，停止当前训练任务</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">stop_training</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;停止当前训练任务&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">training_thread</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>  <span class="c1"># 停止训练线程</span>
</span></span><span class="line"><span class="cl">            <span class="n">main_window</span><span class="o">.</span><span class="n">new_task_button</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 恢复按钮可用</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 监听取消信号，执行停止任务的逻辑</span>
</span></span><span class="line"><span class="cl">        <span class="n">comm</span><span class="o">.</span><span class="n">cancel_signal</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">stop_training</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;继续等待新任务...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 创建 QApplication 实例</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 创建 Communicator 实例</span>
</span></span><span class="line"><span class="cl">    <span class="n">comm</span> <span class="o">=</span> <span class="n">Communicator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 显示启动画面</span>
</span></span><span class="line"><span class="cl">    <span class="n">splash</span> <span class="o">=</span> <span class="n">show_splash_screen</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 连接信号到关闭启动画面的槽函数</span>
</span></span><span class="line"><span class="cl">    <span class="n">comm</span><span class="o">.</span><span class="n">splash_close_splash</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">splash</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 在主线程中运行主逻辑</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 等待应用程序退出</span>
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>
</span></span></code></pre></div><h3 id="使用tk时没有那么复杂的main函数写法">使用tk时没有那么复杂的main函数写法<a hidden class="anchor" aria-hidden="true" href="#使用tk时没有那么复杂的main函数写法">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">queue</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建一个全局队列用于线程间通信</span>
</span></span><span class="line"><span class="cl"><span class="n">progress_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">stop_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>  <span class="c1"># 用于控制线程停止的事件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">resource_path</span><span class="p">(</span><span class="n">relative_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;获取资源文件的绝对路径&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;frozen&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>  <span class="c1"># 检查是否是打包的可执行文件</span>
</span></span><span class="line"><span class="cl">        <span class="n">base_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_MEIPASS</span>  <span class="c1"># PyInstaller 会把文件解压到这个临时目录</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)</span>  <span class="c1"># 否则使用当前目录</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">training</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">opt_params</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">pipe_params</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">saving_iterations</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">checkpoint_iterations</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">checkpoint</span><span class="p">,</span> <span class="n">debug_from</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">parameters_storage</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">shuffle</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">             <span class="n">progress_bar_gui</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">subprocess</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">scene</span> <span class="kn">import</span> <span class="n">Scene</span><span class="p">,</span> <span class="n">GaussianModel</span>                                                                                              
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">utils.loss_utils</span> <span class="kn">import</span> <span class="n">l1_loss</span><span class="p">,</span> <span class="n">ssim</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">gaussian_renderer</span> <span class="kn">import</span> <span class="n">render</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">prepare_output</span><span class="p">(</span><span class="n">model_params</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;准备输出文件夹并返回模型保存路径。&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">base_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">source_path</span><span class="p">),</span> <span class="s1">&#39;mt_output&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_path</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果没有指定 model_path，使用时间戳作为唯一字符串</span>
</span></span><span class="line"><span class="cl">            <span class="n">unique_str</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&#34;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">model_params</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_output_path</span><span class="p">,</span> <span class="n">unique_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 如果指定了 model_path，则基于 base_output_path 拼接路径</span>
</span></span><span class="line"><span class="cl">            <span class="n">model_params</span><span class="o">.</span><span class="n">model_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_output_path</span><span class="p">,</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Output folder:&#34;</span><span class="p">,</span> <span class="n">model_params</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">model_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">model_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">initialize_and_execute</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">parameters_storage</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">opt_params</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    执行预处理步骤，然后初始化模型和场景，并在过程中更新进度条。
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 注意这里的source_path发生了替换</span>
</span></span><span class="line"><span class="cl">            <span class="n">lx_file_path</span> <span class="o">=</span> <span class="n">model_params</span><span class="o">.</span><span class="n">source_path</span>
</span></span><span class="line"><span class="cl">            <span class="n">render_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">lx_file_path</span><span class="p">),</span> <span class="s1">&#39;render_db&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">model_params</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="n">render_path</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 第一步：预处理</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 执行 PreOps.exe</span>
</span></span><span class="line"><span class="cl">            <span class="n">exe_path</span> <span class="o">=</span> <span class="n">resource_path</span><span class="p">(</span><span class="s2">&#34;PreOps.exe&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Executing PreOps.exe at </span><span class="si">{</span><span class="n">exe_path</span><span class="si">}</span><span class="s2">...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">exe_path</span><span class="p">,</span> <span class="n">lx_file_path</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;0.02&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>  <span class="c1"># 打印标准输出</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;An error occurred while executing PreOps.exe: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 第二步：初始化模型和场景</span>
</span></span><span class="line"><span class="cl">            <span class="n">gaussians</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">sh_degree</span><span class="p">,</span> <span class="n">parameters_storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">scene</span> <span class="o">=</span> <span class="n">Scene</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">gaussians</span><span class="p">,</span> <span class="n">parameters_storage</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">gaussians</span><span class="o">.</span><span class="n">training_setup_init</span><span class="p">(</span><span class="n">opt_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 将结果存储在共享列表中</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">gaussians</span><span class="p">,</span> <span class="n">scene</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Initialization error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 从这里开始</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_iter</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_save_path</span> <span class="o">=</span> <span class="n">prepare_output</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 创建初始化线程</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">init_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">initialize_and_execute</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">parameters_storage</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">,</span> <span class="n">opt_params</span><span class="p">,</span> <span class="n">results</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">init_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 等待初始化线程完成，并在此期间更新进度条</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">init_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>  <span class="c1"># 检查是否收到停止信号</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;User stopped the training.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 强制退出所有线程</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 每隔0.33秒更新一次进度条</span>
</span></span><span class="line"><span class="cl">        <span class="n">progress_bar_gui</span><span class="o">.</span><span class="n">update_loading_text</span><span class="p">(</span><span class="s2">&#34;奋力加载中&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.33</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 等待初始化线程完成</span>
</span></span><span class="line"><span class="cl">    <span class="n">init_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">progress_bar_gui</span><span class="o">.</span><span class="n">update_text</span><span class="p">(</span><span class="s2">&#34;进度: 0%&#34;</span><span class="p">)</span>  <span class="c1"># 初始化完成后更新进度条</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 检查结果是否存在</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">gaussians</span><span class="p">,</span> <span class="n">scene</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Initialization failed. Exiting...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">checkpoint</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">first_iter</span><span class="p">)</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">gaussians</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">model_params</span><span class="p">,</span> <span class="n">opt_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bg_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">model_params</span><span class="o">.</span><span class="n">white_background</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">background</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&#34;cuda&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ema_loss_for_log</span> <span class="o">=</span> <span class="mf">0.0</span>
</span></span><span class="line"><span class="cl">    <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">first_iter</span><span class="p">,</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">iterations</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&#34;Training progress&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">first_iter</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_iter</span><span class="p">,</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>  <span class="c1"># 检查是否收到停止信号</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;User stopped the training while iterating.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Every 1000 iterations increase the levels of SH up to a maximum degree</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gaussians</span><span class="o">.</span><span class="n">oneupSHdegree</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">resolution_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">        <span class="n">viewpoint_cam</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">get_random_train_camera</span><span class="p">(</span><span class="n">resolution_scale</span><span class="p">,</span> <span class="n">model_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">viewpoint_cam</span><span class="o">.</span><span class="n">visible_voxel_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">current_points</span> <span class="o">=</span> <span class="n">gaussians</span><span class="o">.</span><span class="n">load_voxel_parameters_train</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">,</span> <span class="n">viewpoint_cam</span><span class="o">.</span><span class="n">visible_voxel_indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">gaussians</span><span class="o">.</span><span class="n">update_learning_rate</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Render</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">debug_from</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pipe_params</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">bg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="mi">3</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="s2">&#34;cuda&#34;</span><span class="p">)</span> <span class="k">if</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">random_background</span> <span class="k">else</span> <span class="n">background</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">render_pkg</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="n">viewpoint_cam</span><span class="p">,</span> <span class="n">gaussians</span><span class="p">,</span> <span class="n">pipe_params</span><span class="p">,</span> <span class="n">bg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">image</span><span class="p">,</span> <span class="n">viewspace_point_tensor</span><span class="p">,</span> <span class="n">visibility_filter</span><span class="p">,</span> <span class="n">radii</span> <span class="o">=</span> <span class="n">render_pkg</span><span class="p">[</span><span class="s2">&#34;render&#34;</span><span class="p">],</span> <span class="n">render_pkg</span><span class="p">[</span><span class="s2">&#34;viewspace_points&#34;</span><span class="p">],</span> <span class="n">render_pkg</span><span class="p">[</span><span class="s2">&#34;visibility_filter&#34;</span><span class="p">],</span> <span class="n">render_pkg</span><span class="p">[</span><span class="s2">&#34;radii&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Loss</span>
</span></span><span class="line"><span class="cl">        <span class="n">gt_image</span> <span class="o">=</span> <span class="n">viewpoint_cam</span><span class="o">.</span><span class="n">original_image</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">Ll1</span> <span class="o">=</span> <span class="n">l1_loss</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">gt_image</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">lambda_dssim</span><span class="p">)</span> <span class="o">*</span> <span class="n">Ll1</span> <span class="o">+</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">lambda_dssim</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">ssim</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">gt_image</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">has_densified</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">densify_until_iter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">max_radii2D</span><span class="p">[</span><span class="n">visibility_filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gaussians</span><span class="o">.</span><span class="n">max_radii2D</span><span class="p">[</span><span class="n">visibility_filter</span><span class="p">],</span> <span class="n">radii</span><span class="p">[</span><span class="n">visibility_filter</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">add_densification_stats</span><span class="p">(</span><span class="n">viewspace_point_tensor</span><span class="p">,</span> <span class="n">visibility_filter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">densify_from_iter</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">%</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">densification_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">size_threshold</span> <span class="o">=</span> <span class="mi">20</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">opacity_reset_interval</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                    <span class="n">gaussians</span><span class="o">.</span><span class="n">densify_and_prune</span><span class="p">(</span><span class="n">opt_params</span><span class="o">.</span><span class="n">densify_grad_threshold</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">cameras_extent</span><span class="p">,</span> <span class="n">size_threshold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">has_densified</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">opacity_reset_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">white_background</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">densify_from_iter</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">gaussians</span><span class="o">.</span><span class="n">reset_opacity</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">iterations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">checkpoint_iterations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">[ITER </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">] Saving Checkpoint&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">((</span><span class="n">gaussians</span><span class="o">.</span><span class="n">capture</span><span class="p">(),</span> <span class="n">iteration</span><span class="p">),</span> <span class="n">scene</span><span class="o">.</span><span class="n">model_path</span> <span class="o">+</span> <span class="s2">&#34;/chkpnt&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.pth&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">has_densified</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">save_densification_voxel_parameters</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">,</span> <span class="n">viewpoint_cam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">gaussians</span><span class="o">.</span><span class="n">save_voxel_parameters</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">,</span> <span class="n">viewpoint_cam</span><span class="o">.</span><span class="n">visible_voxel_indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="n">saving_iterations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&#34;save&#34;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">scene</span><span class="o">.</span><span class="n">save_memory</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">parameter_manager</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Progress bar</span>
</span></span><span class="line"><span class="cl">            <span class="n">ema_loss_for_log</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">ema_loss_for_log</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">&#34;Loss&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">ema_loss_for_log</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="mi">7</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 更新 GUI 进度条</span>
</span></span><span class="line"><span class="cl">            <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&#34;update&#34;</span><span class="p">,</span> <span class="n">iteration</span><span class="p">))</span>  <span class="c1"># 将进度更新放入队列</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">opt_params</span><span class="o">.</span><span class="n">iterations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&#34;close&#34;</span><span class="p">,</span> <span class="n">model_save_path</span><span class="p">))</span>  <span class="c1"># 将关闭消息放入队列</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QSplashScreen</span><span class="p">,</span> <span class="n">QDesktopWidget</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span><span class="p">,</span> <span class="n">pyqtSignal</span><span class="p">,</span> <span class="n">QObject</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QPixmap</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Communicator</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">close_splash</span> <span class="o">=</span> <span class="n">pyqtSignal</span><span class="p">()</span>  <span class="c1"># 定义一个信号来关闭启动画面</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_splash_screen</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;显示启动画面&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pixmap_path</span> <span class="o">=</span> <span class="n">resource_path</span><span class="p">(</span><span class="s2">&#34;assets/lx_start.png&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pixmap</span> <span class="o">=</span> <span class="n">QPixmap</span><span class="p">(</span><span class="n">pixmap_path</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取用户的屏幕分辨率</span>
</span></span><span class="line"><span class="cl">    <span class="n">screen</span> <span class="o">=</span> <span class="n">QDesktopWidget</span><span class="p">()</span><span class="o">.</span><span class="n">screenGeometry</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">screen_width</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">width</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">screen_height</span> <span class="o">=</span> <span class="n">screen</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 根据屏幕大小调整比例，例如设置为屏幕宽度的 30% 和高度的 30%</span>
</span></span><span class="line"><span class="cl">    <span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">0.2</span>  <span class="c1"># 比例因子</span>
</span></span><span class="line"><span class="cl">    <span class="n">scaled_pixmap</span> <span class="o">=</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">scaled</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                                <span class="nb">int</span><span class="p">(</span><span class="n">screen_height</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                                <span class="n">Qt</span><span class="o">.</span><span class="n">KeepAspectRatio</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                <span class="n">Qt</span><span class="o">.</span><span class="n">SmoothTransformation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">splash</span> <span class="o">=</span> <span class="n">QSplashScreen</span><span class="p">(</span><span class="n">scaled_pixmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">splash</span><span class="o">.</span><span class="n">setWindowFlag</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WindowStaysOnTopHint</span><span class="p">)</span>  <span class="c1"># 启动画面保持在最前</span>
</span></span><span class="line"><span class="cl">    <span class="n">splash</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">app</span><span class="p">,</span> <span class="n">splash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">comm</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">torch</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">tempfile</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">utils.general_utils</span> <span class="kn">import</span> <span class="n">safe_state</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">arguments</span> <span class="kn">import</span> <span class="n">ModelParams</span><span class="p">,</span> <span class="n">PipelineParams</span><span class="p">,</span> <span class="n">OptimizationParams</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">utils.tk_gui_utils</span> <span class="kn">import</span> <span class="n">TrainingProgressBar</span>
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">utils.system_utils</span> <span class="kn">import</span> <span class="n">select_cuda_device</span> <span class="c1"># 涉及torch加载，会有等待时间</span>
</span></span><span class="line"><span class="cl">    <span class="n">select_cuda_device</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 发送信号来关闭启动画面</span>
</span></span><span class="line"><span class="cl">    <span class="n">comm</span><span class="o">.</span><span class="n">close_splash</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">from</span> <span class="nn">utils.tk_gui_utils</span> <span class="kn">import</span> <span class="n">gui_user_input</span>
</span></span><span class="line"><span class="cl">    <span class="n">user_params</span> <span class="o">=</span> <span class="n">gui_user_input</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 预处理的路径准备</span>
</span></span><span class="line"><span class="cl">    <span class="n">source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;source_path&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Source path: </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Temporary directory: </span><span class="si">{</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置默认的参数存储路径</span>
</span></span><span class="line"><span class="cl">    <span class="n">default_parameters_storage</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&#34;parameters_storage&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 设置命令行参数解析器</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;Training script parameters&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">model_params</span> <span class="o">=</span> <span class="n">ModelParams</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">source_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">opt_params</span> <span class="o">=</span> <span class="n">OptimizationParams</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">pipe_params</span> <span class="o">=</span> <span class="n">PipelineParams</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--debug_from&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--detect_anomaly&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--test_iterations&#34;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&#34;+&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">3_000</span><span class="p">,</span> <span class="mi">7_000</span><span class="p">,</span> <span class="mi">12_000</span><span class="p">,</span> <span class="mi">20_000</span><span class="p">,</span> <span class="mi">30_000</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--save_iterations&#34;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&#34;+&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--quiet&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--checkpoint_iterations&#34;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&#34;+&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--start_checkpoint&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--parameters_storage&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_parameters_storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--shuffle&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span><span class="o">.</span><span class="n">save_iterations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;iterations&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;save iterations:&#34;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">save_iterations</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 初始化系统状态（随机数生成器）</span>
</span></span><span class="line"><span class="cl">    <span class="n">safe_state</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">quiet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 是否开启异常检测</span>
</span></span><span class="line"><span class="cl">    <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">set_detect_anomaly</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">detect_anomaly</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 创建 GUI 进度条实例</span>
</span></span><span class="line"><span class="cl">    <span class="n">progress_bar_gui</span> <span class="o">=</span> <span class="n">TrainingProgressBar</span><span class="p">(</span><span class="n">max_iterations</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">iterations</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="n">stop_event</span><span class="p">,</span> <span class="n">progress_queue</span><span class="o">=</span><span class="n">progress_queue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 启动训练线程</span>
</span></span><span class="line"><span class="cl">    <span class="n">training_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">training</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                                                              <span class="n">opt_params</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                                                              <span class="n">pipe_params</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                              <span class="n">args</span><span class="o">.</span><span class="n">save_iterations</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                                              <span class="n">args</span><span class="o">.</span><span class="n">checkpoint_iterations</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                                              <span class="n">args</span><span class="o">.</span><span class="n">start_checkpoint</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                                              <span class="n">args</span><span class="o">.</span><span class="n">debug_from</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                                              <span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                                              <span class="n">args</span><span class="o">.</span><span class="n">shuffle</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                                              <span class="n">progress_bar_gui</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">training_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">progress_bar_gui</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">progress_bar_gui</span><span class="o">.</span><span class="n">check_queue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">progress_bar_gui</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Training complete.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 删除缓存</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">rmtree</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Successfully deleted the folder: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error while deleting the folder </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">parameters_storage</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 创建 Communicator 实例</span>
</span></span><span class="line"><span class="cl">    <span class="n">comm</span> <span class="o">=</span> <span class="n">Communicator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 显示启动画面</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span><span class="p">,</span> <span class="n">splash</span> <span class="o">=</span> <span class="n">show_splash_screen</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 连接信号到关闭启动画面的槽函数</span>
</span></span><span class="line"><span class="cl">    <span class="n">comm</span><span class="o">.</span><span class="n">close_splash</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">splash</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#! 需要输出才能保存GUI进度条的输出</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 重定向标准输出和标准错误到黑洞</span>
</span></span><span class="line"><span class="cl">    <span class="n">log_blackhole</span> <span class="o">=</span> <span class="s1">&#39;nul&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span> <span class="k">else</span> <span class="s1">&#39;/dev/null&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_blackhole</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_blackhole</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 在主线程中运行主逻辑</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">(</span><span class="n">comm</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="通过python打开含js网页的写法">通过python打开含js网页的写法<a hidden class="anchor" aria-hidden="true" href="#通过python打开含js网页的写法">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">http.server</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socketserver</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">webbrowser</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">signal</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">parse_qs</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">utils.path_utils</span> <span class="kn">import</span> <span class="n">resource_path</span><span class="p">,</span> <span class="n">resource_path_http</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PORT</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 设置为 0，让系统自动分配端口</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 动态生成 HTML 文件</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_html</span><span class="p">(</span><span class="n">cloud_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    &lt;!DOCTYPE html&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">    &lt;html lang=&#34;en&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">      &lt;head&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;meta charset=&#34;utf-8&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1.0&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;meta http-equiv=&#34;x-ua-compatible&#34; content=&#34;ie=edge&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;title&gt;MindCloud 3DViewer&lt;/title&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;style&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">          body, html </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            margin: 0;
</span></span></span><span class="line"><span class="cl"><span class="s2">            padding: 0;
</span></span></span><span class="line"><span class="cl"><span class="s2">            width: 100%;
</span></span></span><span class="line"><span class="cl"><span class="s2">            height: 100%;
</span></span></span><span class="line"><span class="cl"><span class="s2">            overflow: hidden;
</span></span></span><span class="line"><span class="cl"><span class="s2">            background-color: #000;
</span></span></span><span class="line"><span class="cl"><span class="s2">            color: #fff;
</span></span></span><span class="line"><span class="cl"><span class="s2">            display: flex;
</span></span></span><span class="line"><span class="cl"><span class="s2">            justify-content: center;
</span></span></span><span class="line"><span class="cl"><span class="s2">            align-items: center;
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          .loading-icon </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            display: none;
</span></span></span><span class="line"><span class="cl"><span class="s2">            width: 80px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            padding: 15px;
</span></span></span><span class="line"><span class="cl"><span class="s2">            background: #36b07b;
</span></span></span><span class="line"><span class="cl"><span class="s2">            aspect-ratio: 1;
</span></span></span><span class="line"><span class="cl"><span class="s2">            border-radius: 50%;
</span></span></span><span class="line"><span class="cl"><span class="s2">            --_m: conic-gradient(#0000, #000), linear-gradient(#000 0 0) content-box;
</span></span></span><span class="line"><span class="cl"><span class="s2">            -webkit-mask: var(--_m);
</span></span></span><span class="line"><span class="cl"><span class="s2">            mask: var(--_m);
</span></span></span><span class="line"><span class="cl"><span class="s2">            -webkit-mask-composite: source-out;
</span></span></span><span class="line"><span class="cl"><span class="s2">            mask-composite: subtract;
</span></span></span><span class="line"><span class="cl"><span class="s2">            box-sizing: border-box;
</span></span></span><span class="line"><span class="cl"><span class="s2">            animation: ply-load 1s linear infinite;
</span></span></span><span class="line"><span class="cl"><span class="s2">            margin: 20px auto 0;
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          canvas </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            position: absolute;
</span></span></span><span class="line"><span class="cl"><span class="s2">            top: 0;
</span></span></span><span class="line"><span class="cl"><span class="s2">            left: 0;
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          @keyframes ply-load </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            to </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">              transform: rotate(1turn)
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;/style&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;script type=&#34;importmap&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;imports&#34;: </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">              &#34;three&#34;: &#34;./lib/three.min.js&#34;, 
</span></span></span><span class="line"><span class="cl"><span class="s2">              &#34;gaussian-splats-3d&#34;: &#34;./lib/mt3d.min.js&#34; 
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;/script&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">      &lt;/head&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">      &lt;body&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;canvas id=&#34;bgCanvas&#34;&gt;&lt;/canvas&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;div id=&#34;viewStatus&#34;&gt;&lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;div id=&#34;viewError&#34;&gt;&lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;div id=&#34;view-loading-icon&#34; class=&#34;loading-icon&#34;&gt;&lt;/div&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;script type=&#34;module&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">          import * as GaussianSplats3D from &#39;gaussian-splats-3d&#39;;
</span></span></span><span class="line"><span class="cl"><span class="s2">          import * as THREE from &#39;three&#39;;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          function fileBufferToSplatBuffer(fileBufferData, format, alphaRemovalThreshold, compressionLevel, sectionSize, sceneCenter, blockSize, bucketSize, outSphericalHarmonicsDegree = 0) </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            if (format === GaussianSplats3D.SceneFormat.Ply) </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">              return GaussianSplats3D.PlyLoader.loadFromFileData(fileBufferData.data, alphaRemovalThreshold, compressionLevel, outSphericalHarmonicsDegree, sectionSize, sceneCenter, blockSize, bucketSize);
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="se">}}</span><span class="s2"> else if (format === GaussianSplats3D.SceneFormat.Splat) </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">              return GaussianSplats3D.SplatLoader.loadFromFileData(fileBufferData.data, alphaRemovalThreshold, compressionLevel, sectionSize, sceneCenter, blockSize, bucketSize);
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="se">}}</span><span class="s2"> else </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">              return GaussianSplats3D.KSplatLoader.loadFromFileData(fileBufferData.data);
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          function setViewError(msg) </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            setViewLoadingIconVisibility(false);
</span></span></span><span class="line"><span class="cl"><span class="s2">            document.getElementById(&#34;viewStatus&#34;).innerHTML = &#34;&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">            document.getElementById(&#34;viewError&#34;).innerHTML = msg;
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          function setViewStatus(msg) </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            setViewLoadingIconVisibility(true);
</span></span></span><span class="line"><span class="cl"><span class="s2">            document.getElementById(&#34;viewError&#34;).innerHTML = &#34;&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">            document.getElementById(&#34;viewStatus&#34;).innerHTML = msg;
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          function setViewLoadingIconVisibility(visible) </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">            document.getElementById(&#39;view-loading-icon&#39;).style.display = visible ? &#39;block&#39; : &#39;none&#39;;
</span></span></span><span class="line"><span class="cl"><span class="s2">          </span><span class="se">}}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          const path = &#39;</span><span class="si">{</span><span class="n">cloud_path</span><span class="si">}</span><span class="s2">&#39;;
</span></span></span><span class="line"><span class="cl"><span class="s2">          const format = GaussianSplats3D.LoaderUtils.sceneFormatFromPath(path);
</span></span></span><span class="line"><span class="cl"><span class="s2">          const alphaRemovalThreshold = 2;
</span></span></span><span class="line"><span class="cl"><span class="s2">          const cameraUpArray = [0, 0, 1];
</span></span></span><span class="line"><span class="cl"><span class="s2">          const cameraPositionArray = [0, 1, 0];
</span></span></span><span class="line"><span class="cl"><span class="s2">          const cameraLookAtArray = [1, 0, 0];
</span></span></span><span class="line"><span class="cl"><span class="s2">          const antialiased = false;
</span></span></span><span class="line"><span class="cl"><span class="s2">          const sceneIs2D = false;
</span></span></span><span class="line"><span class="cl"><span class="s2">          const sphericalHarmonicsDegree = 0;
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          fetch(path)
</span></span></span><span class="line"><span class="cl"><span class="s2">            .then(response =&gt; response.arrayBuffer())
</span></span></span><span class="line"><span class="cl"><span class="s2">            .then(buffer =&gt; </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">              const viewerOptions = </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#39;cameraUp&#39;: cameraUpArray,
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#39;initialCameraPosition&#39;: cameraPositionArray,
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#39;initialCameraLookAt&#39;: cameraLookAtArray,
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#39;halfPrecisionCovariancesOnGPU&#39;: false,
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#39;antialiased&#39;: antialiased || false,
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#39;splatRenderMode&#39;: sceneIs2D ? GaussianSplats3D.SplatRenderMode.TwoD : GaussianSplats3D.SplatRenderMode.ThreeD,
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#39;sphericalHarmonicsDegree&#39;: sphericalHarmonicsDegree
</span></span></span><span class="line"><span class="cl"><span class="s2">              </span><span class="se">}}</span><span class="s2">;
</span></span></span><span class="line"><span class="cl"><span class="s2">              const splatBufferOptions = </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                &#39;splatAlphaRemovalThreshold&#39;: alphaRemovalThreshold
</span></span></span><span class="line"><span class="cl"><span class="s2">              </span><span class="se">}}</span><span class="s2">;
</span></span></span><span class="line"><span class="cl"><span class="s2">              const splatBufferPromise = fileBufferToSplatBuffer(</span><span class="se">{{</span><span class="s2"> data: buffer </span><span class="se">}}</span><span class="s2">, format, alphaRemovalThreshold, 0, undefined, undefined, undefined, undefined, sphericalHarmonicsDegree);
</span></span></span><span class="line"><span class="cl"><span class="s2">              splatBufferPromise.then((splatBuffer) =&gt; </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                document.body.style.backgroundColor = &#34;#000000&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">                const allCanvases = document.querySelectorAll(&#39;canvas&#39;);
</span></span></span><span class="line"><span class="cl"><span class="s2">                allCanvases.forEach(canvas =&gt; canvas.remove());
</span></span></span><span class="line"><span class="cl"><span class="s2">                const viewer = new GaussianSplats3D.Viewer(viewerOptions);
</span></span></span><span class="line"><span class="cl"><span class="s2">                viewer.addSplatBuffers([splatBuffer], [splatBufferOptions])
</span></span></span><span class="line"><span class="cl"><span class="s2">                  .then(() =&gt; </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                    viewer.start();
</span></span></span><span class="line"><span class="cl"><span class="s2">                    setViewLoadingIconVisibility(false);
</span></span></span><span class="line"><span class="cl"><span class="s2">                  </span><span class="se">}}</span><span class="s2">);
</span></span></span><span class="line"><span class="cl"><span class="s2">              </span><span class="se">}}</span><span class="s2">);
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="se">}}</span><span class="s2">)
</span></span></span><span class="line"><span class="cl"><span class="s2">            .catch(err =&gt; </span><span class="se">{{</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">              console.error(&#34;Error loading the file:&#34;, err);
</span></span></span><span class="line"><span class="cl"><span class="s2">              setViewError(&#34;Error loading the file.&#34;);
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="se">}}</span><span class="s2">);
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">          setViewLoadingIconVisibility(true);
</span></span></span><span class="line"><span class="cl"><span class="s2">        &lt;/script&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">      &lt;/body&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">    &lt;/html&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">html_content</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CustomHandler</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 对于 .js 文件，直接提供</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.js&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">resource_path_http</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Serving JavaScript file: </span><span class="si">{</span><span class="n">js_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">js_file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&#34;Content-type&#34;</span><span class="p">,</span> <span class="s2">&#34;application/javascript&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">js_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">js_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">js_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;File not found: </span><span class="si">{</span><span class="n">js_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 对于 .html 文件，解析 URL 参数，获取文件路径</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.html&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Serving HTML file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">query_components</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_path</span> <span class="o">=</span> <span class="n">query_components</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;file&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">default_file</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># 检查文件是否存在</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 将文件复制到 exe 所在的 datas 目录</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">file_http_path</span> <span class="o">=</span> <span class="n">resource_path_http</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;./datas/</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># file_http_path = f&#34;./datas/{file_name}&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;file_http_path&#34;</span><span class="p">,</span> <span class="n">file_http_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># if not os.path.exists(file_http_path):</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#     os.makedirs(os.path.dirname(file_http_path), exist_ok=True)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#     with open(file_path, &#39;rb&#39;) as src_file, open(file_http_path, &#39;wb&#39;) as dest_file:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#         dest_file.write(src_file.read())</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#         print(f&#34;Copying from {file_path} to {file_http_path}&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># 生成动态 HTML</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&#34;Content-type&#34;</span><span class="p">,</span> <span class="s2">&#34;text/html&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">html_content</span> <span class="o">=</span> <span class="n">generate_html</span><span class="p">(</span><span class="n">file_http_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 处理 favicon.ico 文件</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.ico&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 这里手动指定 .ico 文件的路径</span>
</span></span><span class="line"><span class="cl">            <span class="n">ico_file_path</span> <span class="o">=</span> <span class="n">resource_path</span><span class="p">(</span><span class="s2">&#34;assets/favicon.ico&#34;</span><span class="p">)</span>  <span class="c1"># 假设 ico 文件在 assets 文件夹下</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Serving icon file: </span><span class="si">{</span><span class="n">ico_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ico_file_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&#34;Content-type&#34;</span><span class="p">,</span> <span class="s2">&#34;image/x-icon&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ico_file_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ico_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ico_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;File not found: </span><span class="si">{</span><span class="n">ico_file_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 其他未单独考虑的静态文件处理</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Serving static file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">do_GET</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">end_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 添加 HTTP 头部，确保跨域策略</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.js&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&#34;Content-type&#34;</span><span class="p">,</span> <span class="s2">&#34;application/javascript&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&#34;Cross-Origin-Opener-Policy&#34;</span><span class="p">,</span> <span class="s2">&#34;same-origin&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&#34;Cross-Origin-Embedder-Policy&#34;</span><span class="p">,</span> <span class="s2">&#34;require-corp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 命令行参数解析</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Start a simple HTTP server with dynamic file handling.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;--file&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;The file path to be used&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 传递的文件路径</span>
</span></span><span class="line"><span class="cl"><span class="n">default_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start_server</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">((</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">CustomHandler</span><span class="p">)</span> <span class="k">as</span> <span class="n">httpd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">assigned_port</span> <span class="o">=</span> <span class="n">httpd</span><span class="o">.</span><span class="n">server_address</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Serving at port </span><span class="si">{</span><span class="n">assigned_port</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">html_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">default_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">dynamic_html_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;http://localhost:</span><span class="si">{</span><span class="n">assigned_port</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">html_name</span><span class="si">}</span><span class="s2">.html&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dynamic_html_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Shutting down server...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">httpd</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_server</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">log_blackhole</span> <span class="o">=</span> <span class="s1">&#39;nul&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span> <span class="k">else</span> <span class="s1">&#39;/dev/null&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_blackhole</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_blackhole</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://ahaknow.com/posts/diary/2024-10-09/">
    <span class="title">« 上一页</span>
    <br>
    <span>慢慢来，比较快！</span>
  </a>
  <a class="next" href="https://ahaknow.com/posts/know/macos-do-not-upgrade/">
    <span class="title">下一页 »</span>
    <br>
    <span>Mac：闲得没事不要升级系统</span>
  </a>
</nav>

  </footer>
</article>
</main>

<footer class="footer">
    <span>&copy; 2024 <a href="https://ahaknow.com/">AhaKnow</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/IHKYoung/CKPaper/" rel="noopener" target="_blank">CKPaper</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '🖨️打印';

        function copyingDone() {
            copybutton.innerHTML = '📋备份';
            setTimeout(() => {
                copybutton.innerHTML = '🖨️打印';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                
                
                let copyText = codeblock.textContent + '\r\n————————————————\r\n' + '版权声明：本文为「'+"AhaKnow"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' + '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(copyText);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('pre > code[class*="language-"]').forEach(function(codeblock) {
            
            
            let language = codeblock.className.match(/language-(\w+)/)[1] || "code";

            
            let macCodeBlock = document.createElement("div");
            let macButtons = document.createElement("div");
            let buttons = ['close', 'minimize', 'maximize'].map(function(className) {
                let button = document.createElement("div");
                button.setAttribute('class', `mac-button ${className}`);
                return button;
            });
            let languageType = document.createElement("div");
            languageType.innerText = language;
            languageType.setAttribute('class', 'language-type');

            
            macButtons.setAttribute('class', 'mac-buttons');
            buttons.forEach(function(button) {
                macButtons.appendChild(button);
            });
            macCodeBlock.appendChild(macButtons);
            macCodeBlock.appendChild(languageType);
            macCodeBlock.setAttribute('class', 'mac-code-block');

            
            codeblock.parentNode.insertBefore(macCodeBlock, codeblock);
        });
    });
</script>


</body>

</html>
